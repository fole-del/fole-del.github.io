<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Zinx | 欧恩意</title><meta name="author" content="mingming.shi"><meta name="copyright" content="mingming.shi"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="并发服务器的实现"><link rel="shortcut icon" href="/../../../images/icon.jpg"><link rel="canonical" href="https://fole-del.github.io/posts/67527f52"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式🌙🌙","night_to_day":"你已切换为浅色模式🌝🌝","bgLight":"#49b1f5","bgDark":"#121212","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Zinx',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-12-27 11:12:54'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/hbe.style.css"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="/css/var.css"><link rel="stylesheet" href="/css/background.css"><link rel="stylesheet" href="/css/taglink.css"><link rel="stylesheet" href="/css/hideCategory.css"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/code.css"><link rel="stylesheet" href="/css/buttons.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/font-awesome.css"><link rel="stylesheet" href="/css/title.css"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.2/css/all.css"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.2/css/v4-shims.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sviptzk/StaticFile_HEXO@latest/butterfly/css/font-awesome-animation.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/l-lin/font-awesome-animation/dist/font-awesome-animation.min.css"  media="defer" onload="this.media='all'"><link href="https://.googleapis.com/css2?family=Noto+Serif+SC:wght@400;900&display=swap" rel="stylesheet" media="print" onload="this.media='all'"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.1"><link rel="alternate" href="/atom.xml" title="欧恩意" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/../../../images/icon.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">200</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">107</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">65</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/ming/"><i class="fa-fw fa-fw fas fa-desktop faa-vertical animated-hover"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa-fw fas fa-home faa-vertical animated-hover"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-book faa-pulse animated-hover"></i><span> 找文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-archive faa-tada animated-hover"></i><span> 时间</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags faa-tada animated-hover"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-folder-open faa-tada animated-hover"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat faa-pulse animated-hover"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fa fa-picture-o"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-flask faa-vertical animated-hover"></i><span> 皮一下</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/test/demo"><i class="fa-fw fa fa-thermometer-empty faa-vertical animated-hover"></i><span> 测试</span></a></li><li><a class="site-page child" href="/player/"><i class="fa-fw fa fa-play-circle"></i><span> 播放器</span></a></li><li><a class="site-page child" href="/happy-new-year/"><i class="fa-fw fa fa-wheelchair-alt"></i><span> HappyNewYear</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart faa-vertical animated-hover"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-link faa-tada animated-hover"></i><span> 留言板</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://tvax3.sinaimg.cn/large/0072YHp3ly1gjvw20n7otj31hc0zdgxz.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">欧恩意</a></span><div id="menus"><button id="darkmodebutton" type="button" title="浅色和深色模式转换"><a class="site-page social-icon search"><i class="fas fa-adjust fa-fw"></i></a></button><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/ming/"><i class="fa-fw fa-fw fas fa-desktop faa-vertical animated-hover"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa-fw fas fa-home faa-vertical animated-hover"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-book faa-pulse animated-hover"></i><span> 找文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-archive faa-tada animated-hover"></i><span> 时间</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags faa-tada animated-hover"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-folder-open faa-tada animated-hover"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat faa-pulse animated-hover"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fa fa-picture-o"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-flask faa-vertical animated-hover"></i><span> 皮一下</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/test/demo"><i class="fa-fw fa fa-thermometer-empty faa-vertical animated-hover"></i><span> 测试</span></a></li><li><a class="site-page child" href="/player/"><i class="fa-fw fa fa-play-circle"></i><span> 播放器</span></a></li><li><a class="site-page child" href="/happy-new-year/"><i class="fa-fw fa fa-wheelchair-alt"></i><span> HappyNewYear</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart faa-vertical animated-hover"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-link faa-tada animated-hover"></i><span> 留言板</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Zinx</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-12-27T03:12:54.020Z" title="发表于 2022-12-27 11:12:54">2022-12-27</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-12-27T03:12:54.021Z" title="更新于 2022-12-27 11:12:54">2022-12-27</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">学习笔记</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/Go/">Go</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">13.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>56分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Zinx"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>[Toc]</p>
<blockquote>
<p>go环境变量设置  <code>export GOPATH=/home/project</code> </p>
</blockquote>
<h1 id="Zinx架构设计"><a href="#Zinx架构设计" class="headerlink" title="Zinx架构设计"></a>Zinx架构设计</h1><h2 id="客户端请求服务器响应的过程"><a href="#客户端请求服务器响应的过程" class="headerlink" title="客户端请求服务器响应的过程"></a>客户端请求服务器响应的过程</h2><ol>
<li>要有一个客户端对服务器发起请求。</li>
<li>我们的服务器应该去启动对客户端的处理模块并打开工作池来提升并发量。</li>
<li>处理客户端的模块开启两个模块，一个负责读客户端请求，一个负责写客户端请求。</li>
<li>用于读的功能模块，去任务的消息队列里去请求读数据。用于写的功能模块，通过 API 接口，当然我们的 API 不可能只有一个，所以这里肯定是 APIS。</li>
</ol>
<p>其过程如下所示：</p>
<p><img src="../../../images/Zinx/88b6a670622c32bca3fb8749ee4af60a-0.png" alt="img"></p>
<h2 id="Zinx功能模块"><a href="#Zinx功能模块" class="headerlink" title="Zinx功能模块"></a>Zinx功能模块</h2><p><img src="../../../images/Zinx/b342d16a0981046dfc21fe1be21efccb-0.png" alt="img"></p>
<h1 id="v0-1"><a href="#v0-1" class="headerlink" title="v0.1"></a>v0.1</h1><p>Zinx目录结构如下所示：</p>
<p><img src="../../../images/Zinx/cef9bddfb7b6496b4fc8346cf63e7d76-0.png" alt="img"></p>
<h2 id="iserver-go"><a href="#iserver-go" class="headerlink" title="iserver.go"></a>iserver.go</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> ziface<br><br><span class="hljs-comment">// 定义服务器接口</span><br><span class="hljs-keyword">type</span> IServer <span class="hljs-keyword">interface</span> &#123;<br>	<span class="hljs-comment">// 启动服务器</span><br>	Start()<br>	<span class="hljs-comment">// 停止服务器</span><br>	Stop()<br>	<span class="hljs-comment">// 开启业务服务方法</span><br>	Server()<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="server-go"><a href="#server-go" class="headerlink" title="server.go *"></a>server.go <code>*</code></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><code class="hljs go"><br><span class="hljs-keyword">package</span> znet<br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;fmt&quot;</span><br>    <span class="hljs-string">&quot;net&quot;</span><br>    <span class="hljs-string">&quot;zinx/ziface&quot;</span><br>)<br><br><span class="hljs-comment">// IServer 接口实现，定义一个Server服务类</span><br><span class="hljs-keyword">type</span> Server <span class="hljs-keyword">struct</span> &#123;<br>	 <span class="hljs-comment">//服务器的名称</span><br>    Name <span class="hljs-type">string</span><br>    <span class="hljs-comment">//tcp4 or other</span><br>    IPVersion <span class="hljs-type">string</span><br>    <span class="hljs-comment">//服务绑定的IP地址</span><br>    IP <span class="hljs-type">string</span><br>    <span class="hljs-comment">//服务绑定的端口</span><br>    Port <span class="hljs-type">int</span><br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">	创建一个服务器句柄</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewServer</span> <span class="hljs-params">(name <span class="hljs-type">string</span>)</span></span> ziface.IServer  &#123;<br>	s := &amp;Server &#123;<br>		Name: name,<br>		IPVersion:<span class="hljs-string">&quot;tcp4&quot;</span>,<br>		IP:<span class="hljs-string">&quot;0.0.0.0&quot;</span>,<br>		Port:<span class="hljs-number">7777</span>,<br>	&#125;<br>	<span class="hljs-keyword">return</span> s<br>&#125;<br><br><span class="hljs-comment">// 开启网络服务</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Server)</span></span> Start() &#123;<br>	fmt.Printf(<span class="hljs-string">&quot;[START] Server listenner at IP: %s, Port %d, is starting\n&quot;</span>, s.IP, s.Port)<br><br>	<span class="hljs-comment">// 开启一个go去做服务端Linster业务</span><br>	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>		<span class="hljs-comment">// 1. 获取一个tcp的Addr</span><br>		addr, err := net.ResolveTCPAddr(s.IPVersion, fmt.Sprintf(<span class="hljs-string">&quot;%s,%d&quot;</span>, s.IP, s. Port))<br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			fmt.Println(<span class="hljs-string">&quot;resolve tcp addr err: &quot;</span>, err)<br>		&#125;<br><br>		<span class="hljs-comment">// 2. 监听服务器地址</span><br>		listenner, err := net.ListenTCP(s.IPVersion, addr)<br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			fmt.Println(<span class="hljs-string">&quot;listen&quot;</span>, s.IPVersion, <span class="hljs-string">&quot;err&quot;</span>, err)<br>			<span class="hljs-keyword">return</span><br>		&#125;<br><br>		<span class="hljs-comment">// 已经监听成功</span><br>		fmt.Println(<span class="hljs-string">&quot;Start zinx Server &quot;</span>, s.Name, <span class="hljs-string">&quot; succ, now listenning……&quot;</span>)<br><br>		<span class="hljs-comment">// 3 启动server网络连接业务</span><br>		<span class="hljs-keyword">for</span> &#123;<br>			<span class="hljs-comment">// 3.1 阻塞等待客户端建立连接请求</span><br>			conn, err := listenner.AcceptTCP()<br>			<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>				fmt.Println(<span class="hljs-string">&quot;Accept err &quot;</span>, err)<br>				<span class="hljs-keyword">continue</span><br>			&#125;<br><br>			<span class="hljs-comment">// 3.2 TODO Server.Start() 设置服务器最大连接控制，如果超过最大连接，那么关闭此新的连接</span><br>			<span class="hljs-comment">// 3.3 TODO Server.Start() 处理该新连接请求的 *业务* 方法，此时应该有handler和conn是绑定的</span><br>			<span class="hljs-comment">// 我们这里暂时做一个最大512字节的回显服务</span><br>			<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>				<span class="hljs-comment">// 不断地循环从客户端获取数据</span><br>				<span class="hljs-keyword">for</span> &#123;<br>					buf := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, <span class="hljs-number">512</span>)<br>					cnt, err := conn.Read(buf)<br>					<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>						fmt.Println(<span class="hljs-string">&quot;recv bug err &quot;</span>, err)<br>						<span class="hljs-keyword">continue</span><br>					&#125;<br>					<br>					<span class="hljs-comment">// 回显</span><br>					<span class="hljs-keyword">if</span> _, err := conn.Write(buf[:cnt]); err != <span class="hljs-literal">nil</span> &#123;<br>						fmt.Println(<span class="hljs-string">&quot;write back buf err&quot;</span>, err)<br>						<span class="hljs-keyword">continue</span><br>					&#125;<br>				&#125;<br>			&#125;()<br>		&#125;<br>	&#125;()<br>&#125;<br><br><span class="hljs-comment">// 停止</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Server)</span></span> Stop() &#123;<br>	fmt.Println(<span class="hljs-string">&quot;[STOP] Zinx server, name&quot;</span>, s.Name)<br>&#125;<br><br><span class="hljs-comment">// 开启业务</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Server)</span></span> Server()  &#123;<br>	<br>&#125;<br>  <br></code></pre></td></tr></table></figure>
<h2 id="server-test-go"><a href="#server-test-go" class="headerlink" title="server_test.go"></a>server_test.go</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> znet<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;net&quot;</span><br>	<span class="hljs-string">&quot;testing&quot;</span><br>	<span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">	模拟客户端</span><br><span class="hljs-comment">*/</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ClientTest</span><span class="hljs-params">()</span></span>  &#123;<br>	fmt.Println(<span class="hljs-string">&quot;Client Test ... start&quot;</span>)<br>	<span class="hljs-comment">// 3秒之后发起测试请求，给服务端开启服务的机会</span><br>	time.Sleep(<span class="hljs-number">3</span> * time.Second)<br>	conn,err := net.Dial(<span class="hljs-string">&quot;tcp&quot;</span>, <span class="hljs-string">&quot;127.0.0.1:7777&quot;</span>)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		fmt.Println(<span class="hljs-string">&quot;client start err, exit!&quot;</span>)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br><br>	<span class="hljs-keyword">for</span> &#123;<br>		_, err = conn.Write([]<span class="hljs-type">byte</span>(<span class="hljs-string">&quot;Hello ZINX&quot;</span>))<br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			fmt.Println(<span class="hljs-string">&quot;Write error err &quot;</span>, err)<br>			<span class="hljs-keyword">return</span><br>		&#125;<br><br>		buf := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, <span class="hljs-number">512</span>)<br>		cnt, err := conn.Read(buf)<br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			fmt.Println(<span class="hljs-string">&quot;read  buf err&quot;</span>, err)<br>			<span class="hljs-keyword">return</span><br>		&#125;<br>		fmt.Printf(<span class="hljs-string">&quot; server call back: %s, cnt = %d\n&quot;</span>, buf, cnt)<br>		time.Sleep(<span class="hljs-number">1</span> * time.Second)<br>	&#125;<br>&#125;<br><br><span class="hljs-comment">// Server 模块的测试函数</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestServer</span><span class="hljs-params">(t *testing.T)</span></span>  &#123;<br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	服务端测试</span><br><span class="hljs-comment">	*/</span><br><br>	<span class="hljs-comment">// 1 创建一个server句柄 s</span><br>	s := NewServer(<span class="hljs-string">&quot;[zinx V0.1]&quot;</span>)<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">		客户端测试</span><br><span class="hljs-comment">	*/</span><br>	<span class="hljs-keyword">go</span> ClientTest()<br><br>	<span class="hljs-comment">// 2 开启服务</span><br>	s.Server()<br> <br>&#125;<br></code></pre></td></tr></table></figure>
<h1 id="v0-2-实现链接封装业务与业务绑定"><a href="#v0-2-实现链接封装业务与业务绑定" class="headerlink" title="[v0.2] 实现链接封装业务与业务绑定"></a>[v0.2] 实现链接封装业务与业务绑定</h1><p>功能如思维导图所示：</p>
<p><img src="../../../images/Zinx/image-20220201232354654.png" alt="image-20220201232354654"></p>
<h2 id="文件结构"><a href="#文件结构" class="headerlink" title="文件结构"></a>文件结构</h2><p><img src="../../../images/Zinx/image-20220202175949470.png" alt="image-20220202175949470"></p>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><h3 id="iconnection-go"><a href="#iconnection-go" class="headerlink" title="iconnection.go"></a>iconnection.go</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> ziface<br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;net&quot;</span><br><br><span class="hljs-comment">// 定义连接接口</span><br><span class="hljs-keyword">type</span> IConnection <span class="hljs-keyword">interface</span> &#123;<br>	<span class="hljs-comment">// 启动连接，让电气概念连接开始工作</span><br>	Start()<br>	<span class="hljs-comment">// 停止连接，结束当前链接状态</span><br>	Stop()<br>	<span class="hljs-comment">// 从当前链接获取原始的socket TCPConn</span><br>	GetTCPConnection() *net.TCPConn<br>	<span class="hljs-comment">// 获取当前链接ID</span><br>	GetConnID() <span class="hljs-type">uint32</span><br>	<span class="hljs-comment">// 获取远程客户端地址信息</span><br>	RemoteAddr() net.Addr<br>&#125;<br><br><span class="hljs-comment">// 定义一个统一处理链接业务的接口</span><br><span class="hljs-keyword">type</span> HandFunc <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(*net.TCPConn, []<span class="hljs-type">byte</span>, <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">error</span> <br></code></pre></td></tr></table></figure>
<h3 id="connection-go"><a href="#connection-go" class="headerlink" title="connection.go"></a>connection.go</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> znet<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;net&quot;</span><br>	<span class="hljs-string">&quot;zinx/ziface&quot;</span><br>)<br><br><span class="hljs-keyword">type</span> Connection <span class="hljs-keyword">struct</span> &#123;<br>	<span class="hljs-comment">// 当前链接的socket TCP套接字</span><br>	Conn *net.TCPConn<br>	<span class="hljs-comment">// 当前连接的ID 也可以称作为SessionID， ID全局唯一</span><br>	ConnID <span class="hljs-type">uint32</span><br>	<span class="hljs-comment">// 当前连接的关闭状态</span><br>	isClosed <span class="hljs-type">bool</span><br>	<span class="hljs-comment">// 该链接的处理方法api</span><br>	handleAPI ziface.HandFunc<br>	<span class="hljs-comment">// 告知该链接已经退出/停止的channel</span><br>	ExitBufferChan <span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span><br>&#125;<br><br><span class="hljs-comment">// 创建连接的方法</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewConntion</span><span class="hljs-params">(conn *net.TCPConn, connID <span class="hljs-type">uint32</span>, callBack_api ziface.HandFunc)</span></span> *Connection &#123;<br>	c := &amp;Connection&#123;<br>		Conn: conn,<br>		ConnID: connID,<br>		isClosed: <span class="hljs-literal">false</span>,<br>		handleAPI: callBack_api,<br>		ExitBufferChan: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span>, <span class="hljs-number">1</span>),<br>	&#125;<br>	<span class="hljs-keyword">return</span> c<br>&#125;<br><br><span class="hljs-comment">/* 处理conn读数据的Goroutine */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Connection)</span></span> StartReader()  &#123;<br>	fmt.Println(<span class="hljs-string">&quot;Reader Goroutine is running&quot;</span>)<br>	<span class="hljs-keyword">defer</span> fmt.Println(c.Conn.RemoteAddr().String(), <span class="hljs-string">&quot;conn reader exit&quot;</span>)<br>	<span class="hljs-keyword">defer</span> c.Stop()<br><br>	<span class="hljs-keyword">for</span> &#123;<br>		<span class="hljs-comment">// 读取我们最大的数据到buf中</span><br>		buf := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>,<span class="hljs-number">512</span>)<br>		cnt, err := c.Conn.Read(buf)<br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			fmt.Println(<span class="hljs-string">&quot;recv bug err &quot;</span>, err)<br>			c.ExitBufferChan &lt;- <span class="hljs-literal">true</span><br>			<span class="hljs-keyword">continue</span><br>		&#125;<br><br>		<span class="hljs-comment">// 调用当前链接业务（这里执行的是当前conn的绑定的handle方法）</span><br>		<span class="hljs-keyword">if</span> err := c.handleAPI(c.Conn, buf, cnt); err != <span class="hljs-literal">nil</span> &#123;<br>			fmt.Println(<span class="hljs-string">&quot;connID &quot;</span>, c.ConnID, <span class="hljs-string">&quot; handle is error&quot;</span>)<br>			c.ExitBufferChan &lt;- <span class="hljs-literal">true</span><br>			<span class="hljs-keyword">return</span><br>		&#125;<br>	&#125;<br>&#125;<br><br><span class="hljs-comment">// 启动链接，让当前连接开始工作</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Connection)</span></span> Start()  &#123;<br>	<span class="hljs-comment">// 开启处理该链接读取客户端数据之后的请求业务</span><br>	<span class="hljs-keyword">go</span> c.StartReader()<br>	<span class="hljs-keyword">for</span> &#123;<br>		<span class="hljs-keyword">select</span> &#123;<br>		<span class="hljs-keyword">case</span> &lt;- c.ExitBufferChan:<br>			<span class="hljs-comment">// 得到退出消息，不再阻塞</span><br>			<span class="hljs-keyword">return</span><br>		&#125;<br>	&#125;<br>&#125;<br><br><span class="hljs-comment">// 停止连接，结束当前连接状态M</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Connection)</span></span> Stop()  &#123;<br>	<span class="hljs-comment">// 1. 如果当前链接已经关闭</span><br>	<span class="hljs-keyword">if</span> c.isClosed == <span class="hljs-literal">true</span> &#123;<br>		<span class="hljs-keyword">return</span><br>	&#125;<br><br>	c.isClosed = <span class="hljs-literal">true</span><br><br>	<span class="hljs-comment">// TODO Connection Stop() 如果用户注册了该链接的关闭毁掉业务，那么在此刻应该显示调用</span><br>	<span class="hljs-comment">// 关闭socket链接</span><br>	c.Conn.Close()<br>	<span class="hljs-comment">// 通知从缓冲队列读取数据的业务，该链接已经关闭</span><br>	c.ExitBufferChan &lt;- <span class="hljs-literal">true</span><br>	<span class="hljs-comment">// 关闭该链接全部管道</span><br>	<span class="hljs-built_in">close</span>(c.ExitBufferChan)<br>&#125;<br><br><span class="hljs-comment">// 从当前连接获取原始的socket TCPConn</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Connection)</span></span> GetTCPConnection() *net.TCPConn &#123;<br>	<span class="hljs-keyword">return</span> c.Conn<br>&#125;<br><span class="hljs-comment">// 获取当前ID</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Connection)</span></span> GetConnID() <span class="hljs-type">uint32</span> &#123;<br>	<span class="hljs-keyword">return</span> c.ConnID<br>&#125;<br><span class="hljs-comment">// 获取远程客户端地址信息</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Connection)</span></span> RemoteAddr() net.Addr &#123;<br>	<span class="hljs-keyword">return</span> c.Conn.RemoteAddr()	<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="server-go-代码修改"><a href="#server-go-代码修改" class="headerlink" title="server.go 代码修改"></a>server.go 代码修改</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// TODO server.go 应该有一个自动生成ID的方法</span><br>+		<span class="hljs-keyword">var</span> cid <span class="hljs-type">uint32</span> = <span class="hljs-number">0</span><br>		<span class="hljs-comment">// 3 启动server网络连接业务</span><br>		<span class="hljs-keyword">for</span> &#123;<br>			<span class="hljs-comment">// 3.1 阻塞等待客户端建立连接请求</span><br>			conn, err := listenner.AcceptTCP()<br>			<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>				fmt.Println(<span class="hljs-string">&quot;Accept err &quot;</span>, err)<br>				<span class="hljs-keyword">continue</span><br>			&#125;<br><br>			<span class="hljs-comment">// 3.2 TODO Server.Start() 设置服务器最大连接控制，如果超过最大连接，那么关闭此新的连接</span><br>			<span class="hljs-comment">// 3.3 TODO Server.Start() 处理该新连接请求的 *业务* 方法，此时应该有handler和conn是绑定的</span><br>+			dealConn := NewConntion(conn, cid, CallBackToClient)<br>+           cid ++<br>			<br>			<span class="hljs-comment">//3.4 启动当前链接的处理业务</span><br>            <span class="hljs-keyword">go</span> dealConn.Start()<br>		&#125;<br>	&#125;()<br></code></pre></td></tr></table></figure>
<h1 id="v0-3-实现基础路由模块"><a href="#v0-3-实现基础路由模块" class="headerlink" title="[v0.3] 实现基础路由模块"></a>[v0.3] 实现基础路由模块</h1><blockquote>
<p>通俗讲就是实现一个类，系统地去回调一些用户的操作</p>
</blockquote>
<h2 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h2><p><img src="../../../images/Zinx/1ef8c2201f35797a7678e54c3e9af24b-0.png" alt="img"></p>
<blockquote>
<p><strong>涉及知识点：</strong></p>
<ol>
<li>路由功能模块</li>
</ol>
</blockquote>
<h2 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h2><p><img src="../../../images/Zinx/image-20220203160347674.png" alt="image-20220203160347674"></p>
<h2 id="IRequest消息请求抽象类"><a href="#IRequest消息请求抽象类" class="headerlink" title="IRequest消息请求抽象类"></a>IRequest消息请求抽象类</h2><blockquote>
<p>把客户端请求的连接信息和请求的数据，放在一个叫 Request 的请求类里，这样的好处是我们可以从 Request 里得到全部客户端的请求信息，也为我们之后拓展框架有一定的作用，一旦客户端有额外的含义的数据信息，都可以放在这个 Request 里。可以理解为每次客户端的全部请求数据，Zinx 都会把它们一起放到一个 Request 结构体里。</p>
</blockquote>
<ol>
<li>创建抽象<code>IRequest</code>层</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> ziface<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">    IRequest 接口：</span><br><span class="hljs-comment">    实际上是把客户端请求的链接信息 和 请求的数据 包装到了 Request里</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">type</span> IRequest <span class="hljs-keyword">interface</span>&#123;<br>    GetConnection() IConnection    <span class="hljs-comment">//获取请求连接信息</span><br>    GetData() []<span class="hljs-type">byte</span>            <span class="hljs-comment">//获取请求消息的数据</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>当前的抽象层只提供了两个 Getter 方法，所以有个成员应该是必须的，一个是客户端连接，一个是客户端传递进来的数据，当然随着 Zinx 框架的功能丰富，这里面还应该继续添加新的成员。</p>
<ol>
<li>实现<code>Requeset</code>类</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> znet<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;zinx/ziface&quot;</span><br><br><span class="hljs-keyword">type</span> Request <span class="hljs-keyword">struct</span> &#123;<br>    conn ziface.IConnection <span class="hljs-comment">//已经和客户端建立好的 链接</span><br>    data []<span class="hljs-type">byte</span> <span class="hljs-comment">//客户端请求的数据</span><br>&#125;<br><span class="hljs-comment">//获取请求连接信息</span><br><span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(r *Request)</span></span> GetConnection() ziface.IConnection &#123;<br>    <span class="hljs-keyword">return</span> r.conn<br>&#125;<br><span class="hljs-comment">//获取请求消息的数据</span><br><span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(r *Request)</span></span> GetData() []<span class="hljs-type">byte</span> &#123;<br>    <span class="hljs-keyword">return</span> r.data<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="IRouter路由配置抽象类"><a href="#IRouter路由配置抽象类" class="headerlink" title="IRouter路由配置抽象类*"></a>IRouter路由配置抽象类<code>*</code></h2><blockquote>
<p>实现一个非常简单基础的路由功能，目的当然就是为了快速的让 Zinx 步入到路由的阶段。</p>
</blockquote>
<ol>
<li>创建抽象的<code>IRouter</code>层</li>
</ol>
<p>我们知道 router 实际上的作用就是，服务端应用可以给 Zinx 框架配置当前链接的处理业务方法，之前的 Zinx-V0.2 我们的 Zinx 框架处理链接请求的方法是固定的，现在是可以自定义，并且有 3 种接口可以重写。</p>
<p>Handle：是处理当前链接的主业务函数</p>
<p>PreHandle：如果需要在主业务函数之前有前置业务，可以重写这个方法</p>
<p>PostHandle:如果需要在主业务函数之后又后置业务，可以重写这个方法</p>
<p>当然每个方法都有一个唯一的形参 IRequest 对象，也就是客户端请求过来的连接和请求数据，作为我们业务方法的输入数据。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> ziface<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">    路由接口， 这里面路由是 使用框架者给该链接自定的 处理业务方法</span><br><span class="hljs-comment">    路由里的IRequest 则包含用该链接的链接信息和该链接的请求数据信息</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">type</span> IRouter <span class="hljs-keyword">interface</span>&#123;<br>    PreHandle(request IRequest)  <span class="hljs-comment">//在处理conn业务之前的钩子方法</span><br>    Handle(request IRequest)     <span class="hljs-comment">//处理conn业务的方法</span><br>    PostHandle(request IRequest) <span class="hljs-comment">//处理conn业务之后的钩子方法</span><br>&#125;<br></code></pre></td></tr></table></figure>
<ol>
<li>实现<code>Router</code>类</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> znet<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;zinx/ziface&quot;</span><br><br><span class="hljs-comment">//实现router时，先嵌入这个基类，然后根据需要对这个基类的方法进行重写</span><br><span class="hljs-keyword">type</span> BaseRouter <span class="hljs-keyword">struct</span> &#123;&#125;<br><span class="hljs-comment">//这里之所以BaseRouter的方法都为空，</span><br><span class="hljs-comment">// 是因为有的Router不希望有PreHandle或PostHandle</span><br><span class="hljs-comment">// 所以Router全部继承BaseRouter的好处是，不需要实现PreHandle和PostHandle也可以实例化</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(br *BaseRouter)</span></span>PreHandle(req ziface.IRequest)&#123;&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(br *BaseRouter)</span></span>Handle(req ziface.IRequest)&#123;&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(br *BaseRouter)</span></span>PostHandle(req ziface.IRequest)&#123;&#125;<br></code></pre></td></tr></table></figure>
<h2 id="IServer增添路由添加功能"><a href="#IServer增添路由添加功能" class="headerlink" title="IServer增添路由添加功能"></a>IServer增添路由添加功能</h2><blockquote>
<p>这一步需要修改原有的链接结构体，同时对服务中的方法进行修改</p>
</blockquote>
<h3 id="server类"><a href="#server类" class="headerlink" title="server类"></a>server类</h3><ol>
<li><code>iserver.go</code></li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> ziface<br><span class="hljs-comment">//定义服务器接口</span><br><span class="hljs-keyword">type</span> IServer <span class="hljs-keyword">interface</span>&#123;<br>    <span class="hljs-comment">//启动服务器方法</span><br>    Start()<br>    <span class="hljs-comment">//停止服务器方法</span><br>    Stop()<br>    <span class="hljs-comment">//开启业务服务方法</span><br>    Serve()<br>    <span class="hljs-comment">//路由功能：给当前服务注册一个路由业务方法，供客户端链接处理使用</span><br>    AddRouter(router IRouter)<br>&#125;<br></code></pre></td></tr></table></figure>
<ol>
<li><code>server.go</code></li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">//iServer 接口实现，定义一个Server服务类</span><br><span class="hljs-keyword">type</span> Server <span class="hljs-keyword">struct</span> &#123;<br>    <span class="hljs-comment">//服务器的名称</span><br>    Name <span class="hljs-type">string</span><br>    <span class="hljs-comment">//tcp4 or other</span><br>    IPVersion <span class="hljs-type">string</span><br>    <span class="hljs-comment">//服务绑定的IP地址</span><br>    IP <span class="hljs-type">string</span><br>    <span class="hljs-comment">//服务绑定的端口</span><br>    Port <span class="hljs-type">int</span><br>    <span class="hljs-comment">//当前Server由用户绑定的回调router,也就是Server注册的链接对应的处理业务</span><br>    Router ziface.IRouter<br>&#125;<br></code></pre></td></tr></table></figure>
<ol>
<li><code>NewServer()</code>方法中的成员初始化</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/*</span><br><span class="hljs-comment">  创建一个服务器句柄</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewServer</span> <span class="hljs-params">(name <span class="hljs-type">string</span>)</span></span> ziface.IServer &#123;<br>    s:= &amp;Server &#123;<br>        Name :name,<br>        IPVersion:<span class="hljs-string">&quot;tcp4&quot;</span>,<br>        IP:<span class="hljs-string">&quot;0.0.0.0&quot;</span>,<br>        Port:<span class="hljs-number">7777</span>,<br>        Router: <span class="hljs-literal">nil</span>,<br>    &#125;<br>    <span class="hljs-keyword">return</span> s<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="Connection类"><a href="#Connection类" class="headerlink" title="Connection类"></a>Connection类</h3><ol>
<li><code>connection.go</code></li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Connection <span class="hljs-keyword">struct</span> &#123;<br>    <span class="hljs-comment">//当前连接的socket TCP套接字</span><br>    Conn *net.TCPConn<br>    <span class="hljs-comment">//当前连接的ID 也可以称作为SessionID，ID全局唯一</span><br>    ConnID <span class="hljs-type">uint32</span><br>    <span class="hljs-comment">//当前连接的关闭状态</span><br>    isClosed <span class="hljs-type">bool</span><br>    <span class="hljs-comment">//该连接的处理方法router</span><br>    Router  ziface.IRouter<br>    <span class="hljs-comment">//告知该链接已经退出/停止的channel</span><br>    ExitBuffChan <span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span><br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Connection)</span></span> StartReader() &#123;<br>    fmt.Println(<span class="hljs-string">&quot;Reader Goroutine is  running&quot;</span>)<br>    <span class="hljs-keyword">defer</span> fmt.Println(c.RemoteAddr().String(), <span class="hljs-string">&quot; conn reader exit!&quot;</span>)<br>    <span class="hljs-keyword">defer</span> c.Stop()<br>    <span class="hljs-keyword">for</span>  &#123;<br>        <span class="hljs-comment">//读取我们最大的数据到buf中</span><br>        buf := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, <span class="hljs-number">512</span>)<br>        _, err := c.Conn.Read(buf)<br>        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>            fmt.Println(<span class="hljs-string">&quot;recv buf err &quot;</span>, err)<br>            c.ExitBuffChan &lt;- <span class="hljs-literal">true</span><br>            <span class="hljs-keyword">continue</span><br>        &#125;<br>        <span class="hljs-comment">//得到当前客户端请求的Request数据</span><br>        req := Request&#123;<br>            conn:c,<br>            data:buf,<br>        &#125;<br>        <span class="hljs-comment">//从路由Routers 中找到注册绑定Conn的对应Handle</span><br>        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(request ziface.IRequest)</span></span> &#123;<br>            <span class="hljs-comment">//执行注册的路由方法</span><br>            c.Router.PreHandle(request)<br>            c.Router.Handle(request)<br>            c.Router.PostHandle(request)<br>        &#125;(&amp;req)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="AddRouter"><a href="#AddRouter" class="headerlink" title="AddRouter"></a>AddRouter</h3><p>在<code>server</code>类要实现添加路由的方法<code>AddRouter</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> znet<br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;fmt&quot;</span><br>    <span class="hljs-string">&quot;net&quot;</span><br>    <span class="hljs-string">&quot;time&quot;</span><br>    <span class="hljs-string">&quot;zinx/ziface&quot;</span><br>)<br><span class="hljs-comment">//iServer 接口实现，定义一个Server服务类</span><br><span class="hljs-keyword">type</span> Server <span class="hljs-keyword">struct</span> &#123;<br>    <span class="hljs-comment">//服务器的名称</span><br>    Name <span class="hljs-type">string</span><br>    <span class="hljs-comment">//tcp4 or other</span><br>    IPVersion <span class="hljs-type">string</span><br>    <span class="hljs-comment">//服务绑定的IP地址</span><br>    IP <span class="hljs-type">string</span><br>    <span class="hljs-comment">//服务绑定的端口</span><br>    Port <span class="hljs-type">int</span><br>    <span class="hljs-comment">//当前Server由用户绑定的回调router,也就是Server注册的链接对应的处理业务</span><br>    Router ziface.IRouter<br>&#125;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">  创建一个服务器句柄</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewServer</span> <span class="hljs-params">(name <span class="hljs-type">string</span>)</span></span> ziface.IServer &#123;<br>    s:= &amp;Server &#123;<br>        Name :name,<br>        IPVersion:<span class="hljs-string">&quot;tcp4&quot;</span>,<br>        IP:<span class="hljs-string">&quot;0.0.0.0&quot;</span>,<br>        Port:<span class="hljs-number">7777</span>,<br>        Router: <span class="hljs-literal">nil</span>,<br>    &#125;<br>    <span class="hljs-keyword">return</span> s<br>&#125;<br><span class="hljs-comment">//============== 实现 ziface.IServer 里的全部接口方法 ========</span><br><span class="hljs-comment">//开启网络服务</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Server)</span></span> Start() &#123;<br>    fmt.Printf(<span class="hljs-string">&quot;[START] Server listenner at IP: %s, Port %d, is starting\n&quot;</span>, s.IP, s.Port)<br>    <span class="hljs-comment">//开启一个go去做服务端Linster业务</span><br>    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>        <span class="hljs-comment">//1 获取一个TCP的Addr</span><br>        addr, err := net.ResolveTCPAddr(s.IPVersion, fmt.Sprintf(<span class="hljs-string">&quot;%s:%d&quot;</span>, s.IP, s.Port))<br>        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>            fmt.Println(<span class="hljs-string">&quot;resolve tcp addr err: &quot;</span>, err)<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        <span class="hljs-comment">//2 监听服务器地址</span><br>        listenner, err:= net.ListenTCP(s.IPVersion, addr)<br>        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>            fmt.Println(<span class="hljs-string">&quot;listen&quot;</span>, s.IPVersion, <span class="hljs-string">&quot;err&quot;</span>, err)<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        <span class="hljs-comment">//已经监听成功</span><br>        fmt.Println(<span class="hljs-string">&quot;start Zinx server  &quot;</span>, s.Name, <span class="hljs-string">&quot; succ, now listenning...&quot;</span>)<br>        <span class="hljs-comment">//TODO server.go 应该有一个自动生成ID的方法</span><br>        <span class="hljs-keyword">var</span> cid <span class="hljs-type">uint32</span><br>        cid = <span class="hljs-number">0</span><br>        <span class="hljs-comment">//3 启动server网络连接业务</span><br>        <span class="hljs-keyword">for</span> &#123;<br>            <span class="hljs-comment">//3.1 阻塞等待客户端建立连接请求</span><br>            conn, err := listenner.AcceptTCP()<br>            <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>                fmt.Println(<span class="hljs-string">&quot;Accept err &quot;</span>, err)<br>                <span class="hljs-keyword">continue</span><br>            &#125;<br>            <span class="hljs-comment">//3.2 TODO Server.Start() 设置服务器最大连接控制,如果超过最大连接，那么则关闭此新的连接</span><br>            <span class="hljs-comment">//3.3 处理该新连接请求的 业务 方法， 此时应该有 handler 和 conn是绑定的</span><br>            dealConn := NewConntion(conn, cid, s.Router)<br>            cid ++<br>            <span class="hljs-comment">//3.4 启动当前链接的处理业务</span><br>            <span class="hljs-keyword">go</span> dealConn.Start()<br>        &#125;<br>    &#125;()<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Server)</span></span> Stop() &#123;<br>    fmt.Println(<span class="hljs-string">&quot;[STOP] Zinx server , name &quot;</span> , s.Name)<br>    <span class="hljs-comment">//TODO  Server.Stop() 将其他需要清理的连接信息或者其他信息 也要一并停止或者清理</span><br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Server)</span></span> Serve() &#123;<br>    s.Start()<br>    <span class="hljs-comment">//TODO Server.Serve() 是否在启动服务的时候 还要处理其他的事情呢 可以在这里添加</span><br>    <span class="hljs-comment">//阻塞,否则主Go退出， listenner的go将会退出</span><br>    <span class="hljs-keyword">for</span> &#123;<br>        time.Sleep(<span class="hljs-number">10</span>*time.Second)<br>    &#125;<br>&#125;<br><span class="hljs-comment">//路由功能：给当前服务注册一个路由业务方法，供客户端链接处理使用</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Server)</span></span>AddRouter(router ziface.IRouter) &#123;<br>    s.Router = router<br>    fmt.Println(<span class="hljs-string">&quot;Add Router succ! &quot;</span> )<br>&#125;<br></code></pre></td></tr></table></figure>
<p>在<code>connnection</code>同样要加上相应的路由对应的方法</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> znet<br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;fmt&quot;</span><br>    <span class="hljs-string">&quot;net&quot;</span><br>    <span class="hljs-string">&quot;zinx/ziface&quot;</span><br>)<br><span class="hljs-keyword">type</span> Connection <span class="hljs-keyword">struct</span> &#123;<br>    <span class="hljs-comment">//当前连接的socket TCP套接字</span><br>    Conn *net.TCPConn<br>    <span class="hljs-comment">//当前连接的ID 也可以称作为SessionID，ID全局唯一</span><br>    ConnID <span class="hljs-type">uint32</span><br>    <span class="hljs-comment">//当前连接的关闭状态</span><br>    isClosed <span class="hljs-type">bool</span><br>    <span class="hljs-comment">//该连接的处理方法router</span><br>    Router  ziface.IRouter<br>    <span class="hljs-comment">//告知该链接已经退出/停止的channel</span><br>    ExitBuffChan <span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span><br>&#125;<br><span class="hljs-comment">//创建连接的方法</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewConntion</span><span class="hljs-params">(conn *net.TCPConn, connID <span class="hljs-type">uint32</span>, router ziface.IRouter)</span></span> *Connection&#123;<br>    c := &amp;Connection&#123;<br>        Conn:     conn,<br>        ConnID:   connID,<br>        isClosed: <span class="hljs-literal">false</span>,<br>        Router: router,<br>        ExitBuffChan: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span>, <span class="hljs-number">1</span>),<br>    &#125;<br>    <span class="hljs-keyword">return</span> c<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Connection)</span></span> StartReader() &#123;<br>    fmt.Println(<span class="hljs-string">&quot;Reader Goroutine is  running&quot;</span>)<br>    <span class="hljs-keyword">defer</span> fmt.Println(c.RemoteAddr().String(), <span class="hljs-string">&quot; conn reader exit!&quot;</span>)<br>    <span class="hljs-keyword">defer</span> c.Stop()<br>    <span class="hljs-keyword">for</span>  &#123;<br>        <span class="hljs-comment">//读取我们最大的数据到buf中</span><br>        buf := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, <span class="hljs-number">512</span>)<br>        _, err := c.Conn.Read(buf)<br>        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>            fmt.Println(<span class="hljs-string">&quot;recv buf err &quot;</span>, err)<br>            c.ExitBuffChan &lt;- <span class="hljs-literal">true</span><br>            <span class="hljs-keyword">continue</span><br>        &#125;<br>        <span class="hljs-comment">//得到当前客户端请求的Request数据</span><br>        req := Request&#123;<br>            conn:c,<br>            data:buf,<br>        &#125;<br>        <span class="hljs-comment">//从路由Routers 中找到注册绑定Conn的对应Handle</span><br>        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(request ziface.IRequest)</span></span> &#123;<br>            <span class="hljs-comment">//执行注册的路由方法</span><br>            c.Router.PreHandle(request)<br>            c.Router.Handle(request)<br>            c.Router.PostHandle(request)<br>        &#125;(&amp;req)<br>    &#125;<br>&#125;<br><span class="hljs-comment">//启动连接，让当前连接开始工作</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Connection)</span></span> Start() &#123;<br>    <span class="hljs-comment">//开启处理该链接读取到客户端数据之后的请求业务</span><br>    <span class="hljs-keyword">go</span> c.StartReader()<br>    <span class="hljs-keyword">for</span> &#123;<br>        <span class="hljs-keyword">select</span> &#123;<br>        <span class="hljs-keyword">case</span> &lt;- c.ExitBuffChan:<br>            <span class="hljs-comment">//得到退出消息，不再阻塞</span><br>            <span class="hljs-keyword">return</span><br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-comment">//停止连接，结束当前连接状态M</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Connection)</span></span> Stop() &#123;<br>    <span class="hljs-comment">//1. 如果当前链接已经关闭</span><br>    <span class="hljs-keyword">if</span> c.isClosed == <span class="hljs-literal">true</span> &#123;<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    c.isClosed = <span class="hljs-literal">true</span><br>    <span class="hljs-comment">//TODO Connection Stop() 如果用户注册了该链接的关闭回调业务，那么在此刻应该显示调用</span><br>    <span class="hljs-comment">// 关闭socket链接</span><br>    c.Conn.Close()<br>    <span class="hljs-comment">//通知从缓冲队列读数据的业务，该链接已经关闭</span><br>    c.ExitBuffChan &lt;- <span class="hljs-literal">true</span><br>    <span class="hljs-comment">//关闭该链接全部管道</span><br>    <span class="hljs-built_in">close</span>(c.ExitBuffChan)<br>&#125;<br><span class="hljs-comment">//从当前连接获取原始的socket TCPConn</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Connection)</span></span> GetTCPConnection() *net.TCPConn &#123;<br>    <span class="hljs-keyword">return</span> c.Conn<br>&#125;<br><span class="hljs-comment">//获取当前连接ID</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Connection)</span></span> GetConnID() <span class="hljs-type">uint32</span>&#123;<br>    <span class="hljs-keyword">return</span> c.ConnID<br>&#125;<br><span class="hljs-comment">//获取远程客户端地址信息</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Connection)</span></span> RemoteAddr() net.Addr &#123;<br>    <span class="hljs-keyword">return</span> c.Conn.RemoteAddr()<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><h3 id="Server-go"><a href="#Server-go" class="headerlink" title="Server.go"></a>Server.go</h3><blockquote>
<p>我们这里自定义了一个类似 Ping 操作的路由，就是当客户端发送数据，我们的处理业务就是返回给客户端”ping..ping..ping..”, 为了测试，当前路由也同时实现了 PreHandle 和 PostHandle 两个方法。实际上 Zinx 会利用模板的设计模式，依次在框架中调用<code>PreHandle</code>、<code>Handle</code>、<code>PostHandle</code>三个方法。</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;fmt&quot;</span><br>    <span class="hljs-string">&quot;zinx/ziface&quot;</span><br>    <span class="hljs-string">&quot;zinx/znet&quot;</span><br>)<br><span class="hljs-comment">//ping test 自定义路由</span><br><span class="hljs-keyword">type</span> PingRouter <span class="hljs-keyword">struct</span> &#123;<br>    znet.BaseRouter <span class="hljs-comment">//一定要先基础BaseRouter</span><br>&#125;<br><span class="hljs-comment">//Test PreHandle</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *PingRouter)</span></span> PreHandle(request ziface.IRequest) &#123;<br>    fmt.Println(<span class="hljs-string">&quot;Call Router PreHandle&quot;</span>)<br>    _, err := request.GetConnection().GetTCPConnection().Write([]<span class="hljs-type">byte</span>(<span class="hljs-string">&quot;before ping ....\n&quot;</span>))<br>    <span class="hljs-keyword">if</span> err !=<span class="hljs-literal">nil</span> &#123;<br>        fmt.Println(<span class="hljs-string">&quot;call back ping ping ping error&quot;</span>)<br>    &#125;<br>&#125;<br><span class="hljs-comment">//Test Handle</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *PingRouter)</span></span> Handle(request ziface.IRequest) &#123;<br>    fmt.Println(<span class="hljs-string">&quot;Call PingRouter Handle&quot;</span>)<br>    _, err := request.GetConnection().GetTCPConnection().Write([]<span class="hljs-type">byte</span>(<span class="hljs-string">&quot;ping...ping...ping\n&quot;</span>))<br>    <span class="hljs-keyword">if</span> err !=<span class="hljs-literal">nil</span> &#123;<br>        fmt.Println(<span class="hljs-string">&quot;call back ping ping ping error&quot;</span>)<br>    &#125;<br>&#125;<br><span class="hljs-comment">//Test PostHandle</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *PingRouter)</span></span> PostHandle(request ziface.IRequest) &#123;<br>    fmt.Println(<span class="hljs-string">&quot;Call Router PostHandle&quot;</span>)<br>    _, err := request.GetConnection().GetTCPConnection().Write([]<span class="hljs-type">byte</span>(<span class="hljs-string">&quot;After ping .....\n&quot;</span>))<br>    <span class="hljs-keyword">if</span> err !=<span class="hljs-literal">nil</span> &#123;<br>        fmt.Println(<span class="hljs-string">&quot;call back ping ping ping error&quot;</span>)<br>    &#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-comment">//创建一个server句柄</span><br>    s := znet.NewServer(<span class="hljs-string">&quot;[zinx V0.3]&quot;</span>)<br>    s.AddRouter(&amp;PingRouter&#123;&#125;)<br>    <span class="hljs-comment">//2 开启服务</span><br>    s.Serve()<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="Client-go"><a href="#Client-go" class="headerlink" title="Client.go"></a>Client.go</h3><p>代码不变</p>
<h1 id="v0-4-全局配置模块"><a href="#v0-4-全局配置模块" class="headerlink" title="[v0.4] 全局配置模块"></a>[v0.4] 全局配置模块</h1><blockquote>
<p>增加一个配置文件<code>zinx.json</code>，保存服务器的各项属性，方便修改服务器的参数</p>
</blockquote>
<h2 id="功能-1"><a href="#功能-1" class="headerlink" title="功能"></a>功能</h2><p><img src="../../../images/Zinx/fae2156087d3ad046eff80d3ac265f67-0.png" alt="img"></p>
<blockquote>
<p><strong>涉及知识点：</strong></p>
<ol>
<li>json格式问题</li>
<li>全局配置文件的好处</li>
</ol>
</blockquote>
<p>在<code>zinx</code>目录下新建<code>utils</code>文件夹，在<code>utils</code>文件夹下新建<code>globalobj.go</code>文件，这个go文件就是实现配置文件读取与输出的功能。</p>
<h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><p>在<code>zinx</code>下新建<code>conf</code>文件下，在其下新建<code>zinx.json</code>配置文件，内容如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;Name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;demo server&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;Host&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;127.0.0.1&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;TcpPort&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">7777</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;MaxConn&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><br>  <span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>
<p>从<code>globalobj.go</code>的功能来看，这里可以设置你所有的需要加入到服务器的配置，以<code>GlobalObj</code>结构体中的数据成员为主。</p>
<h2 id="globalobj-go"><a href="#globalobj-go" class="headerlink" title="globalobj.go"></a>globalobj.go</h2><p>对新手来讲，这个文件的代码中需要关注的两个函数：</p>
<ol>
<li><code>ioutil.ReadFile</code></li>
<li><code>json.Unmarshal</code></li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> utils<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;encoding/json&quot;</span><br>	<span class="hljs-string">&quot;io/ioutil&quot;</span><br>	<span class="hljs-string">&quot;zinx/ziface&quot;</span><br>	<span class="hljs-string">&quot;fmt&quot;</span><br>)<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">	存储一些有关Zinx框架的全局参数，供其他模块使用</span><br><span class="hljs-comment">	一些参数也可以通过用户根据zinx.json来配置</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-keyword">type</span> GlobalObj <span class="hljs-keyword">struct</span> &#123;<br>	tcpServer 	ziface.IServer 	<span class="hljs-comment">// 当前Zinx的全局Server对象</span><br>	Host 		<span class="hljs-type">string</span>			<span class="hljs-comment">// 当前服务器主机IP</span><br>	TcpPort		<span class="hljs-type">int</span>				<span class="hljs-comment">// 当前服务器主机监听端口号</span><br>	Name		<span class="hljs-type">string</span>			<span class="hljs-comment">// 当前服务器名称</span><br>	Version		<span class="hljs-type">string</span>			<span class="hljs-comment">//	当前Zinx版本</span><br>	MaxPacketSize <span class="hljs-type">uint32</span>		<span class="hljs-comment">// 都需数据包的最大值</span><br>	MaxConn		<span class="hljs-type">int</span>				<span class="hljs-comment">// 当前服务器主机允许的最大链接个数</span><br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">	定义一个全局的对象</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">var</span> GlobalObject *GlobalObj<br><br><span class="hljs-comment">// 读取用户的配置文件</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(g *GlobalObj)</span></span> Reload()  &#123;<br>	data, err := ioutil.ReadFile(<span class="hljs-string">&quot;D:/Program Files/Go/src/zinx/conf/zinx.json&quot;</span>)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-built_in">panic</span>(err)<br>	&#125;<br><br>	<span class="hljs-comment">// 将 json 数据解析到struct中</span><br>	<span class="hljs-comment">// fmt.Printf(&quot;json: %s\n&quot;, data)</span><br>	err = json.Unmarshal(data, &amp;GlobalObject)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-built_in">panic</span>(err)<br>	&#125;<br><br>	fmt.Println(fmt.Sprintf(<span class="hljs-string">&quot;%+v&quot;</span>,*GlobalObject))<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">	提供init方法，默认加载</span><br><span class="hljs-comment">*/</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span>  &#123;<br>	<span class="hljs-comment">// 初始化GlobalObject变量，设置一些默认值</span><br>	GlobalObject = &amp; GlobalObj&#123;<br>		Name: <span class="hljs-string">&quot;ZinxServerApp&quot;</span>,<br>		Version: <span class="hljs-string">&quot;V0.4&quot;</span>,<br>		TcpPort: <span class="hljs-number">7777</span>,<br>		Host: <span class="hljs-string">&quot;0.0.0.0&quot;</span>,<br>		MaxConn: <span class="hljs-number">12000</span>,<br>		MaxPacketSize: <span class="hljs-number">4096</span>,<br>	&#125;<br><br>	<span class="hljs-comment">// 从配置文件中加载一些用户配置的参数</span><br>	GlobalObject.Reload()<br>&#125;<br></code></pre></td></tr></table></figure>
<h1 id="V0-5-消息封装"><a href="#V0-5-消息封装" class="headerlink" title="[V0.5] 消息封装"></a>[V0.5] 消息封装</h1><h2 id="功能-2"><a href="#功能-2" class="headerlink" title="功能"></a>功能</h2><p>0.5版本要做的就是把服务器的全部数据都放在一个<code>Request</code>里：</p>
<p><img src="../../../images/Zinx/6d7f33a39b83c1cf24710d1e3a071c73-0.png" alt="img"></p>
<blockquote>
<p><strong>涉及知识点：</strong></p>
<ol>
<li>tcp封包拆包</li>
<li>消息封装</li>
</ol>
</blockquote>
<h2 id="创建消息封装类型"><a href="#创建消息封装类型" class="headerlink" title="创建消息封装类型"></a>创建消息封装类型</h2><p>当前的<code>Request</code>结构如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Request <span class="hljs-keyword">struct</span> &#123;<br>    conn ziface.IConnection <span class="hljs-comment">//已经和客户端建立好的链接</span><br>    data []<span class="hljs-type">byte</span>             <span class="hljs-comment">//客户端请求的数据</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>创建消息封装的结构体以及相关方法：</p>
<h2 id="imessage-go"><a href="#imessage-go" class="headerlink" title="imessage.go"></a>imessage.go</h2><p>在<code>zinx/ziface/</code>下创建<code>imessage.go</code>文件: 将请求的一个消息封装到 message 中，定义抽象层接口，定义好 Getter 方法和 Setter 方法。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> ziface<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">	将请求的一个消息封装到message中，定义抽象层接口</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-keyword">type</span> IMessage <span class="hljs-keyword">interface</span> &#123;<br>	GetDataLen() <span class="hljs-type">uint32</span> <span class="hljs-comment">// 获取消息数据段长度</span><br>	GetMsgId() <span class="hljs-type">uint32</span>	<span class="hljs-comment">// 获取消息ID</span><br>	GetData() []<span class="hljs-type">byte</span>	<span class="hljs-comment">// 获取消息内容</span><br>	SetMsgId(<span class="hljs-type">uint32</span>)	<span class="hljs-comment">// 设置消息ID</span><br>	SetData([]<span class="hljs-type">byte</span>)		<span class="hljs-comment">// 设置消息内容</span><br>	SetDataLen(<span class="hljs-type">uint32</span>)	<span class="hljs-comment">// 设置消息数据段长度</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="message-go"><a href="#message-go" class="headerlink" title="message.go"></a>message.go</h2><p>同时创建实例 message 类，在<code>zinx/znet/</code>下，创建<code>message.go</code>文件。</p>
<p>整理一个基本的 message 包，会包含<strong>消息 ID</strong>，<strong>数据</strong>，<strong>数据长度</strong>三个成员，提供基本的 setter 和 getter 方法，目的是为了以后做封装优化的作用。同时也提供了一个创建一个 message 包的初始化方法<code>NewMegPackage</code>。</p>
<p>这里我们只需要要实现 Message 类，写出构造函数，实现接口中对应的方法，比较的简单，大家可以试试先自己尝试实现。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> znet<br><br><span class="hljs-keyword">type</span> Message <span class="hljs-keyword">struct</span> &#123;<br>	Id		<span class="hljs-type">uint32</span> 	<span class="hljs-comment">// 消息的ID</span><br>	DataLen	<span class="hljs-type">uint32</span>	<span class="hljs-comment">// 消息的长度</span><br>	Data 	[]<span class="hljs-type">byte</span> 	<span class="hljs-comment">// 消息的内容</span><br>&#125;<br><br><span class="hljs-comment">// 创建一个Message的消息包</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewMsgPackage</span><span class="hljs-params">(id <span class="hljs-type">uint32</span>, data []<span class="hljs-type">byte</span>)</span></span> *Message &#123;<br>	<span class="hljs-keyword">return</span> &amp;Message&#123;<br>		Id: id,<br>		DataLen: <span class="hljs-type">uint32</span>(<span class="hljs-built_in">len</span>(data)),<br>		Data: data,<br>	&#125;<br>&#125;<br><br><span class="hljs-comment">// 获取消息数据段长度</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(msg *Message)</span></span> GetDataLen() <span class="hljs-type">uint32</span> &#123;<br>	<span class="hljs-keyword">return</span> msg.DataLen;<br>&#125;<br><span class="hljs-comment">//获取消息ID</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(msg *Message)</span></span> GetMsgId() <span class="hljs-type">uint32</span> &#123;<br>    <span class="hljs-keyword">return</span> msg.Id<br>&#125;<br><span class="hljs-comment">//获取消息内容</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(msg *Message)</span></span> GetData() []<span class="hljs-type">byte</span> &#123;<br>    <span class="hljs-keyword">return</span> msg.Data<br>&#125;<br><span class="hljs-comment">//设置消息数据段长度</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(msg *Message)</span></span> SetDataLen(<span class="hljs-built_in">len</span> <span class="hljs-type">uint32</span>) &#123;<br>    msg.DataLen = <span class="hljs-built_in">len</span><br>&#125;<br><span class="hljs-comment">//设计消息ID</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(msg *Message)</span></span> SetMsgId(msgId <span class="hljs-type">uint32</span>) &#123;<br>    msg.Id = msgId<br>&#125;<br><span class="hljs-comment">//设计消息内容</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(msg *Message)</span></span> SetData(data []<span class="hljs-type">byte</span>) &#123;<br>    msg.Data = data<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="拆包与封包"><a href="#拆包与封包" class="headerlink" title="拆包与封包*"></a>拆包与封包<code>*</code></h2><p>采用TCL(Type-Len-Value)封包格式解决TCP粘包问题</p>
<p><img src="../../../images/Zinx/c6982247c64f1a5e149a2f45adc98425.jpeg" alt="5.2 消息的封包与拆包  - 图1"></p>
<h3 id="创建拆包封包抽象类"><a href="#创建拆包封包抽象类" class="headerlink" title="创建拆包封包抽象类"></a>创建拆包封包抽象类</h3><p>在<code>zinx/ziface</code>下，创建<code>idatapack.go</code>文件</p>
<p>我们需要三个方法：</p>
<ul>
<li>封包数据。</li>
<li>拆包数据。</li>
<li>得到头部长度。</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> ziface<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">    封包数据和拆包数据</span><br><span class="hljs-comment">    直接面向TCP连接中的数据流,为传输数据添加头部信息，用于处理TCP粘包问题。</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">type</span> IDataPack <span class="hljs-keyword">interface</span>&#123;<br>    GetHeadLen() <span class="hljs-type">uint32</span>                    <span class="hljs-comment">//获取包头长度方法</span><br>    Pack(msg IMessage)([]<span class="hljs-type">byte</span>, <span class="hljs-type">error</span>)    <span class="hljs-comment">//封包方法</span><br>    Unpack([]<span class="hljs-type">byte</span>)(IMessage, <span class="hljs-type">error</span>)        <span class="hljs-comment">//拆包方法</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="实现拆包封包类"><a href="#实现拆包封包类" class="headerlink" title="实现拆包封包类"></a>实现拆包封包类</h3><p>在<code>zinx/znet/</code>下，创建<code>datapack.go</code>文件.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> znet<br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;bytes&quot;</span><br>    <span class="hljs-string">&quot;encoding/binary&quot;</span><br>    <span class="hljs-string">&quot;errors&quot;</span><br>    <span class="hljs-string">&quot;zinx/utils&quot;</span><br>    <span class="hljs-string">&quot;zinx/ziface&quot;</span><br>)<br><span class="hljs-comment">//封包拆包类实例，暂时不需要成员</span><br><span class="hljs-keyword">type</span> DataPack <span class="hljs-keyword">struct</span> &#123;&#125;<br><span class="hljs-comment">//封包拆包实例初始化方法</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewDataPack</span><span class="hljs-params">()</span></span> *DataPack &#123;<br>    <span class="hljs-keyword">return</span> &amp;DataPack&#123;&#125;<br>&#125;<br><span class="hljs-comment">//获取包头长度方法</span><br><span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(dp *DataPack)</span></span> GetHeadLen() <span class="hljs-type">uint32</span> &#123;<br>    <span class="hljs-comment">//Id uint32(4字节) +  DataLen uint32(4字节)</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">8</span><br>&#125;<br><span class="hljs-comment">//封包方法(压缩数据)</span><br><span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(dp *DataPack)</span></span> Pack(msg ziface.IMessage)([]<span class="hljs-type">byte</span>, <span class="hljs-type">error</span>) &#123;<br>    <span class="hljs-comment">//创建一个存放bytes字节的缓冲</span><br>    dataBuff := bytes.NewBuffer([]<span class="hljs-type">byte</span>&#123;&#125;)<br>    <span class="hljs-comment">//写dataLen</span><br>    <span class="hljs-keyword">if</span> err := binary.Write(dataBuff, binary.LittleEndian, msg.GetDataLen()); err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>    &#125;<br>    <span class="hljs-comment">//写msgID</span><br>    <span class="hljs-keyword">if</span> err := binary.Write(dataBuff, binary.LittleEndian, msg.GetMsgId()); err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>    &#125;<br>    <span class="hljs-comment">//写data数据</span><br>    <span class="hljs-keyword">if</span> err := binary.Write(dataBuff, binary.LittleEndian, msg.GetData()); err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span> ,err<br>    &#125;<br>    <span class="hljs-keyword">return</span> dataBuff.Bytes(), <span class="hljs-literal">nil</span><br>&#125;<br><span class="hljs-comment">//拆包方法(解压数据)</span><br><span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(dp *DataPack)</span></span> Unpack(binaryData []<span class="hljs-type">byte</span>)(ziface.IMessage, <span class="hljs-type">error</span>) &#123;<br>    <span class="hljs-comment">//创建一个从输入二进制数据的ioReader</span><br>    dataBuff := bytes.NewReader(binaryData)<br>    <span class="hljs-comment">//只解压head的信息，得到dataLen和msgID</span><br>    msg := &amp;Message&#123;&#125;<br>    <span class="hljs-comment">//读dataLen</span><br>    <span class="hljs-keyword">if</span> err := binary.Read(dataBuff, binary.LittleEndian, &amp;msg.DataLen); err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>    &#125;<br>    <span class="hljs-comment">//读msgID</span><br>    <span class="hljs-keyword">if</span> err := binary.Read(dataBuff, binary.LittleEndian, &amp;msg.Id); err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>    &#125;<br>    <span class="hljs-comment">//判断dataLen的长度是否超出我们允许的最大包长度</span><br>    <span class="hljs-keyword">if</span> (utils.GlobalObject.MaxPacketSize &gt; <span class="hljs-number">0</span> &amp;&amp; msg.DataLen &gt; utils.GlobalObject.MaxPacketSize) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.New(<span class="hljs-string">&quot;Too large msg data recieved&quot;</span>)<br>    &#125;<br>    <span class="hljs-comment">//这里只需要把head的数据拆包出来就可以了，然后再通过head的长度，再从conn读取一次数据</span><br>    <span class="hljs-keyword">return</span> msg, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>需要注意的是整理的<code>Unpack</code>方法，因为我们从上图可以知道，我们进行拆包的时候是分两次过程的，第二次是依赖第一次的 dataLen 结果，所以<code>Unpack</code>只能解压出包头 head 的内容，得到 msgId 和 dataLen。之后调用者再根据 dataLen 继续从 io 流中读取 body 中的数据。</p>
<h3 id="测试拆包与封包类型"><a href="#测试拆包与封包类型" class="headerlink" title="测试拆包与封包类型"></a>测试拆包与封包类型</h3><p>客户端与服务端的代码如下所示：</p>
<ul>
<li>Server.go</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;fmt&quot;</span><br>    <span class="hljs-string">&quot;io&quot;</span><br>    <span class="hljs-string">&quot;net&quot;</span><br>    <span class="hljs-string">&quot;zinx/znet&quot;</span><br>)<br><span class="hljs-comment">//只是负责测试datapack拆包，封包功能</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-comment">//创建socket TCP Server</span><br>    listener, err := net.Listen(<span class="hljs-string">&quot;tcp&quot;</span>, <span class="hljs-string">&quot;127.0.0.1:7777&quot;</span>)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        fmt.Println(<span class="hljs-string">&quot;server listen err:&quot;</span>, err)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    <span class="hljs-comment">//创建服务器gotoutine，负责从客户端goroutine读取粘包的数据，然后进行解析</span><br>    <span class="hljs-keyword">for</span> &#123;<br>        conn, err := listener.Accept()<br>        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>            fmt.Println(<span class="hljs-string">&quot;server accept err:&quot;</span>, err)<br>        &#125;<br>        <span class="hljs-comment">//处理客户端请求</span><br>        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(conn net.Conn)</span></span> &#123;<br>            <span class="hljs-comment">//创建封包拆包对象dp</span><br>            dp := znet.NewDataPack()<br>            <span class="hljs-keyword">for</span> &#123;<br>                <span class="hljs-comment">//1 先读出流中的head部分</span><br>                headData := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, dp.GetHeadLen())<br>                _, err := io.ReadFull(conn, headData) <span class="hljs-comment">//ReadFull 会把msg填充满为止</span><br>                <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>                    fmt.Println(<span class="hljs-string">&quot;read head error&quot;</span>)<br>                    <span class="hljs-keyword">break</span><br>                &#125;<br>                <span class="hljs-comment">//将headData字节流 拆包到msg中</span><br>                msgHead, err := dp.Unpack(headData)<br>                <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>                    fmt.Println(<span class="hljs-string">&quot;server unpack err:&quot;</span>, err)<br>                    <span class="hljs-keyword">return</span><br>                &#125;<br>                <span class="hljs-keyword">if</span> msgHead.GetDataLen() &gt; <span class="hljs-number">0</span> &#123;<br>                    <span class="hljs-comment">//msg 是有data数据的，需要再次读取data数据</span><br>                    <span class="hljs-comment">//`*`是指针运算符 , 可以表示一个变量是**指针类型** , 也可以表示**一个指针变量所指向的存储单元** , 也就是这个地址所存储的值 .</span><br>                    msg := msgHead.(*znet.Message)<br>                    msg.Data = <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, msg.GetDataLen())<br>                    <span class="hljs-comment">//根据dataLen从io中读取字节流</span><br>                    _, err := io.ReadFull(conn, msg.Data)<br>                    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>                        fmt.Println(<span class="hljs-string">&quot;server unpack data err:&quot;</span>, err)<br>                        <span class="hljs-keyword">return</span><br>                    &#125;<br>                    fmt.Println(<span class="hljs-string">&quot;==&gt; Recv Msg: ID=&quot;</span>, msg.Id, <span class="hljs-string">&quot;, len=&quot;</span>, msg.DataLen, <span class="hljs-string">&quot;, data=&quot;</span>, <span class="hljs-type">string</span>(msg.Data))<br>                &#125;<br>            &#125;<br>        &#125;(conn)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<ul>
<li>Client.go</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;fmt&quot;</span><br>    <span class="hljs-string">&quot;net&quot;</span><br>    <span class="hljs-string">&quot;zinx/znet&quot;</span><br>)<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-comment">//客户端goroutine，负责模拟粘包的数据，然后进行发送</span><br>    conn, err := net.Dial(<span class="hljs-string">&quot;tcp&quot;</span>, <span class="hljs-string">&quot;127.0.0.1:7777&quot;</span>)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        fmt.Println(<span class="hljs-string">&quot;client dial err:&quot;</span>, err)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    <span class="hljs-comment">//创建一个封包对象 dp</span><br>    dp := znet.NewDataPack()<br>    <span class="hljs-comment">//封装一个msg1包</span><br>    msg1 := &amp;znet.Message&#123;<br>        Id:      <span class="hljs-number">0</span>,<br>        DataLen: <span class="hljs-number">5</span>,<br>        Data:    []<span class="hljs-type">byte</span>&#123;<span class="hljs-string">&#x27;h&#x27;</span>, <span class="hljs-string">&#x27;e&#x27;</span>, <span class="hljs-string">&#x27;l&#x27;</span>, <span class="hljs-string">&#x27;l&#x27;</span>, <span class="hljs-string">&#x27;o&#x27;</span>&#125;,<br>    &#125;<br>    sendData1, err := dp.Pack(msg1)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        fmt.Println(<span class="hljs-string">&quot;client pack msg1 err:&quot;</span>, err)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    msg2 := &amp;znet.Message&#123;<br>        Id:      <span class="hljs-number">1</span>,<br>        DataLen: <span class="hljs-number">7</span>,<br>        Data:    []<span class="hljs-type">byte</span>&#123;<span class="hljs-string">&#x27;w&#x27;</span>, <span class="hljs-string">&#x27;o&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>, <span class="hljs-string">&#x27;l&#x27;</span>, <span class="hljs-string">&#x27;d&#x27;</span>, <span class="hljs-string">&#x27;!&#x27;</span>, <span class="hljs-string">&#x27;!&#x27;</span>&#125;,<br>    &#125;<br>    sendData2, err := dp.Pack(msg2)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        fmt.Println(<span class="hljs-string">&quot;client temp msg2 err:&quot;</span>, err)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    <span class="hljs-comment">//将sendData1，和 sendData2 拼接一起，组成粘包</span><br>    sendData1 = <span class="hljs-built_in">append</span>(sendData1, sendData2...)<br>    <span class="hljs-comment">//向服务器端写数据</span><br>    conn.Write(sendData1)<br>    <span class="hljs-comment">//客户端阻塞</span><br>    <span class="hljs-keyword">select</span> &#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="Request字段修改"><a href="#Request字段修改" class="headerlink" title="Request字段修改"></a>Request字段修改</h3><p>首先我们要将我们之前的 Request 中的<code>[]byte</code>类型的 data 字段改成 Message 类型.。并且我们需要把 irequest 的方法新增一个 GetMsgID。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> znet<br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;zinx/ziface&quot;</span><br><span class="hljs-keyword">type</span> Request <span class="hljs-keyword">struct</span> &#123;<br>    conn ziface.IConnection <span class="hljs-comment">//已经和客户端建立好的 链接</span><br>    msg ziface.IMessage     <span class="hljs-comment">//客户端请求的数据</span><br>&#125;<br><span class="hljs-comment">//获取请求连接信息</span><br><span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(r *Request)</span></span> GetConnection() ziface.IConnection &#123;<br>    <span class="hljs-keyword">return</span> r.conn<br>&#125;<br><span class="hljs-comment">//获取请求消息的数据</span><br><span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(r *Request)</span></span> GetData() []<span class="hljs-type">byte</span> &#123;<br>    <span class="hljs-keyword">return</span> r.msg.GetData()<br>&#125;<br><span class="hljs-comment">//获取请求的消息的ID</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *Request)</span></span> GetMsgID() <span class="hljs-type">uint32</span> &#123;<br>    <span class="hljs-keyword">return</span> r.msg.GetMsgId()<br>&#125;<br><span class="hljs-keyword">package</span> ziface<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">   IRequest 接口：</span><br><span class="hljs-comment">   实际上是把客户端请求的链接信息 和 请求的数据 包装到了 Request里</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">type</span> IRequest <span class="hljs-keyword">interface</span>&#123;<br>    GetConnection() IConnection    <span class="hljs-comment">//获取请求连接信息</span><br>    GetData() []<span class="hljs-type">byte</span>            <span class="hljs-comment">//获取请求消息的数据</span><br>    GetMsgID() <span class="hljs-type">uint32</span>           <span class="hljs-comment">//hu获取消息的id</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="集成拆包过程"><a href="#集成拆包过程" class="headerlink" title="集成拆包过程"></a>集成拆包过程</h4><p>接下来我们需要在 Connection 的<code>StartReader()</code>方法中,修改之前的读取客户端的这段代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Connection)</span></span> StartReader() &#123;<br>    <span class="hljs-comment">//...</span><br>    <span class="hljs-keyword">for</span>  &#123;<br>        <span class="hljs-comment">//读取我们最大的数据到buf中</span><br>        buf := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, utils.GlobalObject.MaxPacketSize)<br>        _, err := c.Conn.Read(buf)<br>        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>            fmt.Println(<span class="hljs-string">&quot;recv buf err &quot;</span>, err)<br>            c.ExitBuffChan &lt;- <span class="hljs-literal">true</span><br>            <span class="hljs-keyword">continue</span><br>        &#125;<br>        <span class="hljs-comment">//...</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>将这个函数做出如下改造：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Connection)</span></span> StartReader() &#123;<br>    fmt.Println(<span class="hljs-string">&quot;Reader Goroutine is  running&quot;</span>)<br>    <span class="hljs-keyword">defer</span> fmt.Println(c.RemoteAddr().String(), <span class="hljs-string">&quot; conn reader exit!&quot;</span>)<br>    <span class="hljs-keyword">defer</span> c.Stop()<br>    <span class="hljs-keyword">for</span>  &#123;<br>        <span class="hljs-comment">// 创建拆包解包的对象</span><br>        dp := NewDataPack()<br>        <span class="hljs-comment">//读取客户端的Msg head</span><br>        headData := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, dp.GetHeadLen())<br>        <span class="hljs-keyword">if</span> _, err := io.ReadFull(c.GetTCPConnection(), headData); err != <span class="hljs-literal">nil</span> &#123;<br>            fmt.Println(<span class="hljs-string">&quot;read msg head error &quot;</span>, err)<br>            c.ExitBuffChan &lt;- <span class="hljs-literal">true</span><br>            <span class="hljs-keyword">continue</span><br>        &#125;<br>        <span class="hljs-comment">//拆包，得到msgid 和 datalen 放在msg中</span><br>        msg , err := dp.Unpack(headData)<br>        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>            fmt.Println(<span class="hljs-string">&quot;unpack error &quot;</span>, err)<br>            c.ExitBuffChan &lt;- <span class="hljs-literal">true</span><br>            <span class="hljs-keyword">continue</span><br>        &#125;<br>        <span class="hljs-comment">//根据 dataLen 读取 data，放在msg.Data中</span><br>        <span class="hljs-keyword">var</span> data []<span class="hljs-type">byte</span><br>        <span class="hljs-keyword">if</span> msg.GetDataLen() &gt; <span class="hljs-number">0</span> &#123;<br>            data = <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, msg.GetDataLen())<br>            <span class="hljs-keyword">if</span> _, err := io.ReadFull(c.GetTCPConnection(), data); err != <span class="hljs-literal">nil</span> &#123;<br>                fmt.Println(<span class="hljs-string">&quot;read msg data error &quot;</span>, err)<br>                c.ExitBuffChan &lt;- <span class="hljs-literal">true</span><br>                <span class="hljs-keyword">continue</span><br>            &#125;<br>        &#125;<br>        msg.SetData(data)<br>        <span class="hljs-comment">//得到当前客户端请求的Request数据</span><br>        req := Request&#123;<br>            conn:c,<br>            msg:msg, <span class="hljs-comment">//将之前的buf 改成 msg</span><br>        &#125;<br>        <span class="hljs-comment">//从路由Routers 中找到注册绑定Conn的对应Handle</span><br>        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(request ziface.IRequest)</span></span> &#123;<br>            <span class="hljs-comment">//执行注册的路由方法</span><br>            c.Router.PreHandle(request)<br>            c.Router.Handle(request)<br>            c.Router.PostHandle(request)<br>        &#125;(&amp;req)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="提供封包方法"><a href="#提供封包方法" class="headerlink" title="提供封包方法"></a>提供封包方法</h4><p>现在我们已经将拆包的功能集成到 Zinx 中了，但是使用 Zinx 的时候，如果我们希望给用户返回一个 TLV 格式的数据，总不能每次都经过这么繁琐的过程，所以我们应该给 Zinx 提供一个封包的接口，供 Zinx 发包使用。 我们在 iconnection.go 中新增 SendMsg()方法。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> ziface<br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;net&quot;</span><br><span class="hljs-comment">//定义连接接口</span><br><span class="hljs-keyword">type</span> IConnection <span class="hljs-keyword">interface</span> &#123;<br>    <span class="hljs-comment">//启动连接，让当前连接开始工作</span><br>    Start()<br>    <span class="hljs-comment">//停止连接，结束当前连接状态M</span><br>    Stop()<br>    <span class="hljs-comment">//从当前连接获取原始的socket TCPConn</span><br>    GetTCPConnection() *net.TCPConn<br>    <span class="hljs-comment">//获取当前连接ID</span><br>    GetConnID() <span class="hljs-type">uint32</span><br>    <span class="hljs-comment">//获取远程客户端地址信息</span><br>    RemoteAddr() net.Addr<br>    <span class="hljs-comment">//直接将Message数据发送数据给远程的TCP客户端</span><br>    SendMsg(msgId <span class="hljs-type">uint32</span>, data []<span class="hljs-type">byte</span>) <span class="hljs-type">error</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>然后，我们到 connection.go 中实现这个方法。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">//直接将Message数据发送数据给远程的TCP客户端</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Connection)</span></span> SendMsg(msgId <span class="hljs-type">uint32</span>, data []<span class="hljs-type">byte</span>) <span class="hljs-type">error</span> &#123;<br>    <span class="hljs-keyword">if</span> c.isClosed == <span class="hljs-literal">true</span> &#123;<br>        <span class="hljs-keyword">return</span> errors.New(<span class="hljs-string">&quot;Connection closed when send msg&quot;</span>)<br>    &#125;<br>    <span class="hljs-comment">//将data封包，并且发送</span><br>    dp := NewDataPack()<br>    msg, err := dp.Pack(NewMsgPackage(msgId, data))<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        fmt.Println(<span class="hljs-string">&quot;Pack error msg id = &quot;</span>, msgId)<br>        <span class="hljs-keyword">return</span>  errors.New(<span class="hljs-string">&quot;Pack error msg &quot;</span>)<br>    &#125;<br>    <span class="hljs-comment">//写回客户端</span><br>    <span class="hljs-keyword">if</span> _, err := c.Conn.Write(msg); err != <span class="hljs-literal">nil</span> &#123;<br>        fmt.Println(<span class="hljs-string">&quot;Write msg id &quot;</span>, msgId, <span class="hljs-string">&quot; error &quot;</span>)<br>        c.ExitBuffChan &lt;- <span class="hljs-literal">true</span><br>        <span class="hljs-keyword">return</span> errors.New(<span class="hljs-string">&quot;conn Write error&quot;</span>)<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>注意，做出修改后，我们需要在 connection.go 中将 io 和 errors 包引入进来。</p>
<h3 id="zinx-0-5-测试"><a href="#zinx-0-5-测试" class="headerlink" title="zinx 0.5 测试"></a>zinx 0.5 测试</h3><ul>
<li>Server.go</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;fmt&quot;</span><br>    <span class="hljs-string">&quot;zinx/ziface&quot;</span><br>    <span class="hljs-string">&quot;zinx/znet&quot;</span><br>)<br><span class="hljs-comment">//ping test 自定义路由</span><br><span class="hljs-keyword">type</span> PingRouter <span class="hljs-keyword">struct</span> &#123;<br>    znet.BaseRouter<br>&#125;<br><span class="hljs-comment">//Test Handle</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *PingRouter)</span></span> Handle(request ziface.IRequest) &#123;<br>    fmt.Println(<span class="hljs-string">&quot;Call PingRouter Handle&quot;</span>)<br>    <span class="hljs-comment">//先读取客户端的数据，再回写ping...ping...ping</span><br>    fmt.Println(<span class="hljs-string">&quot;recv from client : msgId=&quot;</span>, request.GetMsgID(), <span class="hljs-string">&quot;, data=&quot;</span>, <span class="hljs-type">string</span>(request.GetData()))<br>    <span class="hljs-comment">//回写数据</span><br>    err := request.GetConnection().SendMsg(<span class="hljs-number">1</span>, []<span class="hljs-type">byte</span>(<span class="hljs-string">&quot;ping...ping...ping&quot;</span>))<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        fmt.Println(err)<br>    &#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-comment">//创建一个server句柄</span><br>    s := znet.NewServer()<br>    <span class="hljs-comment">//配置路由</span><br>    s.AddRouter(&amp;PingRouter&#123;&#125;)<br>    <span class="hljs-comment">//开启服务</span><br>    s.Serve()<br>&#125;<br></code></pre></td></tr></table></figure>
<ul>
<li>Client.go</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;fmt&quot;</span><br>    <span class="hljs-string">&quot;io&quot;</span><br>    <span class="hljs-string">&quot;net&quot;</span><br>    <span class="hljs-string">&quot;time&quot;</span><br>    <span class="hljs-string">&quot;zinx/znet&quot;</span><br>)<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">    模拟客户端</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    fmt.Println(<span class="hljs-string">&quot;Client Test ... start&quot;</span>)<br>    <span class="hljs-comment">//3秒之后发起测试请求，给服务端开启服务的机会</span><br>    time.Sleep(<span class="hljs-number">3</span> * time.Second)<br>    conn,err := net.Dial(<span class="hljs-string">&quot;tcp&quot;</span>, <span class="hljs-string">&quot;127.0.0.1:7777&quot;</span>)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        fmt.Println(<span class="hljs-string">&quot;client start err, exit!&quot;</span>)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    <span class="hljs-keyword">for</span> &#123;<br>        <span class="hljs-comment">//发封包message消息</span><br>        dp := znet.NewDataPack()<br>        msg, _ := dp.Pack(znet.NewMsgPackage(<span class="hljs-number">0</span>,[]<span class="hljs-type">byte</span>(<span class="hljs-string">&quot;Zinx V0.5 Client Test Message&quot;</span>)))<br>        _, err := conn.Write(msg)<br>        <span class="hljs-keyword">if</span> err !=<span class="hljs-literal">nil</span> &#123;<br>            fmt.Println(<span class="hljs-string">&quot;write error err &quot;</span>, err)<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        <span class="hljs-comment">//先读出流中的head部分</span><br>        headData := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, dp.GetHeadLen())<br>        _, err = io.ReadFull(conn, headData) <span class="hljs-comment">//ReadFull 会把msg填充满为止</span><br>        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>            fmt.Println(<span class="hljs-string">&quot;read head error&quot;</span>)<br>            <span class="hljs-keyword">break</span><br>        &#125;<br>        <span class="hljs-comment">//将headData字节流 拆包到msg中</span><br>        msgHead, err := dp.Unpack(headData)<br>        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>            fmt.Println(<span class="hljs-string">&quot;server unpack err:&quot;</span>, err)<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        <span class="hljs-keyword">if</span> msgHead.GetDataLen() &gt; <span class="hljs-number">0</span> &#123;<br>            <span class="hljs-comment">//msg 是有data数据的，需要再次读取data数据</span><br>            msg := msgHead.(*znet.Message)<br>            msg.Data = <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, msg.GetDataLen())<br>            <span class="hljs-comment">//根据dataLen从io中读取字节流</span><br>            _, err := io.ReadFull(conn, msg.Data)<br>            <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>                fmt.Println(<span class="hljs-string">&quot;server unpack data err:&quot;</span>, err)<br>                <span class="hljs-keyword">return</span><br>            &#125;<br>            fmt.Println(<span class="hljs-string">&quot;==&gt; Recv Msg: ID=&quot;</span>, msg.Id, <span class="hljs-string">&quot;, len=&quot;</span>, msg.DataLen, <span class="hljs-string">&quot;, data=&quot;</span>, <span class="hljs-type">string</span>(msg.Data))<br>        &#125;<br>        time.Sleep(<span class="hljs-number">1</span>*time.Second)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h1 id="v0-6-多路由模式"><a href="#v0-6-多路由模式" class="headerlink" title="[v0.6] 多路由模式"></a>[v0.6] 多路由模式</h1><h2 id="功能-3"><a href="#功能-3" class="headerlink" title="功能"></a>功能</h2><p><img src="../../../images/Zinx/a51f97e14d4dd69d394843874bb9445c-0.png" alt="img"></p>
<blockquote>
<p><strong>涉及知识点</strong></p>
<ol>
<li>多路由模式</li>
<li>单元测试</li>
</ol>
</blockquote>
<h2 id="创建消息管理模块"><a href="#创建消息管理模块" class="headerlink" title="创建消息管理模块"></a>创建消息管理模块</h2><ol>
<li>创建消息管理模块抽象类</li>
</ol>
<p>在<code>zinx/ziface</code>下创建<code>imsghandler.go</code>文件， 定义出我们之前图片中的方法。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> ziface<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">    消息管理抽象层</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">type</span> IMsgHandle <span class="hljs-keyword">interface</span>&#123;<br>    DoMsgHandler(request IRequest)            <span class="hljs-comment">//马上以非阻塞方式处理消息</span><br>    AddRouter(msgId <span class="hljs-type">uint32</span>, router IRouter)    <span class="hljs-comment">//为消息添加具体的处理逻辑</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>这里面有两个方法，<code>AddRouter()</code>就是添加一个 msgId 和一个路由关系到 Apis 中，那么<code>DoMsgHandler()</code>则是调用 Router 中具体<code>Handle()</code>等方法的接口。</p>
<ol>
<li>实现消息管理模块</li>
</ol>
<p>在<code>zinx/znet</code>下创建<code>msghandler.go</code>文件。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> znet<br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;fmt&quot;</span><br>    <span class="hljs-string">&quot;strconv&quot;</span><br>    <span class="hljs-string">&quot;zinx/ziface&quot;</span><br>)<br><span class="hljs-keyword">type</span> MsgHandle <span class="hljs-keyword">struct</span>&#123;<br>    Apis <span class="hljs-keyword">map</span>[<span class="hljs-type">uint32</span>] ziface.IRouter <span class="hljs-comment">//存放每个MsgId 所对应的处理方法的map属性</span><br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewMsgHandle</span><span class="hljs-params">()</span></span> *MsgHandle &#123;<br>    <span class="hljs-keyword">return</span> &amp;MsgHandle &#123;<br>        Apis:<span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">uint32</span>]ziface.IRouter),<br>    &#125;<br>&#125;<br><span class="hljs-comment">//马上以非阻塞方式处理消息</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(mh *MsgHandle)</span></span> DoMsgHandler(request ziface.IRequest)    &#123;<br>    handler, ok := mh.Apis[request.GetMsgID()]<br>    <span class="hljs-keyword">if</span> !ok &#123;<br>        fmt.Println(<span class="hljs-string">&quot;api msgId = &quot;</span>, request.GetMsgID(), <span class="hljs-string">&quot; is not FOUND!&quot;</span>)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    <span class="hljs-comment">//执行对应处理方法</span><br>    handler.PreHandle(request)<br>    handler.Handle(request)<br>    handler.PostHandle(request)<br>&#125;<br><span class="hljs-comment">//为消息添加具体的处理逻辑</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(mh *MsgHandle)</span></span> AddRouter(msgId <span class="hljs-type">uint32</span>, router ziface.IRouter) &#123;<br>    <span class="hljs-comment">//1 判断当前msg绑定的API处理方法是否已经存在</span><br>    <span class="hljs-keyword">if</span> _, ok := mh.Apis[msgId]; ok &#123;<br>        <span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;repeated api , msgId = &quot;</span> + strconv.Itoa(<span class="hljs-type">int</span>(msgId)))<br>    &#125;<br>    <span class="hljs-comment">//2 添加msg与api的绑定关系</span><br>    mh.Apis[msgId] = router<br>    fmt.Println(<span class="hljs-string">&quot;Add api msgId = &quot;</span>, msgId)<br>&#125;<br></code></pre></td></tr></table></figure>
<ol>
<li>zinx其他模块的相应修改</li>
</ol>
<p>首先<code>iserver</code>的<code>AddRouter()</code>的接口要稍微改一下，增添 MsgId 参数.</p>
<p>iserver.go:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> ziface<br><span class="hljs-comment">//定义服务器接口</span><br><span class="hljs-keyword">type</span> IServer <span class="hljs-keyword">interface</span>&#123;<br>    <span class="hljs-comment">//启动服务器方法</span><br>    Start()<br>    <span class="hljs-comment">//停止服务器方法</span><br>    Stop()<br>    <span class="hljs-comment">//开启业务服务方法</span><br>    Serve()<br>    <span class="hljs-comment">//路由功能：给当前服务注册一个路由业务方法，供客户端链接处理使用</span><br>    AddRouter(msgId <span class="hljs-type">uint32</span>, router IRouter)<br>&#125;<br></code></pre></td></tr></table></figure>
<p>其次，<code>Server</code>类中 之前有一个<code>Router</code>成员 ，代表唯一的处理方法，现在应该替换成<code>MsgHandler</code>成员。</p>
<blockquote>
<p>zinx/znet/server.go</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Server <span class="hljs-keyword">struct</span> &#123;<br>    <span class="hljs-comment">//服务器的名称</span><br>    Name <span class="hljs-type">string</span><br>    <span class="hljs-comment">//tcp4 or other</span><br>    IPVersion <span class="hljs-type">string</span><br>    <span class="hljs-comment">//服务绑定的IP地址</span><br>    IP <span class="hljs-type">string</span><br>    <span class="hljs-comment">//服务绑定的端口</span><br>    Port <span class="hljs-type">int</span><br>    <span class="hljs-comment">//当前Server的消息管理模块，用来绑定MsgId和对应的处理方法</span><br>    msgHandler ziface.IMsgHandle<br>&#125;<br></code></pre></td></tr></table></figure>
<p>初始化 Server 自然也要更正，增加 msgHandler 初始化。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/*</span><br><span class="hljs-comment">  创建一个服务器句柄</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewServer</span> <span class="hljs-params">()</span></span> ziface.IServer &#123;<br>    utils.GlobalObject.Reload()<br>    s:= &amp;Server &#123;<br>        Name :utils.GlobalObject.Name,<br>        IPVersion:<span class="hljs-string">&quot;tcp4&quot;</span>,<br>        IP:utils.GlobalObject.Host,<br>        Port:utils.GlobalObject.TcpPort,<br>        msgHandler: NewMsgHandle(), <span class="hljs-comment">//msgHandler 初始化</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> s<br>&#125;<br></code></pre></td></tr></table></figure>
<p>然后当 Server 在处理 conn 请求业务的时候，创建 conn 的时候也需要把 msgHandler 作为参数传递给 Connection 对象。也就是在我们 server.go 的 Start() 方法中的 3.3 注释下进行如下修改：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">//...</span><br>dealConn := NewConntion(conn, cid, s.msgHandler)<br><span class="hljs-comment">//...</span><br></code></pre></td></tr></table></figure>
<p>最后，我们的 AddRouter 方法做了修改，所以要重新实现接口方法：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">//路由功能：给当前服务注册一个路由业务方法，供客户端链接处理使用</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Server)</span></span>AddRouter(msgId <span class="hljs-type">uint32</span>, router ziface.IRouter) &#123;<br>    s.msgHandler.AddRouter(msgId,router)<br>&#125;<br></code></pre></td></tr></table></figure>
<p>那么接下来就是 Connection 对象了。固然在 Connection 对象中应该有 MsgHandler 的成员，来查找消息对应的回调路由方法。</p>
<blockquote>
<p>zinx/znet/connection.go</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Connection <span class="hljs-keyword">struct</span> &#123;<br>    <span class="hljs-comment">//当前连接的socket TCP套接字</span><br>    Conn *net.TCPConn<br>    <span class="hljs-comment">//当前连接的ID 也可以称作为SessionID，ID全局唯一</span><br>    ConnID <span class="hljs-type">uint32</span><br>    <span class="hljs-comment">//当前连接的关闭状态</span><br>    isClosed <span class="hljs-type">bool</span><br>    <span class="hljs-comment">//消息管理MsgId和对应处理方法的消息管理模块</span><br>    MsgHandler ziface.IMsgHandle<br>    <span class="hljs-comment">//告知该链接已经退出/停止的channel</span><br>    ExitBuffChan <span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span><br>&#125;<br><span class="hljs-comment">//创建连接的方法</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewConntion</span><span class="hljs-params">(conn *net.TCPConn, connID <span class="hljs-type">uint32</span>, msgHandler ziface.IMsgHandle)</span></span> *Connection&#123;<br>    c := &amp;Connection&#123;<br>        Conn:     conn,<br>        ConnID:   connID,<br>        isClosed: <span class="hljs-literal">false</span>,<br>        MsgHandler: msgHandler,<br>        ExitBuffChan: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span>, <span class="hljs-number">1</span>),<br>    &#125;<br>    <span class="hljs-keyword">return</span> c<br>&#125;<br></code></pre></td></tr></table></figure>
<p>最后，在 conn 已经拆包之后，需要调用路由业务的时候，我们只需要让 conn 调用 MsgHandler 中的<code>DoMsgHander()</code>方法就好了。</p>
<blockquote>
<p>zinx/znet/connection.go</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Connection)</span></span> StartReader() &#123;<br>    fmt.Println(<span class="hljs-string">&quot;[Reader Goroutine is running]&quot;</span>)<br>    <span class="hljs-keyword">defer</span> fmt.Println(c.RemoteAddr().String(), <span class="hljs-string">&quot;[conn Reader exit!]&quot;</span>)<br>    <span class="hljs-keyword">defer</span> c.Stop()<br>    <span class="hljs-keyword">for</span>  &#123;<br>        <span class="hljs-comment">// 创建拆包解包的对象</span><br>        dp := NewDataPack()<br>        <span class="hljs-comment">//读取客户端的Msg head</span><br>        headData := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, dp.GetHeadLen())<br>        <span class="hljs-keyword">if</span> _, err := io.ReadFull(c.GetTCPConnection(), headData); err != <span class="hljs-literal">nil</span> &#123;<br>            fmt.Println(<span class="hljs-string">&quot;read msg head error &quot;</span>, err)<br>            <span class="hljs-keyword">break</span><br>        &#125;<br>        <span class="hljs-comment">//拆包，得到msgid 和 datalen 放在msg中</span><br>        msg , err := dp.Unpack(headData)<br>        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>            fmt.Println(<span class="hljs-string">&quot;unpack error &quot;</span>, err)<br>            <span class="hljs-keyword">break</span><br>        &#125;<br>        <span class="hljs-comment">//根据 dataLen 读取 data，放在msg.Data中</span><br>        <span class="hljs-keyword">var</span> data []<span class="hljs-type">byte</span><br>        <span class="hljs-keyword">if</span> msg.GetDataLen() &gt; <span class="hljs-number">0</span> &#123;<br>            data = <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, msg.GetDataLen())<br>            <span class="hljs-keyword">if</span> _, err := io.ReadFull(c.GetTCPConnection(), data); err != <span class="hljs-literal">nil</span> &#123;<br>                fmt.Println(<span class="hljs-string">&quot;read msg data error &quot;</span>, err)<br>                <span class="hljs-keyword">continue</span><br>            &#125;<br>        &#125;<br>        msg.SetData(data)<br>        <span class="hljs-comment">//得到当前客户端请求的Request数据</span><br>        req := Request&#123;<br>            conn:c,<br>            msg:msg,<br>        &#125;<br>        <span class="hljs-comment">//从绑定好的消息和对应的处理方法中执行对应的Handle方法</span><br>        <span class="hljs-keyword">go</span> c.MsgHandler.DoMsgHandler(&amp;req)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>好了，大功告成，我们来测试一下 Zinx 的多路由设置功能吧。</p>
<h2 id="zinx测试"><a href="#zinx测试" class="headerlink" title="zinx测试"></a>zinx测试</h2><p>这里我们既然完成了多路由模式，那么就可以进行一个服务端，多个客户端的方式进行测试我们的功能模块了。</p>
<p>我们这里在 zinx 文件夹下新建 Client01.go 文件。</p>
<p>我们在 Server 端设置 2 个路由，一个是 MsgId 为 0 的消息会执行 PingRouter{}重写的<code>Handle()</code>方法，一个是 MsgId 为 1 的消息会执行 HelloZinxRouter{}重写的<code>Handle()</code>方法。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;fmt&quot;</span><br>    <span class="hljs-string">&quot;zinx/ziface&quot;</span><br>    <span class="hljs-string">&quot;zinx/znet&quot;</span><br>)<br><span class="hljs-comment">//ping test 自定义路由</span><br><span class="hljs-keyword">type</span> PingRouter <span class="hljs-keyword">struct</span> &#123;<br>    znet.BaseRouter<br>&#125;<br><span class="hljs-comment">//Ping Handle</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *PingRouter)</span></span> Handle(request ziface.IRequest) &#123;<br>    fmt.Println(<span class="hljs-string">&quot;Call PingRouter Handle&quot;</span>)<br>    <span class="hljs-comment">//先读取客户端的数据，再回写ping...ping...ping</span><br>    fmt.Println(<span class="hljs-string">&quot;recv from client : msgId=&quot;</span>, request.GetMsgID(), <span class="hljs-string">&quot;, data=&quot;</span>, <span class="hljs-type">string</span>(request.GetData()))<br>    err := request.GetConnection().SendMsg(<span class="hljs-number">0</span>, []<span class="hljs-type">byte</span>(<span class="hljs-string">&quot;ping...ping...ping&quot;</span>))<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        fmt.Println(err)<br>    &#125;<br>&#125;<br><span class="hljs-comment">//HelloZinxRouter Handle</span><br><span class="hljs-keyword">type</span> HelloZinxRouter <span class="hljs-keyword">struct</span> &#123;<br>    znet.BaseRouter<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *HelloZinxRouter)</span></span> Handle(request ziface.IRequest) &#123;<br>    fmt.Println(<span class="hljs-string">&quot;Call HelloZinxRouter Handle&quot;</span>)<br>    <span class="hljs-comment">//先读取客户端的数据，再回写ping...ping...ping</span><br>    fmt.Println(<span class="hljs-string">&quot;recv from client : msgId=&quot;</span>, request.GetMsgID(), <span class="hljs-string">&quot;, data=&quot;</span>, <span class="hljs-type">string</span>(request.GetData()))<br>    err := request.GetConnection().SendMsg(<span class="hljs-number">1</span>, []<span class="hljs-type">byte</span>(<span class="hljs-string">&quot;Hello Zinx Router V0.6&quot;</span>))<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        fmt.Println(err)<br>    &#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-comment">//创建一个server句柄</span><br>    s := znet.NewServer()<br>    <span class="hljs-comment">//配置路由</span><br>    s.AddRouter(<span class="hljs-number">0</span>, &amp;PingRouter&#123;&#125;)<br>    s.AddRouter(<span class="hljs-number">1</span>, &amp;HelloZinxRouter&#123;&#125;)<br>    <span class="hljs-comment">//开启服务</span><br>    s.Serve()<br>&#125;<br></code></pre></td></tr></table></figure>
<p>我们现在写两个客户端，分别发送 0 消息和 1 消息来进行测试 Zinx 是否能够处理 2 个不同的消息业务。</p>
<p>Client.go:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;fmt&quot;</span><br>    <span class="hljs-string">&quot;io&quot;</span><br>    <span class="hljs-string">&quot;net&quot;</span><br>    <span class="hljs-string">&quot;time&quot;</span><br>    <span class="hljs-string">&quot;zinx/znet&quot;</span><br>)<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">    模拟客户端</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    fmt.Println(<span class="hljs-string">&quot;Client Test ... start&quot;</span>)<br>    <span class="hljs-comment">//3秒之后发起测试请求，给服务端开启服务的机会</span><br>    time.Sleep(<span class="hljs-number">3</span> * time.Second)<br>    conn,err := net.Dial(<span class="hljs-string">&quot;tcp&quot;</span>, <span class="hljs-string">&quot;127.0.0.1:7777&quot;</span>)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        fmt.Println(<span class="hljs-string">&quot;client start err, exit!&quot;</span>)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    <span class="hljs-keyword">for</span> &#123;<br>        <span class="hljs-comment">//发封包message消息</span><br>        dp := znet.NewDataPack()<br>        msg, _ := dp.Pack(znet.NewMsgPackage(<span class="hljs-number">0</span>,[]<span class="hljs-type">byte</span>(<span class="hljs-string">&quot;Zinx V0.6 Client0 Test Message&quot;</span>)))<br>        _, err := conn.Write(msg)<br>        <span class="hljs-keyword">if</span> err !=<span class="hljs-literal">nil</span> &#123;<br>            fmt.Println(<span class="hljs-string">&quot;write error err &quot;</span>, err)<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        <span class="hljs-comment">//先读出流中的head部分</span><br>        headData := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, dp.GetHeadLen())<br>        _, err = io.ReadFull(conn, headData) <span class="hljs-comment">//ReadFull 会把msg填充满为止</span><br>        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>            fmt.Println(<span class="hljs-string">&quot;read head error&quot;</span>)<br>            <span class="hljs-keyword">break</span><br>        &#125;<br>        <span class="hljs-comment">//将headData字节流 拆包到msg中</span><br>        msgHead, err := dp.Unpack(headData)<br>        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>            fmt.Println(<span class="hljs-string">&quot;server unpack err:&quot;</span>, err)<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        <span class="hljs-keyword">if</span> msgHead.GetDataLen() &gt; <span class="hljs-number">0</span> &#123;<br>            <span class="hljs-comment">//msg 是有data数据的，需要再次读取data数据</span><br>            msg := msgHead.(*znet.Message)<br>            msg.Data = <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, msg.GetDataLen())<br>            <span class="hljs-comment">//根据dataLen从io中读取字节流</span><br>            _, err := io.ReadFull(conn, msg.Data)<br>            <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>                fmt.Println(<span class="hljs-string">&quot;server unpack data err:&quot;</span>, err)<br>                <span class="hljs-keyword">return</span><br>            &#125;<br>            fmt.Println(<span class="hljs-string">&quot;==&gt; Recv Msg: ID=&quot;</span>, msg.Id, <span class="hljs-string">&quot;, len=&quot;</span>, msg.DataLen, <span class="hljs-string">&quot;, data=&quot;</span>, <span class="hljs-type">string</span>(msg.Data))<br>        &#125;<br>        time.Sleep(<span class="hljs-number">1</span>*time.Second)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>Client01.go:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;fmt&quot;</span><br>    <span class="hljs-string">&quot;io&quot;</span><br>    <span class="hljs-string">&quot;net&quot;</span><br>    <span class="hljs-string">&quot;time&quot;</span><br>    <span class="hljs-string">&quot;zinx/znet&quot;</span><br>)<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">    模拟客户端</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    fmt.Println(<span class="hljs-string">&quot;Client Test ... start&quot;</span>)<br>    <span class="hljs-comment">//3秒之后发起测试请求，给服务端开启服务的机会</span><br>    time.Sleep(<span class="hljs-number">3</span> * time.Second)<br>    conn,err := net.Dial(<span class="hljs-string">&quot;tcp&quot;</span>, <span class="hljs-string">&quot;127.0.0.1:7777&quot;</span>)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        fmt.Println(<span class="hljs-string">&quot;client start err, exit!&quot;</span>)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    <span class="hljs-keyword">for</span> &#123;<br>        <span class="hljs-comment">//发封包message消息</span><br>        dp := znet.NewDataPack()<br>        msg, _ := dp.Pack(znet.NewMsgPackage(<span class="hljs-number">1</span>,[]<span class="hljs-type">byte</span>(<span class="hljs-string">&quot;Zinx V0.6 Client1 Test Message&quot;</span>)))<br>        _, err := conn.Write(msg)<br>        <span class="hljs-keyword">if</span> err !=<span class="hljs-literal">nil</span> &#123;<br>            fmt.Println(<span class="hljs-string">&quot;write error err &quot;</span>, err)<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        <span class="hljs-comment">//先读出流中的head部分</span><br>        headData := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, dp.GetHeadLen())<br>        _, err = io.ReadFull(conn, headData) <span class="hljs-comment">//ReadFull 会把msg填充满为止</span><br>        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>            fmt.Println(<span class="hljs-string">&quot;read head error&quot;</span>)<br>            <span class="hljs-keyword">break</span><br>        &#125;<br>        <span class="hljs-comment">//将headData字节流 拆包到msg中</span><br>        msgHead, err := dp.Unpack(headData)<br>        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>            fmt.Println(<span class="hljs-string">&quot;server unpack err:&quot;</span>, err)<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        <span class="hljs-keyword">if</span> msgHead.GetDataLen() &gt; <span class="hljs-number">0</span> &#123;<br>            <span class="hljs-comment">//msg 是有data数据的，需要再次读取data数据</span><br>            msg := msgHead.(*znet.Message)<br>            msg.Data = <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, msg.GetDataLen())<br>            <span class="hljs-comment">//根据dataLen从io中读取字节流</span><br>            _, err := io.ReadFull(conn, msg.Data)<br>            <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>                fmt.Println(<span class="hljs-string">&quot;server unpack data err:&quot;</span>, err)<br>                <span class="hljs-keyword">return</span><br>            &#125;<br>            fmt.Println(<span class="hljs-string">&quot;==&gt; Recv Msg: ID=&quot;</span>, msg.Id, <span class="hljs-string">&quot;, len=&quot;</span>, msg.DataLen, <span class="hljs-string">&quot;, data=&quot;</span>, <span class="hljs-type">string</span>(msg.Data))<br>        &#125;<br>        time.Sleep(<span class="hljs-number">1</span>*time.Second)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>然后我们点击命令行右上角的分隔按钮，启动三个命令行窗口。值得注意的是，每启动一个窗口，都需要在里面先执行 <code>export GOPATH=/home/project</code> 这道命令。</p>
<p>测试结果：</p>
<p><img src="../../../images/Zinx/5079265929daf30444ba414d8cedff98-0.png" alt="img"></p>
<h1 id="v0-7-读写分离"><a href="#v0-7-读写分离" class="headerlink" title="[v0.7] 读写分离"></a>[v0.7] 读写分离</h1><h2 id="功能-4"><a href="#功能-4" class="headerlink" title="功能"></a>功能</h2><p><img src="https://doc.shiyanlou.com/courses/1639/1240622/0b1e3201b784a5a2b358789aa408803e-0" alt="img"></p>
<p>接下来我们就要对 Zinx 做一个小小的改变，就是与客户端进修数据交互的 Gouroutine 由一个变成两个，一个专门负责从客户端读取数据，一个专门负责向客户端写数据。这么设计有什么好处，当然是目的就是高内聚，模块的功能单一，对于我们今后扩展功能更加方便。</p>
<blockquote>
<p><strong>知识点</strong></p>
<ol>
<li>Golang并发模型</li>
<li>读写分离</li>
</ol>
</blockquote>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p><img src="../../../images/Zinx/ee191fe76155df0c6a4f83ec2915aa6f.jpeg" alt="七、Zinx的读写分离模型  - 图1"></p>
<p>Server 依然是处理客户端的响应，主要关键的几个方法是 Listen、Accept 等。当建立与客户端的套接字后，那么就会开启两个 Goroutine 分别处理读数据业务和写数据业务，读写数据之间的消息通过一个 Channel 传递。下面我们就开始进行实际的实现。</p>
<h3 id="1-添加读写模块交互数据的管道"><a href="#1-添加读写模块交互数据的管道" class="headerlink" title="1. 添加读写模块交互数据的管道"></a>1. 添加读写模块交互数据的管道</h3><ol>
<li>connection.go</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Connection <span class="hljs-keyword">struct</span> &#123;<br>    <span class="hljs-comment">//当前连接的socket TCP套接字</span><br>    Conn *net.TCPConn<br>    <span class="hljs-comment">//当前连接的ID 也可以称作为SessionID，ID全局唯一</span><br>    ConnID <span class="hljs-type">uint32</span><br>    <span class="hljs-comment">//当前连接的关闭状态</span><br>    isClosed <span class="hljs-type">bool</span><br>    <span class="hljs-comment">//消息管理MsgId和对应处理方法的消息管理模块</span><br>    MsgHandler ziface.IMsgHandle<br>    <span class="hljs-comment">//告知该链接已经退出/停止的channel</span><br>    ExitBuffChan <span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span><br>    <span class="hljs-comment">//无缓冲管道，用于读、写两个goroutine之间的消息通信</span><br>    msgChan        <span class="hljs-keyword">chan</span> []<span class="hljs-type">byte</span><br>&#125;<br><span class="hljs-comment">//创建连接的方法</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewConntion</span><span class="hljs-params">(conn *net.TCPConn, connID <span class="hljs-type">uint32</span>, msgHandler ziface.IMsgHandle)</span></span> *Connection&#123;<br>    c := &amp;Connection&#123;<br>        Conn:     conn,<br>        ConnID:   connID,<br>        isClosed: <span class="hljs-literal">false</span>,<br>        MsgHandler: msgHandler,<br>        ExitBuffChan: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span>, <span class="hljs-number">1</span>),<br>        msgChan:<span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> []<span class="hljs-type">byte</span>), <span class="hljs-comment">//msgChan初始化</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> c<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="2-创建-Writer-Goroutine"><a href="#2-创建-Writer-Goroutine" class="headerlink" title="2. 创建 Writer Goroutine"></a>2. 创建 Writer Goroutine</h3><blockquote>
<p>zinx/znet/connection.go</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/*</span><br><span class="hljs-comment">    写消息Goroutine， 用户将数据发送给客户端</span><br><span class="hljs-comment"> */</span><br> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Connection)</span></span> StartWriter() &#123;<br>    fmt.Println(<span class="hljs-string">&quot;[Writer Goroutine is running]&quot;</span>)<br>    <span class="hljs-keyword">defer</span> fmt.Println(c.RemoteAddr().String(), <span class="hljs-string">&quot;[conn Writer exit!]&quot;</span>)<br>     <span class="hljs-keyword">for</span> &#123;<br>         <span class="hljs-keyword">select</span> &#123;<br>             <span class="hljs-keyword">case</span> data := &lt;-c.msgChan:<br>                 <span class="hljs-comment">//有数据要写给客户端</span><br>                 <span class="hljs-keyword">if</span> _, err := c.Conn.Write(data); err != <span class="hljs-literal">nil</span> &#123;<br>                     fmt.Println(<span class="hljs-string">&quot;Send Data error:, &quot;</span>, err, <span class="hljs-string">&quot; Conn Writer exit&quot;</span>)<br>                     <span class="hljs-keyword">return</span><br>                &#125;<br>             <span class="hljs-keyword">case</span> &lt;- c.ExitBuffChan:<br>                 <span class="hljs-comment">//conn已经关闭</span><br>                 <span class="hljs-keyword">return</span><br>        &#125;<br>    &#125;<br> &#125;<br></code></pre></td></tr></table></figure>
<p>关于 for select 和 channel 的用法：</p>
<p>select 语句只能与通道联用，它一般由若干个分支组成。每次执行这种语句的时候，一般只有一个分支中的代码会被运行。select 语句的分支分为两种，一种叫做候选分支，另一种叫做默认分支。候选分支总是以关键字 case 开头，后跟一个 case 表达式和一个冒号，然后我们可以从下一行开始写入当分支被选中时需要执行的语句。</p>
<p>由于 select 语句是专为通道而设计的，所以每个 case 表达式中都只能包含操作通道的表达式，比如接收表达式。使用一个接收值可以接收通道里的值，使用两个接收值可以判断通道是否已经关闭了。</p>
<p>对于 select 语句的执行规则如下：</p>
<ul>
<li>每个 case 都必须是一个通信。</li>
<li>所有 Channel 表达式都会被求值。</li>
<li>所有被发送的表达式都会被求值。</li>
<li>如果任意某个通信可以进行，它就执行，其他被忽略。</li>
<li>如果有多个 case 都可以运行，Select 会随机公平地选出一个执行。其他不会执行。 否则：</li>
<li>如果有 default 子句，则执行该语句。</li>
<li>如果没有 default 子句，select 将阻塞，直到某个通信可以运行；Go 不会重新对 Channel 或值进行求值。</li>
</ul>
<p>注意这里是和 switch 的操作是不一样的，switch 操作中，只要从上到下有一个满足条件了，就会执行相应的那一个 case，select 中，我们是全部计算一遍，然后再从可满足条件的 case 中公平的执行其中一个。这是为了防止有些通道长期得不到执行。</p>
<h3 id="3-Reader-将发送客户端的数据改为发送至Channel"><a href="#3-Reader-将发送客户端的数据改为发送至Channel" class="headerlink" title="3. Reader 将发送客户端的数据改为发送至Channel"></a>3. Reader 将发送客户端的数据改为发送至Channel</h3><p>修改 Reader 调用的<code>SendMsg()</code>方法</p>
<blockquote>
<p>zinx/znet/connection.go</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">//直接将Message数据发送数据给远程的TCP客户端</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Connection)</span></span> SendMsg(msgId <span class="hljs-type">uint32</span>, data []<span class="hljs-type">byte</span>) <span class="hljs-type">error</span> &#123;<br>    <span class="hljs-keyword">if</span> c.isClosed == <span class="hljs-literal">true</span> &#123;<br>        <span class="hljs-keyword">return</span> errors.New(<span class="hljs-string">&quot;Connection closed when send msg&quot;</span>)<br>    &#125;<br>    <span class="hljs-comment">//将data封包，并且发送</span><br>    dp := NewDataPack()<br>    msg, err := dp.Pack(NewMsgPackage(msgId, data))<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        fmt.Println(<span class="hljs-string">&quot;Pack error msg id = &quot;</span>, msgId)<br>        <span class="hljs-keyword">return</span>  errors.New(<span class="hljs-string">&quot;Pack error msg &quot;</span>)<br>    &#125;<br>    <span class="hljs-comment">//写回客户端之前是写到客户端，现在是写到channel就可以</span><br>    c.msgChan &lt;- msg   <span class="hljs-comment">//将之前直接回写给conn.Write的方法 改为 发送给Channel 供Writer读取</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>修改<code>Start()</code>方法</p>
<blockquote>
<p>zinx/znet/connection.go</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">//启动连接，让当前连接开始工作</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Connection)</span></span> Start() &#123;<br>    <span class="hljs-comment">//1 开启用户从客户端读取数据流程的Goroutine</span><br>    <span class="hljs-keyword">go</span> c.StartReader()<br>    <span class="hljs-comment">//2 开启用于写回客户端数据流程的Goroutine</span><br>    <span class="hljs-keyword">go</span> c.StartWriter()<br>    <span class="hljs-keyword">for</span> &#123;<br>        <span class="hljs-keyword">select</span> &#123;<br>        <span class="hljs-keyword">case</span> &lt;- c.ExitBuffChan:<br>            <span class="hljs-comment">//得到退出消息，不再阻塞</span><br>            <span class="hljs-keyword">return</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="Zinx测试"><a href="#Zinx测试" class="headerlink" title="Zinx测试"></a>Zinx测试</h2><p>0.7版本的测试与0.6一致，因为只修改了内部消息发送的机制，<strong>对外的消息接口并没有发生变化</strong></p>
<h1 id="v0-8-实现工作池"><a href="#v0-8-实现工作池" class="headerlink" title="[v0.8] 实现工作池"></a>[v0.8] 实现工作池</h1><h2 id="功能-5"><a href="#功能-5" class="headerlink" title="功能"></a>功能</h2><p>给Zinx添加消息队列和多任务Worker机制。</p>
<p><img src="../../../images/Zinx/2df6505fac57bea709e363da21fcfa1d-0.png" alt="img"></p>
<blockquote>
<p><strong>知识点</strong></p>
<ol>
<li>消息队列</li>
<li>工作池</li>
</ol>
</blockquote>
<p>这一步我们要实现的是，可以通过 worker 的数量来限定处理业务的固定goroutine数量，而不是无限制的开辟Goroutine，随谈我们知道go的调度算法已经做的很极致了，但是大数量的Goroutine依然会带来一些不必要的环境切换成本，这些本应该是服务器应该节省掉的成本。我们可以用消息队列来缓冲worker工作的数据。</p>
<p>设计结构如下：</p>
<p><img src="../../../images/Zinx/6d0404ac69418597983083fd7ea27e89.jpeg" alt="img"></p>
<h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><h3 id="1-创建消息队列"><a href="#1-创建消息队列" class="headerlink" title="1. 创建消息队列"></a>1. 创建消息队列</h3><p>首先，处理消息队列的部分，我们应该集成到<code>MsgHandler</code>模块下，因为属于我们消息模块范畴内的。</p>
<blockquote>
<p>zinx/znet/msghandler.go</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> MsgHandle <span class="hljs-keyword">struct</span> &#123;<br>    Apis           <span class="hljs-keyword">map</span>[<span class="hljs-type">uint32</span>]ziface.IRouter  <span class="hljs-comment">//存放每个MsgId 所对应的处理方法的map属性</span><br>    WorkerPoolSize <span class="hljs-type">uint32</span>                     <span class="hljs-comment">//业务工作Worker池的数量</span><br>    TaskQueue      []<span class="hljs-keyword">chan</span> ziface.IRequest     <span class="hljs-comment">//Worker负责取任务的消息队列</span><br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewMsgHandle</span><span class="hljs-params">()</span></span> *MsgHandle &#123;<br>    <span class="hljs-keyword">return</span> &amp;MsgHandle&#123;<br>        Apis: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">uint32</span>]ziface.IRouter),<br>        WorkerPoolSize:utils.GlobalObject.WorkerPoolSize,<br>        <span class="hljs-comment">//一个worker对应一个queue</span><br>        TaskQueue:<span class="hljs-built_in">make</span>([]<span class="hljs-keyword">chan</span> ziface.IRequest, utils.GlobalObject.WorkerPoolSize),<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>这里添加两个成员:</p>
<ul>
<li><code>WokerPoolSize</code>:作为工作池的数量，因为 TaskQueue 中的每个队列应该是和一个 Worker 对应的，所以我们在创建 TaskQueue 中队列数量要和 Worker 的数量一致。</li>
<li><code>TaskQueue</code>真是一个 Request 请求信息的 channel 集合。用来缓冲提供 worker 调用的 Request 请求信息，worker 会从对应的队列中获取客户端的请求数据并且处理掉。</li>
</ul>
<p>当然<code>WorkerPoolSize</code>最好也可以从<code>GlobalObject</code>获取，并且<code>zinx.json</code>配置文件可以手动配置。</p>
<blockquote>
<p>zinx/utils/globalobj.go</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/*</span><br><span class="hljs-comment">    存储一切有关Zinx框架的全局参数，供其他模块使用</span><br><span class="hljs-comment">    一些参数也可以通过 用户根据 zinx.json来配置</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">type</span> GlobalObj <span class="hljs-keyword">struct</span> &#123;<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">        Server</span><br><span class="hljs-comment">    */</span><br>    TcpServer ziface.IServer <span class="hljs-comment">//当前Zinx的全局Server对象</span><br>    Host      <span class="hljs-type">string</span>         <span class="hljs-comment">//当前服务器主机IP</span><br>    TcpPort   <span class="hljs-type">int</span>            <span class="hljs-comment">//当前服务器主机监听端口号</span><br>    Name      <span class="hljs-type">string</span>         <span class="hljs-comment">//当前服务器名称</span><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">        Zinx</span><br><span class="hljs-comment">    */</span><br>    Version          <span class="hljs-type">string</span> <span class="hljs-comment">//当前Zinx版本号</span><br>    MaxPacketSize    <span class="hljs-type">uint32</span> <span class="hljs-comment">//都需数据包的最大值</span><br>    MaxConn          <span class="hljs-type">int</span>    <span class="hljs-comment">//当前服务器主机允许的最大链接个数</span><br>    WorkerPoolSize   <span class="hljs-type">uint32</span> <span class="hljs-comment">//业务工作Worker池的数量</span><br>    MaxWorkerTaskLen <span class="hljs-type">uint32</span> <span class="hljs-comment">//业务工作Worker对应负责的任务队列最大任务存储数量</span><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">        config file path</span><br><span class="hljs-comment">    */</span><br>    ConfFilePath <span class="hljs-type">string</span><br>&#125;<br><span class="hljs-comment">//...</span><br><span class="hljs-comment">//...</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">    提供init方法，默认加载</span><br><span class="hljs-comment">*/</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-comment">//初始化GlobalObject变量，设置一些默认值</span><br>    GlobalObject = &amp;GlobalObj&#123;<br>        Name:          <span class="hljs-string">&quot;ZinxServerApp&quot;</span>,<br>        Version:       <span class="hljs-string">&quot;V0.4&quot;</span>,<br>        TcpPort:       <span class="hljs-number">7777</span>,<br>        Host:          <span class="hljs-string">&quot;0.0.0.0&quot;</span>,<br>        MaxConn:       <span class="hljs-number">12000</span>,<br>        MaxPacketSize: <span class="hljs-number">4096</span>,<br>        ConfFilePath:  <span class="hljs-string">&quot;conf/zinx.json&quot;</span>,<br>        WorkerPoolSize: <span class="hljs-number">10</span>,<br>        MaxWorkerTaskLen: <span class="hljs-number">1024</span>,<br>    &#125;<br>    <span class="hljs-comment">//从配置文件中加载一些用户配置的参数</span><br>    GlobalObject.Reload()<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="2-创建及启动Worker工作池"><a href="#2-创建及启动Worker工作池" class="headerlink" title="2. 创建及启动Worker工作池"></a>2. 创建及启动Worker工作池</h3><p>现在添加 Worker 工作池，先定义一些启动工作池的接口。</p>
<blockquote>
<p>zinx/ziface/imsghandler.go</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/*</span><br><span class="hljs-comment">    消息管理抽象层</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">type</span> IMsgHandle <span class="hljs-keyword">interface</span>&#123;<br>    DoMsgHandler(request IRequest)            <span class="hljs-comment">//马上以非阻塞方式处理消息</span><br>    AddRouter(msgId <span class="hljs-type">uint32</span>, router IRouter)    <span class="hljs-comment">//为消息添加具体的处理逻辑</span><br>    StartWorkerPool()                        <span class="hljs-comment">//启动worker工作池</span><br>    SendMsgToTaskQueue(request IRequest)    <span class="hljs-comment">//将消息交给TaskQueue,由worker进行处理</span><br>&#125;<br></code></pre></td></tr></table></figure>
<blockquote>
<p>zinx/znet/msghandler.go</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// 注意，头文件中要引入 zinx/utils</span><br><span class="hljs-comment">//启动一个Worker工作流程</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(mh *MsgHandle)</span></span> StartOneWorker(workerID <span class="hljs-type">int</span>, taskQueue <span class="hljs-keyword">chan</span> ziface.IRequest) &#123;<br>    fmt.Println(<span class="hljs-string">&quot;Worker ID = &quot;</span>, workerID, <span class="hljs-string">&quot; is started.&quot;</span>)<br>    <span class="hljs-comment">//不断的等待队列中的消息</span><br>    <span class="hljs-keyword">for</span> &#123;<br>        <span class="hljs-keyword">select</span> &#123;<br>            <span class="hljs-comment">//有消息则取出队列的Request，并执行绑定的业务方法</span><br>            <span class="hljs-keyword">case</span> request := &lt;-taskQueue:<br>                mh.DoMsgHandler(request)<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-comment">//启动worker工作池</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(mh *MsgHandle)</span></span> StartWorkerPool() &#123;<br>    <span class="hljs-comment">//遍历需要启动worker的数量，依此启动</span><br>    <span class="hljs-keyword">for</span> i:= <span class="hljs-number">0</span>; i &lt; <span class="hljs-type">int</span>(mh.WorkerPoolSize); i++ &#123;<br>        <span class="hljs-comment">//一个worker被启动</span><br>        <span class="hljs-comment">//给当前worker对应的任务队列开辟空间</span><br>        mh.TaskQueue[i] = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> ziface.IRequest, utils.GlobalObject.MaxWorkerTaskLen)<br>        <span class="hljs-comment">//启动当前Worker，阻塞的等待对应的任务队列是否有消息传递进来</span><br>        <span class="hljs-keyword">go</span> mh.StartOneWorker(i, mh.TaskQueue[i])<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><code>StartWorkerPool()</code>方法是启动 Worker 工作池，这里根据用户配置好的<code>WorkerPoolSize</code>的数量来启动，然后分别给每个 Worker 分配一个<code>TaskQueue</code>，然后用一个 goroutine 来承载一个 Worker 的工作业务。</p>
<p><code>StartOneWorker()</code>方法就是一个 Worker 的工作业务，每个 worker 是不会退出的(目前没有设定 worker 的停止工作机制)，会永久的从对应的 TaskQueue 中等待消息，并处理。</p>
<h3 id="3-发送消息给消息队列"><a href="#3-发送消息给消息队列" class="headerlink" title="3. 发送消息给消息队列"></a>3. 发送消息给消息队列</h3><p>现在，worker 工作池已经准备就绪了，那么就需要有一个给到 worker 工作池消息的入口，我们再定义一个方法</p>
<blockquote>
<p>zinx/znet/msghandler.go</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">//将消息交给TaskQueue,由worker进行处理</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(mh *MsgHandle)</span></span>SendMsgToTaskQueue(request ziface.IRequest) &#123;<br>    <span class="hljs-comment">//根据ConnID来分配当前的连接应该由哪个worker负责处理</span><br>    <span class="hljs-comment">//轮询的平均分配法则</span><br>    <span class="hljs-comment">//得到需要处理此条连接的workerID</span><br>    workerID := request.GetConnection().GetConnID() % mh.WorkerPoolSize<br>    fmt.Println(<span class="hljs-string">&quot;Add ConnID=&quot;</span>, request.GetConnection().GetConnID(),<span class="hljs-string">&quot; request msgID=&quot;</span>, request.GetMsgID(), <span class="hljs-string">&quot;to workerID=&quot;</span>, workerID)<br>    <span class="hljs-comment">//将请求消息发送给任务队列</span><br>    mh.TaskQueue[workerID] &lt;- request<br>&#125;<br></code></pre></td></tr></table></figure>
<p><code>SendMsgToTaskQueue()</code>作为工作池的数据入口，这里面采用的是轮询的分配机制，因为不同链接信息都会调用这个入口，那么到底应该由哪个 worker 处理该链接的请求处理，整理用的是一个简单的求模运算。用余数和 workerID 的匹配来进行分配。</p>
<p>最终将 request 请求数据发送给对应 worker 的 TaskQueue，那么对应的 worker 的 Goroutine 就会处理该链接请求了。</p>
<h3 id="4-工作池代码调用"><a href="#4-工作池代码调用" class="headerlink" title="4. 工作池代码调用"></a>4. 工作池代码调用</h3><p>好了，现在需要将消息队列和多任务 worker 机制集成到我们 Zinx 的中了。我们在 Server 的<code>Start()</code>方法中，在服务端 Accept 之前，启动 Worker 工作池。</p>
<blockquote>
<p>zinx/znet/server.go</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">//开启网络服务,只需要修改这里所提到的部分，对于打了 //... 的部分的意思是原来的代码不需要做修改</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Server)</span></span> Start() &#123;<br>    <span class="hljs-comment">//...</span><br>    <span class="hljs-comment">//开启一个go去做服务端Linster业务</span><br>    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>        <span class="hljs-comment">//0 启动worker工作池机制</span><br>        s.msgHandler.StartWorkerPool()<br>        <span class="hljs-comment">//1 获取一个TCP的Addr</span><br>        addr, err := net.ResolveTCPAddr(s.IPVersion, fmt.Sprintf(<span class="hljs-string">&quot;%s:%d&quot;</span>, s.IP, s.Port))<br>        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>            fmt.Println(<span class="hljs-string">&quot;resolve tcp addr err: &quot;</span>, err)<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        <span class="hljs-comment">//...</span><br>        <span class="hljs-comment">//...</span><br>        &#125;<br>    &#125;()<br>&#125;<br></code></pre></td></tr></table></figure>
<p>其次，当我们已经得到客户端的连接请求过来数据的时候，我们应该将数据发送给 Worker 工作池进行处理。</p>
<p>所以应该在 Connection 的<code>StartReader()</code>方法中修改：</p>
<blockquote>
<p>zinx/znet/connection.go</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// 注意，头文件中要引入 zinx/utils</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">    读消息Goroutine，用于从客户端中读取数据</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Connection)</span></span> StartReader() &#123;<br>    fmt.Println(<span class="hljs-string">&quot;Reader Goroutine is  running&quot;</span>)<br>    <span class="hljs-keyword">defer</span> fmt.Println(c.RemoteAddr().String(), <span class="hljs-string">&quot; conn reader exit!&quot;</span>)<br>    <span class="hljs-keyword">defer</span> c.Stop()<br>    <span class="hljs-keyword">for</span>  &#123;<br>        <span class="hljs-comment">//...</span><br>        req := Request&#123;<br>            conn:c,<br>            msg:msg,<br>        &#125;<br>        <span class="hljs-keyword">if</span> utils.GlobalObject.WorkerPoolSize &gt; <span class="hljs-number">0</span> &#123;<br>            <span class="hljs-comment">//已经启动工作池机制，将消息交给Worker处理</span><br>            c.MsgHandler.SendMsgToTaskQueue(&amp;req)<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">//从绑定好的消息和对应的处理方法中执行对应的Handle方法</span><br>            <span class="hljs-keyword">go</span> c.MsgHandler.DoMsgHandler(&amp;req)<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>这里并没有强制使用多任务 Worker 机制，而是判断用户配置<code>WorkerPoolSize</code>的个数，如果大于 0，那么我就启动多任务机制处理链接请求消息，如果=0 或者&lt;0 那么，我们依然只是之前的开启一个临时的 Goroutine 处理客户端请求消息。</p>
<h1 id="v0-9-实现链接控制"><a href="#v0-9-实现链接控制" class="headerlink" title="[v0.9] 实现链接控制"></a>[v0.9] 实现链接控制</h1><h2 id="功能-6"><a href="#功能-6" class="headerlink" title="功能"></a>功能</h2><p><img src="../../../images/Zinx/4f22d83440b9a7d22dbac2d076cbf574-0.png" alt="img"></p>
<blockquote>
<p><strong>知识点</strong></p>
<ol>
<li>链接管理</li>
<li>数量限制</li>
</ol>
</blockquote>
<h2 id="步骤-1"><a href="#步骤-1" class="headerlink" title="步骤"></a>步骤</h2></article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Go/">Go</a><a class="post-meta__tags" href="/tags/%E5%AE%9E%E9%AA%8C%E6%A5%BC/">实验楼</a><a class="post-meta__tags" href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8/">服务器</a><a class="post-meta__tags" href="/tags/Zinx/">Zinx</a></div><div class="post_share"><div class="social-share" data-image="https://tvax3.sinaimg.cn/large/0072YHp3ly1gjvw20n7otj31hc0zdgxz.jpg" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/aa7a6db9"><img class="prev-cover" src="https://tvax3.sinaimg.cn/large/0072YHp3ly1gjvw20n7otj31hc0zdgxz.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Go学习笔记（实验楼）</div></div></a></div><div class="next-post pull-right"><a href="/posts/cd58c827"><img class="next-cover" src="https://tvax3.sinaimg.cn/large/0072YHp3ly1gjvw20n7otj31hc0zdgxz.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">迭代（顿开）</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/8cb5320c" title="力扣高效算法入门"><img class="cover" src="/../../../images/EasyAlgorithm/image-20220108233318575.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-27</div><div class="title">力扣高效算法入门</div></div></a></div><div><a href="/posts/aa7a6db9" title="Go学习笔记（实验楼）"><img class="cover" src="https://tvax3.sinaimg.cn/large/0072YHp3ly1gjvw20n7otj31hc0zdgxz.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-27</div><div class="title">Go学习笔记（实验楼）</div></div></a></div><div><a href="/posts/206c9e3b" title="力扣每日一题"><img class="cover" src="https://tvax3.sinaimg.cn/large/0072YHp3ly1gjvw20n7otj31hc0zdgxz.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-27</div><div class="title">力扣每日一题</div></div></a></div><div><a href="/posts/24feca74" title="Go_hard_Algorithm"><img class="cover" src="/../../../images/EasyAlgorithm/image-20220108233318575.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-27</div><div class="title">Go_hard_Algorithm</div></div></a></div><div><a href="/posts/a0a70754" title="Go_Easy_Algorithm"><img class="cover" src="/../../../images/EasyAlgorithm/image-20220108233318575.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-27</div><div class="title">Go_Easy_Algorithm</div></div></a></div><div><a href="/posts/85980731" title="(Golang)链表学习记录"><img class="cover" src="https://tvax3.sinaimg.cn/large/0072YHp3ly1gjvw20n7otj31hc0zdgxz.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-27</div><div class="title">(Golang)链表学习记录</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/../../../images/icon.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">mingming.shi</div><div class="author-info__description">信仰就是力量</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">200</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">107</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">65</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://gitee.com/fole-del"><i class="fab fa-github"></i><span>一些小Demo~</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="mailto:191099862@qq.com" target="_blank" title="Email"><i class="iconfont icon-Email"></i></a><a class="social-icon" href="https://tva3.sinaimg.cn/large/0072YHp3ly1gjtbxnamacj30e80e8dgx.jpg" target="_blank" title="weixin"><i class="iconfont icon-weixin"></i></a><a class="social-icon" href="http://wpa.qq.com/msgrd?v=3&amp;uin=191099862&amp;site=qq&amp;menu=yes" target="_blank" title="QQ"><i class="iconfont icon-QQ1"></i></a><a class="social-icon" href="https://blog.csdn.net/Fuel_Ming?spm=1001.2014.3001.5113" target="_blank" title="CSDN"><i class="iconfont icon-csdn"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content"><div id="balls"><div>固执无<span style="background:white;border-radius:25px;color:black">罪</span>❗❗❗</div><div class="snake-spinner"><span></span><span></span><span></span><span></span><span></span></div><div><span style="background:white;border-radius:25px;color:black">梦</span>想有价🌈🌈🌈</div></div><div class="twopeople"><div class="twopeople"><div class="container"style="height:200px;"><canvas class="illo"width="800"height="800"style="max-width:200px; max-height:200px; touch-action:none; width:640px; height:640px;"></canvas></div><script src="https://cdn.guole.fun/js/twopeople1.js"></script><script src="https://cdn.guole.fun/js/zdog.dist.js"></script><script id="rendered-js"src="https://cdn.guole.fun/js/twopeople.js"></script><style>.twopeople{margin:0;align-items:center;justify-content:center;text-align:center}canvas{display:block;margin:0 auto;cursor:move}</style></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Zinx%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.</span> <span class="toc-text">Zinx架构设计</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AF%B7%E6%B1%82%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%93%8D%E5%BA%94%E7%9A%84%E8%BF%87%E7%A8%8B"><span class="toc-number">1.1.</span> <span class="toc-text">客户端请求服务器响应的过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Zinx%E5%8A%9F%E8%83%BD%E6%A8%A1%E5%9D%97"><span class="toc-number">1.2.</span> <span class="toc-text">Zinx功能模块</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#v0-1"><span class="toc-number">2.</span> <span class="toc-text">v0.1</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#iserver-go"><span class="toc-number">2.1.</span> <span class="toc-text">iserver.go</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#server-go"><span class="toc-number">2.2.</span> <span class="toc-text">server.go *</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#server-test-go"><span class="toc-number">2.3.</span> <span class="toc-text">server_test.go</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#v0-2-%E5%AE%9E%E7%8E%B0%E9%93%BE%E6%8E%A5%E5%B0%81%E8%A3%85%E4%B8%9A%E5%8A%A1%E4%B8%8E%E4%B8%9A%E5%8A%A1%E7%BB%91%E5%AE%9A"><span class="toc-number">3.</span> <span class="toc-text">[v0.2] 实现链接封装业务与业务绑定</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84"><span class="toc-number">3.1.</span> <span class="toc-text">文件结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81"><span class="toc-number">3.2.</span> <span class="toc-text">代码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#iconnection-go"><span class="toc-number">3.2.1.</span> <span class="toc-text">iconnection.go</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#connection-go"><span class="toc-number">3.2.2.</span> <span class="toc-text">connection.go</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#server-go-%E4%BB%A3%E7%A0%81%E4%BF%AE%E6%94%B9"><span class="toc-number">3.2.3.</span> <span class="toc-text">server.go 代码修改</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#v0-3-%E5%AE%9E%E7%8E%B0%E5%9F%BA%E7%A1%80%E8%B7%AF%E7%94%B1%E6%A8%A1%E5%9D%97"><span class="toc-number">4.</span> <span class="toc-text">[v0.3] 实现基础路由模块</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD"><span class="toc-number">4.1.</span> <span class="toc-text">功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="toc-number">4.2.</span> <span class="toc-text">目录结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IRequest%E6%B6%88%E6%81%AF%E8%AF%B7%E6%B1%82%E6%8A%BD%E8%B1%A1%E7%B1%BB"><span class="toc-number">4.3.</span> <span class="toc-text">IRequest消息请求抽象类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IRouter%E8%B7%AF%E7%94%B1%E9%85%8D%E7%BD%AE%E6%8A%BD%E8%B1%A1%E7%B1%BB"><span class="toc-number">4.4.</span> <span class="toc-text">IRouter路由配置抽象类*</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IServer%E5%A2%9E%E6%B7%BB%E8%B7%AF%E7%94%B1%E6%B7%BB%E5%8A%A0%E5%8A%9F%E8%83%BD"><span class="toc-number">4.5.</span> <span class="toc-text">IServer增添路由添加功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#server%E7%B1%BB"><span class="toc-number">4.5.1.</span> <span class="toc-text">server类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Connection%E7%B1%BB"><span class="toc-number">4.5.2.</span> <span class="toc-text">Connection类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AddRouter"><span class="toc-number">4.5.3.</span> <span class="toc-text">AddRouter</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">4.6.</span> <span class="toc-text">测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Server-go"><span class="toc-number">4.6.1.</span> <span class="toc-text">Server.go</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Client-go"><span class="toc-number">4.6.2.</span> <span class="toc-text">Client.go</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#v0-4-%E5%85%A8%E5%B1%80%E9%85%8D%E7%BD%AE%E6%A8%A1%E5%9D%97"><span class="toc-number">5.</span> <span class="toc-text">[v0.4] 全局配置模块</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD-1"><span class="toc-number">5.1.</span> <span class="toc-text">功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">5.2.</span> <span class="toc-text">配置文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#globalobj-go"><span class="toc-number">5.3.</span> <span class="toc-text">globalobj.go</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#V0-5-%E6%B6%88%E6%81%AF%E5%B0%81%E8%A3%85"><span class="toc-number">6.</span> <span class="toc-text">[V0.5] 消息封装</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD-2"><span class="toc-number">6.1.</span> <span class="toc-text">功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%B6%88%E6%81%AF%E5%B0%81%E8%A3%85%E7%B1%BB%E5%9E%8B"><span class="toc-number">6.2.</span> <span class="toc-text">创建消息封装类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#imessage-go"><span class="toc-number">6.3.</span> <span class="toc-text">imessage.go</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#message-go"><span class="toc-number">6.4.</span> <span class="toc-text">message.go</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%86%E5%8C%85%E4%B8%8E%E5%B0%81%E5%8C%85"><span class="toc-number">6.5.</span> <span class="toc-text">拆包与封包*</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%8B%86%E5%8C%85%E5%B0%81%E5%8C%85%E6%8A%BD%E8%B1%A1%E7%B1%BB"><span class="toc-number">6.5.1.</span> <span class="toc-text">创建拆包封包抽象类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%8B%86%E5%8C%85%E5%B0%81%E5%8C%85%E7%B1%BB"><span class="toc-number">6.5.2.</span> <span class="toc-text">实现拆包封包类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E6%8B%86%E5%8C%85%E4%B8%8E%E5%B0%81%E5%8C%85%E7%B1%BB%E5%9E%8B"><span class="toc-number">6.5.3.</span> <span class="toc-text">测试拆包与封包类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Request%E5%AD%97%E6%AE%B5%E4%BF%AE%E6%94%B9"><span class="toc-number">6.5.4.</span> <span class="toc-text">Request字段修改</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E6%88%90%E6%8B%86%E5%8C%85%E8%BF%87%E7%A8%8B"><span class="toc-number">6.5.4.1.</span> <span class="toc-text">集成拆包过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%90%E4%BE%9B%E5%B0%81%E5%8C%85%E6%96%B9%E6%B3%95"><span class="toc-number">6.5.4.2.</span> <span class="toc-text">提供封包方法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#zinx-0-5-%E6%B5%8B%E8%AF%95"><span class="toc-number">6.5.5.</span> <span class="toc-text">zinx 0.5 测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#v0-6-%E5%A4%9A%E8%B7%AF%E7%94%B1%E6%A8%A1%E5%BC%8F"><span class="toc-number">7.</span> <span class="toc-text">[v0.6] 多路由模式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD-3"><span class="toc-number">7.1.</span> <span class="toc-text">功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%B6%88%E6%81%AF%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97"><span class="toc-number">7.2.</span> <span class="toc-text">创建消息管理模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#zinx%E6%B5%8B%E8%AF%95"><span class="toc-number">7.3.</span> <span class="toc-text">zinx测试</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#v0-7-%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB"><span class="toc-number">8.</span> <span class="toc-text">[v0.7] 读写分离</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD-4"><span class="toc-number">8.1.</span> <span class="toc-text">功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-number">8.2.</span> <span class="toc-text">准备工作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%B7%BB%E5%8A%A0%E8%AF%BB%E5%86%99%E6%A8%A1%E5%9D%97%E4%BA%A4%E4%BA%92%E6%95%B0%E6%8D%AE%E7%9A%84%E7%AE%A1%E9%81%93"><span class="toc-number">8.2.1.</span> <span class="toc-text">1. 添加读写模块交互数据的管道</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%88%9B%E5%BB%BA-Writer-Goroutine"><span class="toc-number">8.2.2.</span> <span class="toc-text">2. 创建 Writer Goroutine</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Reader-%E5%B0%86%E5%8F%91%E9%80%81%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9A%84%E6%95%B0%E6%8D%AE%E6%94%B9%E4%B8%BA%E5%8F%91%E9%80%81%E8%87%B3Channel"><span class="toc-number">8.2.3.</span> <span class="toc-text">3. Reader 将发送客户端的数据改为发送至Channel</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Zinx%E6%B5%8B%E8%AF%95"><span class="toc-number">8.3.</span> <span class="toc-text">Zinx测试</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#v0-8-%E5%AE%9E%E7%8E%B0%E5%B7%A5%E4%BD%9C%E6%B1%A0"><span class="toc-number">9.</span> <span class="toc-text">[v0.8] 实现工作池</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD-5"><span class="toc-number">9.1.</span> <span class="toc-text">功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4"><span class="toc-number">9.2.</span> <span class="toc-text">步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%88%9B%E5%BB%BA%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-number">9.2.1.</span> <span class="toc-text">1. 创建消息队列</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%88%9B%E5%BB%BA%E5%8F%8A%E5%90%AF%E5%8A%A8Worker%E5%B7%A5%E4%BD%9C%E6%B1%A0"><span class="toc-number">9.2.2.</span> <span class="toc-text">2. 创建及启动Worker工作池</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF%E7%BB%99%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-number">9.2.3.</span> <span class="toc-text">3. 发送消息给消息队列</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%B7%A5%E4%BD%9C%E6%B1%A0%E4%BB%A3%E7%A0%81%E8%B0%83%E7%94%A8"><span class="toc-number">9.2.4.</span> <span class="toc-text">4. 工作池代码调用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#v0-9-%E5%AE%9E%E7%8E%B0%E9%93%BE%E6%8E%A5%E6%8E%A7%E5%88%B6"><span class="toc-number">10.</span> <span class="toc-text">[v0.9] 实现链接控制</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD-6"><span class="toc-number">10.1.</span> <span class="toc-text">功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4-1"><span class="toc-number">10.2.</span> <span class="toc-text">步骤</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/252a5848" title="痕迹"><img src="/../../../../images/%E8%87%AA%E8%BF%B0/%E6%83%85%E6%84%9F8.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="痕迹"/></a><div class="content"><a class="title" href="/posts/252a5848" title="痕迹">痕迹</a><time datetime="2022-12-28T03:42:45.570Z" title="更新于 2022-12-28 11:42:45">2022-12-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/f2745b45" title="我|❤️"><img src="https://cdn.jsdelivr.net/gh/fole-del/img/20210403154845.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="我|❤️"/></a><div class="content"><a class="title" href="/posts/f2745b45" title="我|❤️">我|❤️</a><time datetime="2022-12-28T03:40:16.309Z" title="更新于 2022-12-28 11:40:16">2022-12-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/64d12821" title="C++面试基本知识点（1）"><img src="https://cdn.jsdelivr.net/gh/fole-del/img@9fb4182529fe80d2c8d24d32344e760191ba3b45/2020/10/24/bc30952f07330a84a0d01ee93938fa2f.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="C++面试基本知识点（1）"/></a><div class="content"><a class="title" href="/posts/64d12821" title="C++面试基本知识点（1）">C++面试基本知识点（1）</a><time datetime="2022-12-27T09:41:45.579Z" title="更新于 2022-12-27 17:41:45">2022-12-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/364ea8cc" title="设计模式"><img src="http://tva3.sinaimg.cn/large/0072YHp3ly1gjlroak9grj30yg0kiq4q.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="设计模式"/></a><div class="content"><a class="title" href="/posts/364ea8cc" title="设计模式">设计模式</a><time datetime="2022-12-27T07:05:52.457Z" title="更新于 2022-12-27 15:05:52">2022-12-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/69f2f423" title="设计模式之行为型模式"><img src="https://tvax3.sinaimg.cn/large/0072YHp3ly1gjvw20n7otj31hc0zdgxz.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="设计模式之行为型模式"/></a><div class="content"><a class="title" href="/posts/69f2f423" title="设计模式之行为型模式">设计模式之行为型模式</a><time datetime="2022-12-27T07:04:20.962Z" title="更新于 2022-12-27 15:04:20">2022-12-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/3dfd8b5b" title="设计模式之创建型模式"><img src="https://img.shields.io/badge/-创建型模式-blueciolet" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="设计模式之创建型模式"/></a><div class="content"><a class="title" href="/posts/3dfd8b5b" title="设计模式之创建型模式">设计模式之创建型模式</a><time datetime="2022-12-27T07:02:00.440Z" title="更新于 2022-12-27 15:02:00">2022-12-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/3a70d3a5" title="Windows右键添加Windows Terminal"><img src="http://tva1.sinaimg.cn/large/0072YHp3ly1gjmabib19zj30g108cq2z.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Windows右键添加Windows Terminal"/></a><div class="content"><a class="title" href="/posts/3a70d3a5" title="Windows右键添加Windows Terminal">Windows右键添加Windows Terminal</a><time datetime="2022-12-27T06:59:33.486Z" title="更新于 2022-12-27 14:59:33">2022-12-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/db382da4" title="Windows壁纸软件推荐"><img src="https://tva4.sinaimg.cn/large/0072YHp3ly1gjvw1yzkafj343c2awnph.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Windows壁纸软件推荐"/></a><div class="content"><a class="title" href="/posts/db382da4" title="Windows壁纸软件推荐">Windows壁纸软件推荐</a><time datetime="2022-12-27T06:58:43.008Z" title="更新于 2022-12-27 14:58:43">2022-12-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/d8fac1ab" title="Windows不常用快捷键合集"><img src="https://cdn.jsdelivr.net/gh/piccdn/cdn2@3079bcdf52942591ecb0eeb9ead1a406be5fda53/2020/10/11/a151ba57d295ca5d8e57a61645ac0358.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Windows不常用快捷键合集"/></a><div class="content"><a class="title" href="/posts/d8fac1ab" title="Windows不常用快捷键合集">Windows不常用快捷键合集</a><time datetime="2022-12-27T06:57:36.946Z" title="更新于 2022-12-27 14:57:36">2022-12-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/c8319666" title="hexo特殊符号使用"><img src="https://img.shields.io/badge/-Hexo-black" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="hexo特殊符号使用"/></a><div class="content"><a class="title" href="/posts/c8319666" title="hexo特殊符号使用">hexo特殊符号使用</a><time datetime="2022-12-27T06:55:59.181Z" title="更新于 2022-12-27 14:55:59">2022-12-27</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By mingming.shi</div><div class="footer_custom_text"><div id="mouseMove">&nbsp;</div><i class="fa fa-grav" aria-hidden="true"></i>勇敢就是接受发生在你身上的事，并把它尽力做到最好！<br> Power By <a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/" style="animation:bgbreath 4s infinite;">Hexo</a> | 主题 <a target="_blank" rel="noopener" href="https://butterfly.js.org/" style="animation:bgbreath 4s infinite;">butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="聊天"><i class="fas fa-sms"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? '' : ''

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script></div><canvas id="universe"></canvas><script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11"></script><script src="https://cdn.jsdelivr.net/gh/TRHX/CDN-for-itrhx.com@3.0.8/js/instantclick-1.2.2.js" type="module"></script><script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.min.js"></script><script src="https://myhkw.cn/player/js/player.js" id="myhk" key="160318399252" m="0"></script><script defer src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/zdoj.js"></script><script src="/js/twoPeople.js"></script><script src="/js/twoPeople1.js"></script><script src="/js/qipao.js"></script><script src="/js/universe.js"></script><script src="/js/mouseMove.js"></script><script defer src="https://use.fontawesome.com/releases/v5.11.2/js/all.js"></script><script defer src="https://use.fontawesome.com/releases/v5.11.2/js/v4-shims.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --><script async src="//at.alicdn.com/t/font_2032782_8d5kxvn09md.js"></script><!-- hexo injector body_end end --></body></html>