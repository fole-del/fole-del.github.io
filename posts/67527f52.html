<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Zinx | æ¬§æ©æ„</title><meta name="author" content="mingming.shi"><meta name="copyright" content="mingming.shi"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="å¹¶å‘æœåŠ¡å™¨çš„å®ç°"><link rel="shortcut icon" href="/../../../images/icon.jpg"><link rel="canonical" href="https://fole-del.github.io/posts/67527f52"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"ç¹","msgToSimplifiedChinese":"ç®€"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'å¤©',
  date_suffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"ä½ å·²åˆ‡æ¢ä¸ºç¹ä½“","cht_to_chs":"ä½ å·²åˆ‡æ¢ä¸ºç®€ä½“","day_to_night":"ä½ å·²åˆ‡æ¢ä¸ºæ·±è‰²æ¨¡å¼ğŸŒ™ğŸŒ™","night_to_day":"ä½ å·²åˆ‡æ¢ä¸ºæµ…è‰²æ¨¡å¼ğŸŒğŸŒ","bgLight":"#49b1f5","bgDark":"#121212","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Zinx',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-12-27 11:12:54'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/hbe.style.css"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="/css/var.css"><link rel="stylesheet" href="/css/background.css"><link rel="stylesheet" href="/css/taglink.css"><link rel="stylesheet" href="/css/hideCategory.css"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/code.css"><link rel="stylesheet" href="/css/buttons.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/font-awesome.css"><link rel="stylesheet" href="/css/title.css"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.2/css/all.css"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.2/css/v4-shims.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sviptzk/StaticFile_HEXO@latest/butterfly/css/font-awesome-animation.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/l-lin/font-awesome-animation/dist/font-awesome-animation.min.css"  media="defer" onload="this.media='all'"><link href="https://.googleapis.com/css2?family=Noto+Serif+SC:wght@400;900&display=swap" rel="stylesheet" media="print" onload="this.media='all'"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.1"><link rel="alternate" href="/atom.xml" title="æ¬§æ©æ„" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/../../../images/icon.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">200</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">107</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">65</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/ming/"><i class="fa-fw fa-fw fas fa-desktop faa-vertical animated-hover"></i><span> ä¸»é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa-fw fas fa-home faa-vertical animated-hover"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-book faa-pulse animated-hover"></i><span> æ‰¾æ–‡ç« </span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-archive faa-tada animated-hover"></i><span> æ—¶é—´</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags faa-tada animated-hover"></i><span> æ ‡ç­¾</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-folder-open faa-tada animated-hover"></i><span> åˆ†ç±»</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat faa-pulse animated-hover"></i><span> æ¸…å•</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fa fa-music"></i><span> éŸ³ä¹</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fa fa-picture-o"></i><span> ç…§ç‰‡</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fa fa-film"></i><span> ç”µå½±</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-flask faa-vertical animated-hover"></i><span> çš®ä¸€ä¸‹</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/test/demo"><i class="fa-fw fa fa-thermometer-empty faa-vertical animated-hover"></i><span> æµ‹è¯•</span></a></li><li><a class="site-page child" href="/player/"><i class="fa-fw fa fa-play-circle"></i><span> æ’­æ”¾å™¨</span></a></li><li><a class="site-page child" href="/happy-new-year/"><i class="fa-fw fa fa-wheelchair-alt"></i><span> HappyNewYear</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart faa-vertical animated-hover"></i><span> å…³äº</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-link faa-tada animated-hover"></i><span> ç•™è¨€æ¿</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://tvax3.sinaimg.cn/large/0072YHp3ly1gjvw20n7otj31hc0zdgxz.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">æ¬§æ©æ„</a></span><div id="menus"><button id="darkmodebutton" type="button" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><a class="site-page social-icon search"><i class="fas fa-adjust fa-fw"></i></a></button><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> æœç´¢</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/ming/"><i class="fa-fw fa-fw fas fa-desktop faa-vertical animated-hover"></i><span> ä¸»é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa-fw fas fa-home faa-vertical animated-hover"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-book faa-pulse animated-hover"></i><span> æ‰¾æ–‡ç« </span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-archive faa-tada animated-hover"></i><span> æ—¶é—´</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags faa-tada animated-hover"></i><span> æ ‡ç­¾</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-folder-open faa-tada animated-hover"></i><span> åˆ†ç±»</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat faa-pulse animated-hover"></i><span> æ¸…å•</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fa fa-music"></i><span> éŸ³ä¹</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fa fa-picture-o"></i><span> ç…§ç‰‡</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fa fa-film"></i><span> ç”µå½±</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-flask faa-vertical animated-hover"></i><span> çš®ä¸€ä¸‹</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/test/demo"><i class="fa-fw fa fa-thermometer-empty faa-vertical animated-hover"></i><span> æµ‹è¯•</span></a></li><li><a class="site-page child" href="/player/"><i class="fa-fw fa fa-play-circle"></i><span> æ’­æ”¾å™¨</span></a></li><li><a class="site-page child" href="/happy-new-year/"><i class="fa-fw fa fa-wheelchair-alt"></i><span> HappyNewYear</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart faa-vertical animated-hover"></i><span> å…³äº</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-link faa-tada animated-hover"></i><span> ç•™è¨€æ¿</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Zinx</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2022-12-27T03:12:54.020Z" title="å‘è¡¨äº 2022-12-27 11:12:54">2022-12-27</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2022-12-27T03:12:54.021Z" title="æ›´æ–°äº 2022-12-27 11:12:54">2022-12-27</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">å­¦ä¹ ç¬”è®°</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/Go/">Go</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">å­—æ•°æ€»è®¡:</span><span class="word-count">13.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»æ—¶é•¿:</span><span>56åˆ†é’Ÿ</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Zinx"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>[Toc]</p>
<blockquote>
<p>goç¯å¢ƒå˜é‡è®¾ç½®  <code>export GOPATH=/home/project</code> </p>
</blockquote>
<h1 id="Zinxæ¶æ„è®¾è®¡"><a href="#Zinxæ¶æ„è®¾è®¡" class="headerlink" title="Zinxæ¶æ„è®¾è®¡"></a>Zinxæ¶æ„è®¾è®¡</h1><h2 id="å®¢æˆ·ç«¯è¯·æ±‚æœåŠ¡å™¨å“åº”çš„è¿‡ç¨‹"><a href="#å®¢æˆ·ç«¯è¯·æ±‚æœåŠ¡å™¨å“åº”çš„è¿‡ç¨‹" class="headerlink" title="å®¢æˆ·ç«¯è¯·æ±‚æœåŠ¡å™¨å“åº”çš„è¿‡ç¨‹"></a>å®¢æˆ·ç«¯è¯·æ±‚æœåŠ¡å™¨å“åº”çš„è¿‡ç¨‹</h2><ol>
<li>è¦æœ‰ä¸€ä¸ªå®¢æˆ·ç«¯å¯¹æœåŠ¡å™¨å‘èµ·è¯·æ±‚ã€‚</li>
<li>æˆ‘ä»¬çš„æœåŠ¡å™¨åº”è¯¥å»å¯åŠ¨å¯¹å®¢æˆ·ç«¯çš„å¤„ç†æ¨¡å—å¹¶æ‰“å¼€å·¥ä½œæ± æ¥æå‡å¹¶å‘é‡ã€‚</li>
<li>å¤„ç†å®¢æˆ·ç«¯çš„æ¨¡å—å¼€å¯ä¸¤ä¸ªæ¨¡å—ï¼Œä¸€ä¸ªè´Ÿè´£è¯»å®¢æˆ·ç«¯è¯·æ±‚ï¼Œä¸€ä¸ªè´Ÿè´£å†™å®¢æˆ·ç«¯è¯·æ±‚ã€‚</li>
<li>ç”¨äºè¯»çš„åŠŸèƒ½æ¨¡å—ï¼Œå»ä»»åŠ¡çš„æ¶ˆæ¯é˜Ÿåˆ—é‡Œå»è¯·æ±‚è¯»æ•°æ®ã€‚ç”¨äºå†™çš„åŠŸèƒ½æ¨¡å—ï¼Œé€šè¿‡ API æ¥å£ï¼Œå½“ç„¶æˆ‘ä»¬çš„ API ä¸å¯èƒ½åªæœ‰ä¸€ä¸ªï¼Œæ‰€ä»¥è¿™é‡Œè‚¯å®šæ˜¯ APISã€‚</li>
</ol>
<p>å…¶è¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="../../../images/Zinx/88b6a670622c32bca3fb8749ee4af60a-0.png" alt="img"></p>
<h2 id="ZinxåŠŸèƒ½æ¨¡å—"><a href="#ZinxåŠŸèƒ½æ¨¡å—" class="headerlink" title="ZinxåŠŸèƒ½æ¨¡å—"></a>ZinxåŠŸèƒ½æ¨¡å—</h2><p><img src="../../../images/Zinx/b342d16a0981046dfc21fe1be21efccb-0.png" alt="img"></p>
<h1 id="v0-1"><a href="#v0-1" class="headerlink" title="v0.1"></a>v0.1</h1><p>Zinxç›®å½•ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="../../../images/Zinx/cef9bddfb7b6496b4fc8346cf63e7d76-0.png" alt="img"></p>
<h2 id="iserver-go"><a href="#iserver-go" class="headerlink" title="iserver.go"></a>iserver.go</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> ziface<br><br><span class="hljs-comment">// å®šä¹‰æœåŠ¡å™¨æ¥å£</span><br><span class="hljs-keyword">type</span> IServer <span class="hljs-keyword">interface</span> &#123;<br>	<span class="hljs-comment">// å¯åŠ¨æœåŠ¡å™¨</span><br>	Start()<br>	<span class="hljs-comment">// åœæ­¢æœåŠ¡å™¨</span><br>	Stop()<br>	<span class="hljs-comment">// å¼€å¯ä¸šåŠ¡æœåŠ¡æ–¹æ³•</span><br>	Server()<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="server-go"><a href="#server-go" class="headerlink" title="server.go *"></a>server.go <code>*</code></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><code class="hljs go"><br><span class="hljs-keyword">package</span> znet<br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;fmt&quot;</span><br>    <span class="hljs-string">&quot;net&quot;</span><br>    <span class="hljs-string">&quot;zinx/ziface&quot;</span><br>)<br><br><span class="hljs-comment">// IServer æ¥å£å®ç°ï¼Œå®šä¹‰ä¸€ä¸ªServeræœåŠ¡ç±»</span><br><span class="hljs-keyword">type</span> Server <span class="hljs-keyword">struct</span> &#123;<br>	 <span class="hljs-comment">//æœåŠ¡å™¨çš„åç§°</span><br>    Name <span class="hljs-type">string</span><br>    <span class="hljs-comment">//tcp4 or other</span><br>    IPVersion <span class="hljs-type">string</span><br>    <span class="hljs-comment">//æœåŠ¡ç»‘å®šçš„IPåœ°å€</span><br>    IP <span class="hljs-type">string</span><br>    <span class="hljs-comment">//æœåŠ¡ç»‘å®šçš„ç«¯å£</span><br>    Port <span class="hljs-type">int</span><br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">	åˆ›å»ºä¸€ä¸ªæœåŠ¡å™¨å¥æŸ„</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewServer</span> <span class="hljs-params">(name <span class="hljs-type">string</span>)</span></span> ziface.IServer  &#123;<br>	s := &amp;Server &#123;<br>		Name: name,<br>		IPVersion:<span class="hljs-string">&quot;tcp4&quot;</span>,<br>		IP:<span class="hljs-string">&quot;0.0.0.0&quot;</span>,<br>		Port:<span class="hljs-number">7777</span>,<br>	&#125;<br>	<span class="hljs-keyword">return</span> s<br>&#125;<br><br><span class="hljs-comment">// å¼€å¯ç½‘ç»œæœåŠ¡</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Server)</span></span> Start() &#123;<br>	fmt.Printf(<span class="hljs-string">&quot;[START] Server listenner at IP: %s, Port %d, is starting\n&quot;</span>, s.IP, s.Port)<br><br>	<span class="hljs-comment">// å¼€å¯ä¸€ä¸ªgoå»åšæœåŠ¡ç«¯Linsterä¸šåŠ¡</span><br>	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>		<span class="hljs-comment">// 1. è·å–ä¸€ä¸ªtcpçš„Addr</span><br>		addr, err := net.ResolveTCPAddr(s.IPVersion, fmt.Sprintf(<span class="hljs-string">&quot;%s,%d&quot;</span>, s.IP, s. Port))<br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			fmt.Println(<span class="hljs-string">&quot;resolve tcp addr err: &quot;</span>, err)<br>		&#125;<br><br>		<span class="hljs-comment">// 2. ç›‘å¬æœåŠ¡å™¨åœ°å€</span><br>		listenner, err := net.ListenTCP(s.IPVersion, addr)<br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			fmt.Println(<span class="hljs-string">&quot;listen&quot;</span>, s.IPVersion, <span class="hljs-string">&quot;err&quot;</span>, err)<br>			<span class="hljs-keyword">return</span><br>		&#125;<br><br>		<span class="hljs-comment">// å·²ç»ç›‘å¬æˆåŠŸ</span><br>		fmt.Println(<span class="hljs-string">&quot;Start zinx Server &quot;</span>, s.Name, <span class="hljs-string">&quot; succ, now listenningâ€¦â€¦&quot;</span>)<br><br>		<span class="hljs-comment">// 3 å¯åŠ¨serverç½‘ç»œè¿æ¥ä¸šåŠ¡</span><br>		<span class="hljs-keyword">for</span> &#123;<br>			<span class="hljs-comment">// 3.1 é˜»å¡ç­‰å¾…å®¢æˆ·ç«¯å»ºç«‹è¿æ¥è¯·æ±‚</span><br>			conn, err := listenner.AcceptTCP()<br>			<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>				fmt.Println(<span class="hljs-string">&quot;Accept err &quot;</span>, err)<br>				<span class="hljs-keyword">continue</span><br>			&#125;<br><br>			<span class="hljs-comment">// 3.2 TODO Server.Start() è®¾ç½®æœåŠ¡å™¨æœ€å¤§è¿æ¥æ§åˆ¶ï¼Œå¦‚æœè¶…è¿‡æœ€å¤§è¿æ¥ï¼Œé‚£ä¹ˆå…³é—­æ­¤æ–°çš„è¿æ¥</span><br>			<span class="hljs-comment">// 3.3 TODO Server.Start() å¤„ç†è¯¥æ–°è¿æ¥è¯·æ±‚çš„ *ä¸šåŠ¡* æ–¹æ³•ï¼Œæ­¤æ—¶åº”è¯¥æœ‰handlerå’Œconnæ˜¯ç»‘å®šçš„</span><br>			<span class="hljs-comment">// æˆ‘ä»¬è¿™é‡Œæš‚æ—¶åšä¸€ä¸ªæœ€å¤§512å­—èŠ‚çš„å›æ˜¾æœåŠ¡</span><br>			<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>				<span class="hljs-comment">// ä¸æ–­åœ°å¾ªç¯ä»å®¢æˆ·ç«¯è·å–æ•°æ®</span><br>				<span class="hljs-keyword">for</span> &#123;<br>					buf := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, <span class="hljs-number">512</span>)<br>					cnt, err := conn.Read(buf)<br>					<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>						fmt.Println(<span class="hljs-string">&quot;recv bug err &quot;</span>, err)<br>						<span class="hljs-keyword">continue</span><br>					&#125;<br>					<br>					<span class="hljs-comment">// å›æ˜¾</span><br>					<span class="hljs-keyword">if</span> _, err := conn.Write(buf[:cnt]); err != <span class="hljs-literal">nil</span> &#123;<br>						fmt.Println(<span class="hljs-string">&quot;write back buf err&quot;</span>, err)<br>						<span class="hljs-keyword">continue</span><br>					&#125;<br>				&#125;<br>			&#125;()<br>		&#125;<br>	&#125;()<br>&#125;<br><br><span class="hljs-comment">// åœæ­¢</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Server)</span></span> Stop() &#123;<br>	fmt.Println(<span class="hljs-string">&quot;[STOP] Zinx server, name&quot;</span>, s.Name)<br>&#125;<br><br><span class="hljs-comment">// å¼€å¯ä¸šåŠ¡</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Server)</span></span> Server()  &#123;<br>	<br>&#125;<br>  <br></code></pre></td></tr></table></figure>
<h2 id="server-test-go"><a href="#server-test-go" class="headerlink" title="server_test.go"></a>server_test.go</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> znet<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;net&quot;</span><br>	<span class="hljs-string">&quot;testing&quot;</span><br>	<span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">	æ¨¡æ‹Ÿå®¢æˆ·ç«¯</span><br><span class="hljs-comment">*/</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ClientTest</span><span class="hljs-params">()</span></span>  &#123;<br>	fmt.Println(<span class="hljs-string">&quot;Client Test ... start&quot;</span>)<br>	<span class="hljs-comment">// 3ç§’ä¹‹åå‘èµ·æµ‹è¯•è¯·æ±‚ï¼Œç»™æœåŠ¡ç«¯å¼€å¯æœåŠ¡çš„æœºä¼š</span><br>	time.Sleep(<span class="hljs-number">3</span> * time.Second)<br>	conn,err := net.Dial(<span class="hljs-string">&quot;tcp&quot;</span>, <span class="hljs-string">&quot;127.0.0.1:7777&quot;</span>)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		fmt.Println(<span class="hljs-string">&quot;client start err, exit!&quot;</span>)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br><br>	<span class="hljs-keyword">for</span> &#123;<br>		_, err = conn.Write([]<span class="hljs-type">byte</span>(<span class="hljs-string">&quot;Hello ZINX&quot;</span>))<br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			fmt.Println(<span class="hljs-string">&quot;Write error err &quot;</span>, err)<br>			<span class="hljs-keyword">return</span><br>		&#125;<br><br>		buf := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, <span class="hljs-number">512</span>)<br>		cnt, err := conn.Read(buf)<br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			fmt.Println(<span class="hljs-string">&quot;read  buf err&quot;</span>, err)<br>			<span class="hljs-keyword">return</span><br>		&#125;<br>		fmt.Printf(<span class="hljs-string">&quot; server call back: %s, cnt = %d\n&quot;</span>, buf, cnt)<br>		time.Sleep(<span class="hljs-number">1</span> * time.Second)<br>	&#125;<br>&#125;<br><br><span class="hljs-comment">// Server æ¨¡å—çš„æµ‹è¯•å‡½æ•°</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestServer</span><span class="hljs-params">(t *testing.T)</span></span>  &#123;<br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	æœåŠ¡ç«¯æµ‹è¯•</span><br><span class="hljs-comment">	*/</span><br><br>	<span class="hljs-comment">// 1 åˆ›å»ºä¸€ä¸ªserverå¥æŸ„ s</span><br>	s := NewServer(<span class="hljs-string">&quot;[zinx V0.1]&quot;</span>)<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">		å®¢æˆ·ç«¯æµ‹è¯•</span><br><span class="hljs-comment">	*/</span><br>	<span class="hljs-keyword">go</span> ClientTest()<br><br>	<span class="hljs-comment">// 2 å¼€å¯æœåŠ¡</span><br>	s.Server()<br> <br>&#125;<br></code></pre></td></tr></table></figure>
<h1 id="v0-2-å®ç°é“¾æ¥å°è£…ä¸šåŠ¡ä¸ä¸šåŠ¡ç»‘å®š"><a href="#v0-2-å®ç°é“¾æ¥å°è£…ä¸šåŠ¡ä¸ä¸šåŠ¡ç»‘å®š" class="headerlink" title="[v0.2] å®ç°é“¾æ¥å°è£…ä¸šåŠ¡ä¸ä¸šåŠ¡ç»‘å®š"></a>[v0.2] å®ç°é“¾æ¥å°è£…ä¸šåŠ¡ä¸ä¸šåŠ¡ç»‘å®š</h1><p>åŠŸèƒ½å¦‚æ€ç»´å¯¼å›¾æ‰€ç¤ºï¼š</p>
<p><img src="../../../images/Zinx/image-20220201232354654.png" alt="image-20220201232354654"></p>
<h2 id="æ–‡ä»¶ç»“æ„"><a href="#æ–‡ä»¶ç»“æ„" class="headerlink" title="æ–‡ä»¶ç»“æ„"></a>æ–‡ä»¶ç»“æ„</h2><p><img src="../../../images/Zinx/image-20220202175949470.png" alt="image-20220202175949470"></p>
<h2 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h2><h3 id="iconnection-go"><a href="#iconnection-go" class="headerlink" title="iconnection.go"></a>iconnection.go</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> ziface<br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;net&quot;</span><br><br><span class="hljs-comment">// å®šä¹‰è¿æ¥æ¥å£</span><br><span class="hljs-keyword">type</span> IConnection <span class="hljs-keyword">interface</span> &#123;<br>	<span class="hljs-comment">// å¯åŠ¨è¿æ¥ï¼Œè®©ç”µæ°”æ¦‚å¿µè¿æ¥å¼€å§‹å·¥ä½œ</span><br>	Start()<br>	<span class="hljs-comment">// åœæ­¢è¿æ¥ï¼Œç»“æŸå½“å‰é“¾æ¥çŠ¶æ€</span><br>	Stop()<br>	<span class="hljs-comment">// ä»å½“å‰é“¾æ¥è·å–åŸå§‹çš„socket TCPConn</span><br>	GetTCPConnection() *net.TCPConn<br>	<span class="hljs-comment">// è·å–å½“å‰é“¾æ¥ID</span><br>	GetConnID() <span class="hljs-type">uint32</span><br>	<span class="hljs-comment">// è·å–è¿œç¨‹å®¢æˆ·ç«¯åœ°å€ä¿¡æ¯</span><br>	RemoteAddr() net.Addr<br>&#125;<br><br><span class="hljs-comment">// å®šä¹‰ä¸€ä¸ªç»Ÿä¸€å¤„ç†é“¾æ¥ä¸šåŠ¡çš„æ¥å£</span><br><span class="hljs-keyword">type</span> HandFunc <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(*net.TCPConn, []<span class="hljs-type">byte</span>, <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">error</span> <br></code></pre></td></tr></table></figure>
<h3 id="connection-go"><a href="#connection-go" class="headerlink" title="connection.go"></a>connection.go</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> znet<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;net&quot;</span><br>	<span class="hljs-string">&quot;zinx/ziface&quot;</span><br>)<br><br><span class="hljs-keyword">type</span> Connection <span class="hljs-keyword">struct</span> &#123;<br>	<span class="hljs-comment">// å½“å‰é“¾æ¥çš„socket TCPå¥—æ¥å­—</span><br>	Conn *net.TCPConn<br>	<span class="hljs-comment">// å½“å‰è¿æ¥çš„ID ä¹Ÿå¯ä»¥ç§°ä½œä¸ºSessionIDï¼Œ IDå…¨å±€å”¯ä¸€</span><br>	ConnID <span class="hljs-type">uint32</span><br>	<span class="hljs-comment">// å½“å‰è¿æ¥çš„å…³é—­çŠ¶æ€</span><br>	isClosed <span class="hljs-type">bool</span><br>	<span class="hljs-comment">// è¯¥é“¾æ¥çš„å¤„ç†æ–¹æ³•api</span><br>	handleAPI ziface.HandFunc<br>	<span class="hljs-comment">// å‘ŠçŸ¥è¯¥é“¾æ¥å·²ç»é€€å‡º/åœæ­¢çš„channel</span><br>	ExitBufferChan <span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span><br>&#125;<br><br><span class="hljs-comment">// åˆ›å»ºè¿æ¥çš„æ–¹æ³•</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewConntion</span><span class="hljs-params">(conn *net.TCPConn, connID <span class="hljs-type">uint32</span>, callBack_api ziface.HandFunc)</span></span> *Connection &#123;<br>	c := &amp;Connection&#123;<br>		Conn: conn,<br>		ConnID: connID,<br>		isClosed: <span class="hljs-literal">false</span>,<br>		handleAPI: callBack_api,<br>		ExitBufferChan: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span>, <span class="hljs-number">1</span>),<br>	&#125;<br>	<span class="hljs-keyword">return</span> c<br>&#125;<br><br><span class="hljs-comment">/* å¤„ç†connè¯»æ•°æ®çš„Goroutine */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Connection)</span></span> StartReader()  &#123;<br>	fmt.Println(<span class="hljs-string">&quot;Reader Goroutine is running&quot;</span>)<br>	<span class="hljs-keyword">defer</span> fmt.Println(c.Conn.RemoteAddr().String(), <span class="hljs-string">&quot;conn reader exit&quot;</span>)<br>	<span class="hljs-keyword">defer</span> c.Stop()<br><br>	<span class="hljs-keyword">for</span> &#123;<br>		<span class="hljs-comment">// è¯»å–æˆ‘ä»¬æœ€å¤§çš„æ•°æ®åˆ°bufä¸­</span><br>		buf := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>,<span class="hljs-number">512</span>)<br>		cnt, err := c.Conn.Read(buf)<br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			fmt.Println(<span class="hljs-string">&quot;recv bug err &quot;</span>, err)<br>			c.ExitBufferChan &lt;- <span class="hljs-literal">true</span><br>			<span class="hljs-keyword">continue</span><br>		&#125;<br><br>		<span class="hljs-comment">// è°ƒç”¨å½“å‰é“¾æ¥ä¸šåŠ¡ï¼ˆè¿™é‡Œæ‰§è¡Œçš„æ˜¯å½“å‰connçš„ç»‘å®šçš„handleæ–¹æ³•ï¼‰</span><br>		<span class="hljs-keyword">if</span> err := c.handleAPI(c.Conn, buf, cnt); err != <span class="hljs-literal">nil</span> &#123;<br>			fmt.Println(<span class="hljs-string">&quot;connID &quot;</span>, c.ConnID, <span class="hljs-string">&quot; handle is error&quot;</span>)<br>			c.ExitBufferChan &lt;- <span class="hljs-literal">true</span><br>			<span class="hljs-keyword">return</span><br>		&#125;<br>	&#125;<br>&#125;<br><br><span class="hljs-comment">// å¯åŠ¨é“¾æ¥ï¼Œè®©å½“å‰è¿æ¥å¼€å§‹å·¥ä½œ</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Connection)</span></span> Start()  &#123;<br>	<span class="hljs-comment">// å¼€å¯å¤„ç†è¯¥é“¾æ¥è¯»å–å®¢æˆ·ç«¯æ•°æ®ä¹‹åçš„è¯·æ±‚ä¸šåŠ¡</span><br>	<span class="hljs-keyword">go</span> c.StartReader()<br>	<span class="hljs-keyword">for</span> &#123;<br>		<span class="hljs-keyword">select</span> &#123;<br>		<span class="hljs-keyword">case</span> &lt;- c.ExitBufferChan:<br>			<span class="hljs-comment">// å¾—åˆ°é€€å‡ºæ¶ˆæ¯ï¼Œä¸å†é˜»å¡</span><br>			<span class="hljs-keyword">return</span><br>		&#125;<br>	&#125;<br>&#125;<br><br><span class="hljs-comment">// åœæ­¢è¿æ¥ï¼Œç»“æŸå½“å‰è¿æ¥çŠ¶æ€M</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Connection)</span></span> Stop()  &#123;<br>	<span class="hljs-comment">// 1. å¦‚æœå½“å‰é“¾æ¥å·²ç»å…³é—­</span><br>	<span class="hljs-keyword">if</span> c.isClosed == <span class="hljs-literal">true</span> &#123;<br>		<span class="hljs-keyword">return</span><br>	&#125;<br><br>	c.isClosed = <span class="hljs-literal">true</span><br><br>	<span class="hljs-comment">// TODO Connection Stop() å¦‚æœç”¨æˆ·æ³¨å†Œäº†è¯¥é“¾æ¥çš„å…³é—­æ¯æ‰ä¸šåŠ¡ï¼Œé‚£ä¹ˆåœ¨æ­¤åˆ»åº”è¯¥æ˜¾ç¤ºè°ƒç”¨</span><br>	<span class="hljs-comment">// å…³é—­socketé“¾æ¥</span><br>	c.Conn.Close()<br>	<span class="hljs-comment">// é€šçŸ¥ä»ç¼“å†²é˜Ÿåˆ—è¯»å–æ•°æ®çš„ä¸šåŠ¡ï¼Œè¯¥é“¾æ¥å·²ç»å…³é—­</span><br>	c.ExitBufferChan &lt;- <span class="hljs-literal">true</span><br>	<span class="hljs-comment">// å…³é—­è¯¥é“¾æ¥å…¨éƒ¨ç®¡é“</span><br>	<span class="hljs-built_in">close</span>(c.ExitBufferChan)<br>&#125;<br><br><span class="hljs-comment">// ä»å½“å‰è¿æ¥è·å–åŸå§‹çš„socket TCPConn</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Connection)</span></span> GetTCPConnection() *net.TCPConn &#123;<br>	<span class="hljs-keyword">return</span> c.Conn<br>&#125;<br><span class="hljs-comment">// è·å–å½“å‰ID</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Connection)</span></span> GetConnID() <span class="hljs-type">uint32</span> &#123;<br>	<span class="hljs-keyword">return</span> c.ConnID<br>&#125;<br><span class="hljs-comment">// è·å–è¿œç¨‹å®¢æˆ·ç«¯åœ°å€ä¿¡æ¯</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Connection)</span></span> RemoteAddr() net.Addr &#123;<br>	<span class="hljs-keyword">return</span> c.Conn.RemoteAddr()	<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="server-go-ä»£ç ä¿®æ”¹"><a href="#server-go-ä»£ç ä¿®æ”¹" class="headerlink" title="server.go ä»£ç ä¿®æ”¹"></a>server.go ä»£ç ä¿®æ”¹</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// TODO server.go åº”è¯¥æœ‰ä¸€ä¸ªè‡ªåŠ¨ç”ŸæˆIDçš„æ–¹æ³•</span><br>+		<span class="hljs-keyword">var</span> cid <span class="hljs-type">uint32</span> = <span class="hljs-number">0</span><br>		<span class="hljs-comment">// 3 å¯åŠ¨serverç½‘ç»œè¿æ¥ä¸šåŠ¡</span><br>		<span class="hljs-keyword">for</span> &#123;<br>			<span class="hljs-comment">// 3.1 é˜»å¡ç­‰å¾…å®¢æˆ·ç«¯å»ºç«‹è¿æ¥è¯·æ±‚</span><br>			conn, err := listenner.AcceptTCP()<br>			<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>				fmt.Println(<span class="hljs-string">&quot;Accept err &quot;</span>, err)<br>				<span class="hljs-keyword">continue</span><br>			&#125;<br><br>			<span class="hljs-comment">// 3.2 TODO Server.Start() è®¾ç½®æœåŠ¡å™¨æœ€å¤§è¿æ¥æ§åˆ¶ï¼Œå¦‚æœè¶…è¿‡æœ€å¤§è¿æ¥ï¼Œé‚£ä¹ˆå…³é—­æ­¤æ–°çš„è¿æ¥</span><br>			<span class="hljs-comment">// 3.3 TODO Server.Start() å¤„ç†è¯¥æ–°è¿æ¥è¯·æ±‚çš„ *ä¸šåŠ¡* æ–¹æ³•ï¼Œæ­¤æ—¶åº”è¯¥æœ‰handlerå’Œconnæ˜¯ç»‘å®šçš„</span><br>+			dealConn := NewConntion(conn, cid, CallBackToClient)<br>+           cid ++<br>			<br>			<span class="hljs-comment">//3.4 å¯åŠ¨å½“å‰é“¾æ¥çš„å¤„ç†ä¸šåŠ¡</span><br>            <span class="hljs-keyword">go</span> dealConn.Start()<br>		&#125;<br>	&#125;()<br></code></pre></td></tr></table></figure>
<h1 id="v0-3-å®ç°åŸºç¡€è·¯ç”±æ¨¡å—"><a href="#v0-3-å®ç°åŸºç¡€è·¯ç”±æ¨¡å—" class="headerlink" title="[v0.3] å®ç°åŸºç¡€è·¯ç”±æ¨¡å—"></a>[v0.3] å®ç°åŸºç¡€è·¯ç”±æ¨¡å—</h1><blockquote>
<p>é€šä¿—è®²å°±æ˜¯å®ç°ä¸€ä¸ªç±»ï¼Œç³»ç»Ÿåœ°å»å›è°ƒä¸€äº›ç”¨æˆ·çš„æ“ä½œ</p>
</blockquote>
<h2 id="åŠŸèƒ½"><a href="#åŠŸèƒ½" class="headerlink" title="åŠŸèƒ½"></a>åŠŸèƒ½</h2><p><img src="../../../images/Zinx/1ef8c2201f35797a7678e54c3e9af24b-0.png" alt="img"></p>
<blockquote>
<p><strong>æ¶‰åŠçŸ¥è¯†ç‚¹ï¼š</strong></p>
<ol>
<li>è·¯ç”±åŠŸèƒ½æ¨¡å—</li>
</ol>
</blockquote>
<h2 id="ç›®å½•ç»“æ„"><a href="#ç›®å½•ç»“æ„" class="headerlink" title="ç›®å½•ç»“æ„"></a>ç›®å½•ç»“æ„</h2><p><img src="../../../images/Zinx/image-20220203160347674.png" alt="image-20220203160347674"></p>
<h2 id="IRequestæ¶ˆæ¯è¯·æ±‚æŠ½è±¡ç±»"><a href="#IRequestæ¶ˆæ¯è¯·æ±‚æŠ½è±¡ç±»" class="headerlink" title="IRequestæ¶ˆæ¯è¯·æ±‚æŠ½è±¡ç±»"></a>IRequestæ¶ˆæ¯è¯·æ±‚æŠ½è±¡ç±»</h2><blockquote>
<p>æŠŠå®¢æˆ·ç«¯è¯·æ±‚çš„è¿æ¥ä¿¡æ¯å’Œè¯·æ±‚çš„æ•°æ®ï¼Œæ”¾åœ¨ä¸€ä¸ªå« Request çš„è¯·æ±‚ç±»é‡Œï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯æˆ‘ä»¬å¯ä»¥ä» Request é‡Œå¾—åˆ°å…¨éƒ¨å®¢æˆ·ç«¯çš„è¯·æ±‚ä¿¡æ¯ï¼Œä¹Ÿä¸ºæˆ‘ä»¬ä¹‹åæ‹“å±•æ¡†æ¶æœ‰ä¸€å®šçš„ä½œç”¨ï¼Œä¸€æ—¦å®¢æˆ·ç«¯æœ‰é¢å¤–çš„å«ä¹‰çš„æ•°æ®ä¿¡æ¯ï¼Œéƒ½å¯ä»¥æ”¾åœ¨è¿™ä¸ª Request é‡Œã€‚å¯ä»¥ç†è§£ä¸ºæ¯æ¬¡å®¢æˆ·ç«¯çš„å…¨éƒ¨è¯·æ±‚æ•°æ®ï¼ŒZinx éƒ½ä¼šæŠŠå®ƒä»¬ä¸€èµ·æ”¾åˆ°ä¸€ä¸ª Request ç»“æ„ä½“é‡Œã€‚</p>
</blockquote>
<ol>
<li>åˆ›å»ºæŠ½è±¡<code>IRequest</code>å±‚</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> ziface<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">    IRequest æ¥å£ï¼š</span><br><span class="hljs-comment">    å®é™…ä¸Šæ˜¯æŠŠå®¢æˆ·ç«¯è¯·æ±‚çš„é“¾æ¥ä¿¡æ¯ å’Œ è¯·æ±‚çš„æ•°æ® åŒ…è£…åˆ°äº† Requesté‡Œ</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">type</span> IRequest <span class="hljs-keyword">interface</span>&#123;<br>    GetConnection() IConnection    <span class="hljs-comment">//è·å–è¯·æ±‚è¿æ¥ä¿¡æ¯</span><br>    GetData() []<span class="hljs-type">byte</span>            <span class="hljs-comment">//è·å–è¯·æ±‚æ¶ˆæ¯çš„æ•°æ®</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>å½“å‰çš„æŠ½è±¡å±‚åªæä¾›äº†ä¸¤ä¸ª Getter æ–¹æ³•ï¼Œæ‰€ä»¥æœ‰ä¸ªæˆå‘˜åº”è¯¥æ˜¯å¿…é¡»çš„ï¼Œä¸€ä¸ªæ˜¯å®¢æˆ·ç«¯è¿æ¥ï¼Œä¸€ä¸ªæ˜¯å®¢æˆ·ç«¯ä¼ é€’è¿›æ¥çš„æ•°æ®ï¼Œå½“ç„¶éšç€ Zinx æ¡†æ¶çš„åŠŸèƒ½ä¸°å¯Œï¼Œè¿™é‡Œé¢è¿˜åº”è¯¥ç»§ç»­æ·»åŠ æ–°çš„æˆå‘˜ã€‚</p>
<ol>
<li>å®ç°<code>Requeset</code>ç±»</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> znet<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;zinx/ziface&quot;</span><br><br><span class="hljs-keyword">type</span> Request <span class="hljs-keyword">struct</span> &#123;<br>    conn ziface.IConnection <span class="hljs-comment">//å·²ç»å’Œå®¢æˆ·ç«¯å»ºç«‹å¥½çš„ é“¾æ¥</span><br>    data []<span class="hljs-type">byte</span> <span class="hljs-comment">//å®¢æˆ·ç«¯è¯·æ±‚çš„æ•°æ®</span><br>&#125;<br><span class="hljs-comment">//è·å–è¯·æ±‚è¿æ¥ä¿¡æ¯</span><br><span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(r *Request)</span></span> GetConnection() ziface.IConnection &#123;<br>    <span class="hljs-keyword">return</span> r.conn<br>&#125;<br><span class="hljs-comment">//è·å–è¯·æ±‚æ¶ˆæ¯çš„æ•°æ®</span><br><span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(r *Request)</span></span> GetData() []<span class="hljs-type">byte</span> &#123;<br>    <span class="hljs-keyword">return</span> r.data<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="IRouterè·¯ç”±é…ç½®æŠ½è±¡ç±»"><a href="#IRouterè·¯ç”±é…ç½®æŠ½è±¡ç±»" class="headerlink" title="IRouterè·¯ç”±é…ç½®æŠ½è±¡ç±»*"></a>IRouterè·¯ç”±é…ç½®æŠ½è±¡ç±»<code>*</code></h2><blockquote>
<p>å®ç°ä¸€ä¸ªéå¸¸ç®€å•åŸºç¡€çš„è·¯ç”±åŠŸèƒ½ï¼Œç›®çš„å½“ç„¶å°±æ˜¯ä¸ºäº†å¿«é€Ÿçš„è®© Zinx æ­¥å…¥åˆ°è·¯ç”±çš„é˜¶æ®µã€‚</p>
</blockquote>
<ol>
<li>åˆ›å»ºæŠ½è±¡çš„<code>IRouter</code>å±‚</li>
</ol>
<p>æˆ‘ä»¬çŸ¥é“ router å®é™…ä¸Šçš„ä½œç”¨å°±æ˜¯ï¼ŒæœåŠ¡ç«¯åº”ç”¨å¯ä»¥ç»™ Zinx æ¡†æ¶é…ç½®å½“å‰é“¾æ¥çš„å¤„ç†ä¸šåŠ¡æ–¹æ³•ï¼Œä¹‹å‰çš„ Zinx-V0.2 æˆ‘ä»¬çš„ Zinx æ¡†æ¶å¤„ç†é“¾æ¥è¯·æ±‚çš„æ–¹æ³•æ˜¯å›ºå®šçš„ï¼Œç°åœ¨æ˜¯å¯ä»¥è‡ªå®šä¹‰ï¼Œå¹¶ä¸”æœ‰ 3 ç§æ¥å£å¯ä»¥é‡å†™ã€‚</p>
<p>Handleï¼šæ˜¯å¤„ç†å½“å‰é“¾æ¥çš„ä¸»ä¸šåŠ¡å‡½æ•°</p>
<p>PreHandleï¼šå¦‚æœéœ€è¦åœ¨ä¸»ä¸šåŠ¡å‡½æ•°ä¹‹å‰æœ‰å‰ç½®ä¸šåŠ¡ï¼Œå¯ä»¥é‡å†™è¿™ä¸ªæ–¹æ³•</p>
<p>PostHandle:å¦‚æœéœ€è¦åœ¨ä¸»ä¸šåŠ¡å‡½æ•°ä¹‹ååˆåç½®ä¸šåŠ¡ï¼Œå¯ä»¥é‡å†™è¿™ä¸ªæ–¹æ³•</p>
<p>å½“ç„¶æ¯ä¸ªæ–¹æ³•éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„å½¢å‚ IRequest å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯å®¢æˆ·ç«¯è¯·æ±‚è¿‡æ¥çš„è¿æ¥å’Œè¯·æ±‚æ•°æ®ï¼Œä½œä¸ºæˆ‘ä»¬ä¸šåŠ¡æ–¹æ³•çš„è¾“å…¥æ•°æ®ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> ziface<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">    è·¯ç”±æ¥å£ï¼Œ è¿™é‡Œé¢è·¯ç”±æ˜¯ ä½¿ç”¨æ¡†æ¶è€…ç»™è¯¥é“¾æ¥è‡ªå®šçš„ å¤„ç†ä¸šåŠ¡æ–¹æ³•</span><br><span class="hljs-comment">    è·¯ç”±é‡Œçš„IRequest åˆ™åŒ…å«ç”¨è¯¥é“¾æ¥çš„é“¾æ¥ä¿¡æ¯å’Œè¯¥é“¾æ¥çš„è¯·æ±‚æ•°æ®ä¿¡æ¯</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">type</span> IRouter <span class="hljs-keyword">interface</span>&#123;<br>    PreHandle(request IRequest)  <span class="hljs-comment">//åœ¨å¤„ç†connä¸šåŠ¡ä¹‹å‰çš„é’©å­æ–¹æ³•</span><br>    Handle(request IRequest)     <span class="hljs-comment">//å¤„ç†connä¸šåŠ¡çš„æ–¹æ³•</span><br>    PostHandle(request IRequest) <span class="hljs-comment">//å¤„ç†connä¸šåŠ¡ä¹‹åçš„é’©å­æ–¹æ³•</span><br>&#125;<br></code></pre></td></tr></table></figure>
<ol>
<li>å®ç°<code>Router</code>ç±»</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> znet<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;zinx/ziface&quot;</span><br><br><span class="hljs-comment">//å®ç°routeræ—¶ï¼Œå…ˆåµŒå…¥è¿™ä¸ªåŸºç±»ï¼Œç„¶åæ ¹æ®éœ€è¦å¯¹è¿™ä¸ªåŸºç±»çš„æ–¹æ³•è¿›è¡Œé‡å†™</span><br><span class="hljs-keyword">type</span> BaseRouter <span class="hljs-keyword">struct</span> &#123;&#125;<br><span class="hljs-comment">//è¿™é‡Œä¹‹æ‰€ä»¥BaseRouterçš„æ–¹æ³•éƒ½ä¸ºç©ºï¼Œ</span><br><span class="hljs-comment">// æ˜¯å› ä¸ºæœ‰çš„Routerä¸å¸Œæœ›æœ‰PreHandleæˆ–PostHandle</span><br><span class="hljs-comment">// æ‰€ä»¥Routerå…¨éƒ¨ç»§æ‰¿BaseRouterçš„å¥½å¤„æ˜¯ï¼Œä¸éœ€è¦å®ç°PreHandleå’ŒPostHandleä¹Ÿå¯ä»¥å®ä¾‹åŒ–</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(br *BaseRouter)</span></span>PreHandle(req ziface.IRequest)&#123;&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(br *BaseRouter)</span></span>Handle(req ziface.IRequest)&#123;&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(br *BaseRouter)</span></span>PostHandle(req ziface.IRequest)&#123;&#125;<br></code></pre></td></tr></table></figure>
<h2 id="IServerå¢æ·»è·¯ç”±æ·»åŠ åŠŸèƒ½"><a href="#IServerå¢æ·»è·¯ç”±æ·»åŠ åŠŸèƒ½" class="headerlink" title="IServerå¢æ·»è·¯ç”±æ·»åŠ åŠŸèƒ½"></a>IServerå¢æ·»è·¯ç”±æ·»åŠ åŠŸèƒ½</h2><blockquote>
<p>è¿™ä¸€æ­¥éœ€è¦ä¿®æ”¹åŸæœ‰çš„é“¾æ¥ç»“æ„ä½“ï¼ŒåŒæ—¶å¯¹æœåŠ¡ä¸­çš„æ–¹æ³•è¿›è¡Œä¿®æ”¹</p>
</blockquote>
<h3 id="serverç±»"><a href="#serverç±»" class="headerlink" title="serverç±»"></a>serverç±»</h3><ol>
<li><code>iserver.go</code></li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> ziface<br><span class="hljs-comment">//å®šä¹‰æœåŠ¡å™¨æ¥å£</span><br><span class="hljs-keyword">type</span> IServer <span class="hljs-keyword">interface</span>&#123;<br>    <span class="hljs-comment">//å¯åŠ¨æœåŠ¡å™¨æ–¹æ³•</span><br>    Start()<br>    <span class="hljs-comment">//åœæ­¢æœåŠ¡å™¨æ–¹æ³•</span><br>    Stop()<br>    <span class="hljs-comment">//å¼€å¯ä¸šåŠ¡æœåŠ¡æ–¹æ³•</span><br>    Serve()<br>    <span class="hljs-comment">//è·¯ç”±åŠŸèƒ½ï¼šç»™å½“å‰æœåŠ¡æ³¨å†Œä¸€ä¸ªè·¯ç”±ä¸šåŠ¡æ–¹æ³•ï¼Œä¾›å®¢æˆ·ç«¯é“¾æ¥å¤„ç†ä½¿ç”¨</span><br>    AddRouter(router IRouter)<br>&#125;<br></code></pre></td></tr></table></figure>
<ol>
<li><code>server.go</code></li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">//iServer æ¥å£å®ç°ï¼Œå®šä¹‰ä¸€ä¸ªServeræœåŠ¡ç±»</span><br><span class="hljs-keyword">type</span> Server <span class="hljs-keyword">struct</span> &#123;<br>    <span class="hljs-comment">//æœåŠ¡å™¨çš„åç§°</span><br>    Name <span class="hljs-type">string</span><br>    <span class="hljs-comment">//tcp4 or other</span><br>    IPVersion <span class="hljs-type">string</span><br>    <span class="hljs-comment">//æœåŠ¡ç»‘å®šçš„IPåœ°å€</span><br>    IP <span class="hljs-type">string</span><br>    <span class="hljs-comment">//æœåŠ¡ç»‘å®šçš„ç«¯å£</span><br>    Port <span class="hljs-type">int</span><br>    <span class="hljs-comment">//å½“å‰Serverç”±ç”¨æˆ·ç»‘å®šçš„å›è°ƒrouter,ä¹Ÿå°±æ˜¯Serveræ³¨å†Œçš„é“¾æ¥å¯¹åº”çš„å¤„ç†ä¸šåŠ¡</span><br>    Router ziface.IRouter<br>&#125;<br></code></pre></td></tr></table></figure>
<ol>
<li><code>NewServer()</code>æ–¹æ³•ä¸­çš„æˆå‘˜åˆå§‹åŒ–</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/*</span><br><span class="hljs-comment">  åˆ›å»ºä¸€ä¸ªæœåŠ¡å™¨å¥æŸ„</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewServer</span> <span class="hljs-params">(name <span class="hljs-type">string</span>)</span></span> ziface.IServer &#123;<br>    s:= &amp;Server &#123;<br>        Name :name,<br>        IPVersion:<span class="hljs-string">&quot;tcp4&quot;</span>,<br>        IP:<span class="hljs-string">&quot;0.0.0.0&quot;</span>,<br>        Port:<span class="hljs-number">7777</span>,<br>        Router: <span class="hljs-literal">nil</span>,<br>    &#125;<br>    <span class="hljs-keyword">return</span> s<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="Connectionç±»"><a href="#Connectionç±»" class="headerlink" title="Connectionç±»"></a>Connectionç±»</h3><ol>
<li><code>connection.go</code></li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Connection <span class="hljs-keyword">struct</span> &#123;<br>    <span class="hljs-comment">//å½“å‰è¿æ¥çš„socket TCPå¥—æ¥å­—</span><br>    Conn *net.TCPConn<br>    <span class="hljs-comment">//å½“å‰è¿æ¥çš„ID ä¹Ÿå¯ä»¥ç§°ä½œä¸ºSessionIDï¼ŒIDå…¨å±€å”¯ä¸€</span><br>    ConnID <span class="hljs-type">uint32</span><br>    <span class="hljs-comment">//å½“å‰è¿æ¥çš„å…³é—­çŠ¶æ€</span><br>    isClosed <span class="hljs-type">bool</span><br>    <span class="hljs-comment">//è¯¥è¿æ¥çš„å¤„ç†æ–¹æ³•router</span><br>    Router  ziface.IRouter<br>    <span class="hljs-comment">//å‘ŠçŸ¥è¯¥é“¾æ¥å·²ç»é€€å‡º/åœæ­¢çš„channel</span><br>    ExitBuffChan <span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span><br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Connection)</span></span> StartReader() &#123;<br>    fmt.Println(<span class="hljs-string">&quot;Reader Goroutine is  running&quot;</span>)<br>    <span class="hljs-keyword">defer</span> fmt.Println(c.RemoteAddr().String(), <span class="hljs-string">&quot; conn reader exit!&quot;</span>)<br>    <span class="hljs-keyword">defer</span> c.Stop()<br>    <span class="hljs-keyword">for</span>  &#123;<br>        <span class="hljs-comment">//è¯»å–æˆ‘ä»¬æœ€å¤§çš„æ•°æ®åˆ°bufä¸­</span><br>        buf := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, <span class="hljs-number">512</span>)<br>        _, err := c.Conn.Read(buf)<br>        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>            fmt.Println(<span class="hljs-string">&quot;recv buf err &quot;</span>, err)<br>            c.ExitBuffChan &lt;- <span class="hljs-literal">true</span><br>            <span class="hljs-keyword">continue</span><br>        &#125;<br>        <span class="hljs-comment">//å¾—åˆ°å½“å‰å®¢æˆ·ç«¯è¯·æ±‚çš„Requestæ•°æ®</span><br>        req := Request&#123;<br>            conn:c,<br>            data:buf,<br>        &#125;<br>        <span class="hljs-comment">//ä»è·¯ç”±Routers ä¸­æ‰¾åˆ°æ³¨å†Œç»‘å®šConnçš„å¯¹åº”Handle</span><br>        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(request ziface.IRequest)</span></span> &#123;<br>            <span class="hljs-comment">//æ‰§è¡Œæ³¨å†Œçš„è·¯ç”±æ–¹æ³•</span><br>            c.Router.PreHandle(request)<br>            c.Router.Handle(request)<br>            c.Router.PostHandle(request)<br>        &#125;(&amp;req)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="AddRouter"><a href="#AddRouter" class="headerlink" title="AddRouter"></a>AddRouter</h3><p>åœ¨<code>server</code>ç±»è¦å®ç°æ·»åŠ è·¯ç”±çš„æ–¹æ³•<code>AddRouter</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> znet<br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;fmt&quot;</span><br>    <span class="hljs-string">&quot;net&quot;</span><br>    <span class="hljs-string">&quot;time&quot;</span><br>    <span class="hljs-string">&quot;zinx/ziface&quot;</span><br>)<br><span class="hljs-comment">//iServer æ¥å£å®ç°ï¼Œå®šä¹‰ä¸€ä¸ªServeræœåŠ¡ç±»</span><br><span class="hljs-keyword">type</span> Server <span class="hljs-keyword">struct</span> &#123;<br>    <span class="hljs-comment">//æœåŠ¡å™¨çš„åç§°</span><br>    Name <span class="hljs-type">string</span><br>    <span class="hljs-comment">//tcp4 or other</span><br>    IPVersion <span class="hljs-type">string</span><br>    <span class="hljs-comment">//æœåŠ¡ç»‘å®šçš„IPåœ°å€</span><br>    IP <span class="hljs-type">string</span><br>    <span class="hljs-comment">//æœåŠ¡ç»‘å®šçš„ç«¯å£</span><br>    Port <span class="hljs-type">int</span><br>    <span class="hljs-comment">//å½“å‰Serverç”±ç”¨æˆ·ç»‘å®šçš„å›è°ƒrouter,ä¹Ÿå°±æ˜¯Serveræ³¨å†Œçš„é“¾æ¥å¯¹åº”çš„å¤„ç†ä¸šåŠ¡</span><br>    Router ziface.IRouter<br>&#125;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">  åˆ›å»ºä¸€ä¸ªæœåŠ¡å™¨å¥æŸ„</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewServer</span> <span class="hljs-params">(name <span class="hljs-type">string</span>)</span></span> ziface.IServer &#123;<br>    s:= &amp;Server &#123;<br>        Name :name,<br>        IPVersion:<span class="hljs-string">&quot;tcp4&quot;</span>,<br>        IP:<span class="hljs-string">&quot;0.0.0.0&quot;</span>,<br>        Port:<span class="hljs-number">7777</span>,<br>        Router: <span class="hljs-literal">nil</span>,<br>    &#125;<br>    <span class="hljs-keyword">return</span> s<br>&#125;<br><span class="hljs-comment">//============== å®ç° ziface.IServer é‡Œçš„å…¨éƒ¨æ¥å£æ–¹æ³• ========</span><br><span class="hljs-comment">//å¼€å¯ç½‘ç»œæœåŠ¡</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Server)</span></span> Start() &#123;<br>    fmt.Printf(<span class="hljs-string">&quot;[START] Server listenner at IP: %s, Port %d, is starting\n&quot;</span>, s.IP, s.Port)<br>    <span class="hljs-comment">//å¼€å¯ä¸€ä¸ªgoå»åšæœåŠ¡ç«¯Linsterä¸šåŠ¡</span><br>    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>        <span class="hljs-comment">//1 è·å–ä¸€ä¸ªTCPçš„Addr</span><br>        addr, err := net.ResolveTCPAddr(s.IPVersion, fmt.Sprintf(<span class="hljs-string">&quot;%s:%d&quot;</span>, s.IP, s.Port))<br>        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>            fmt.Println(<span class="hljs-string">&quot;resolve tcp addr err: &quot;</span>, err)<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        <span class="hljs-comment">//2 ç›‘å¬æœåŠ¡å™¨åœ°å€</span><br>        listenner, err:= net.ListenTCP(s.IPVersion, addr)<br>        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>            fmt.Println(<span class="hljs-string">&quot;listen&quot;</span>, s.IPVersion, <span class="hljs-string">&quot;err&quot;</span>, err)<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        <span class="hljs-comment">//å·²ç»ç›‘å¬æˆåŠŸ</span><br>        fmt.Println(<span class="hljs-string">&quot;start Zinx server  &quot;</span>, s.Name, <span class="hljs-string">&quot; succ, now listenning...&quot;</span>)<br>        <span class="hljs-comment">//TODO server.go åº”è¯¥æœ‰ä¸€ä¸ªè‡ªåŠ¨ç”ŸæˆIDçš„æ–¹æ³•</span><br>        <span class="hljs-keyword">var</span> cid <span class="hljs-type">uint32</span><br>        cid = <span class="hljs-number">0</span><br>        <span class="hljs-comment">//3 å¯åŠ¨serverç½‘ç»œè¿æ¥ä¸šåŠ¡</span><br>        <span class="hljs-keyword">for</span> &#123;<br>            <span class="hljs-comment">//3.1 é˜»å¡ç­‰å¾…å®¢æˆ·ç«¯å»ºç«‹è¿æ¥è¯·æ±‚</span><br>            conn, err := listenner.AcceptTCP()<br>            <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>                fmt.Println(<span class="hljs-string">&quot;Accept err &quot;</span>, err)<br>                <span class="hljs-keyword">continue</span><br>            &#125;<br>            <span class="hljs-comment">//3.2 TODO Server.Start() è®¾ç½®æœåŠ¡å™¨æœ€å¤§è¿æ¥æ§åˆ¶,å¦‚æœè¶…è¿‡æœ€å¤§è¿æ¥ï¼Œé‚£ä¹ˆåˆ™å…³é—­æ­¤æ–°çš„è¿æ¥</span><br>            <span class="hljs-comment">//3.3 å¤„ç†è¯¥æ–°è¿æ¥è¯·æ±‚çš„ ä¸šåŠ¡ æ–¹æ³•ï¼Œ æ­¤æ—¶åº”è¯¥æœ‰ handler å’Œ connæ˜¯ç»‘å®šçš„</span><br>            dealConn := NewConntion(conn, cid, s.Router)<br>            cid ++<br>            <span class="hljs-comment">//3.4 å¯åŠ¨å½“å‰é“¾æ¥çš„å¤„ç†ä¸šåŠ¡</span><br>            <span class="hljs-keyword">go</span> dealConn.Start()<br>        &#125;<br>    &#125;()<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Server)</span></span> Stop() &#123;<br>    fmt.Println(<span class="hljs-string">&quot;[STOP] Zinx server , name &quot;</span> , s.Name)<br>    <span class="hljs-comment">//TODO  Server.Stop() å°†å…¶ä»–éœ€è¦æ¸…ç†çš„è¿æ¥ä¿¡æ¯æˆ–è€…å…¶ä»–ä¿¡æ¯ ä¹Ÿè¦ä¸€å¹¶åœæ­¢æˆ–è€…æ¸…ç†</span><br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Server)</span></span> Serve() &#123;<br>    s.Start()<br>    <span class="hljs-comment">//TODO Server.Serve() æ˜¯å¦åœ¨å¯åŠ¨æœåŠ¡çš„æ—¶å€™ è¿˜è¦å¤„ç†å…¶ä»–çš„äº‹æƒ…å‘¢ å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ </span><br>    <span class="hljs-comment">//é˜»å¡,å¦åˆ™ä¸»Goé€€å‡ºï¼Œ listennerçš„goå°†ä¼šé€€å‡º</span><br>    <span class="hljs-keyword">for</span> &#123;<br>        time.Sleep(<span class="hljs-number">10</span>*time.Second)<br>    &#125;<br>&#125;<br><span class="hljs-comment">//è·¯ç”±åŠŸèƒ½ï¼šç»™å½“å‰æœåŠ¡æ³¨å†Œä¸€ä¸ªè·¯ç”±ä¸šåŠ¡æ–¹æ³•ï¼Œä¾›å®¢æˆ·ç«¯é“¾æ¥å¤„ç†ä½¿ç”¨</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Server)</span></span>AddRouter(router ziface.IRouter) &#123;<br>    s.Router = router<br>    fmt.Println(<span class="hljs-string">&quot;Add Router succ! &quot;</span> )<br>&#125;<br></code></pre></td></tr></table></figure>
<p>åœ¨<code>connnection</code>åŒæ ·è¦åŠ ä¸Šç›¸åº”çš„è·¯ç”±å¯¹åº”çš„æ–¹æ³•</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> znet<br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;fmt&quot;</span><br>    <span class="hljs-string">&quot;net&quot;</span><br>    <span class="hljs-string">&quot;zinx/ziface&quot;</span><br>)<br><span class="hljs-keyword">type</span> Connection <span class="hljs-keyword">struct</span> &#123;<br>    <span class="hljs-comment">//å½“å‰è¿æ¥çš„socket TCPå¥—æ¥å­—</span><br>    Conn *net.TCPConn<br>    <span class="hljs-comment">//å½“å‰è¿æ¥çš„ID ä¹Ÿå¯ä»¥ç§°ä½œä¸ºSessionIDï¼ŒIDå…¨å±€å”¯ä¸€</span><br>    ConnID <span class="hljs-type">uint32</span><br>    <span class="hljs-comment">//å½“å‰è¿æ¥çš„å…³é—­çŠ¶æ€</span><br>    isClosed <span class="hljs-type">bool</span><br>    <span class="hljs-comment">//è¯¥è¿æ¥çš„å¤„ç†æ–¹æ³•router</span><br>    Router  ziface.IRouter<br>    <span class="hljs-comment">//å‘ŠçŸ¥è¯¥é“¾æ¥å·²ç»é€€å‡º/åœæ­¢çš„channel</span><br>    ExitBuffChan <span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span><br>&#125;<br><span class="hljs-comment">//åˆ›å»ºè¿æ¥çš„æ–¹æ³•</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewConntion</span><span class="hljs-params">(conn *net.TCPConn, connID <span class="hljs-type">uint32</span>, router ziface.IRouter)</span></span> *Connection&#123;<br>    c := &amp;Connection&#123;<br>        Conn:     conn,<br>        ConnID:   connID,<br>        isClosed: <span class="hljs-literal">false</span>,<br>        Router: router,<br>        ExitBuffChan: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span>, <span class="hljs-number">1</span>),<br>    &#125;<br>    <span class="hljs-keyword">return</span> c<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Connection)</span></span> StartReader() &#123;<br>    fmt.Println(<span class="hljs-string">&quot;Reader Goroutine is  running&quot;</span>)<br>    <span class="hljs-keyword">defer</span> fmt.Println(c.RemoteAddr().String(), <span class="hljs-string">&quot; conn reader exit!&quot;</span>)<br>    <span class="hljs-keyword">defer</span> c.Stop()<br>    <span class="hljs-keyword">for</span>  &#123;<br>        <span class="hljs-comment">//è¯»å–æˆ‘ä»¬æœ€å¤§çš„æ•°æ®åˆ°bufä¸­</span><br>        buf := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, <span class="hljs-number">512</span>)<br>        _, err := c.Conn.Read(buf)<br>        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>            fmt.Println(<span class="hljs-string">&quot;recv buf err &quot;</span>, err)<br>            c.ExitBuffChan &lt;- <span class="hljs-literal">true</span><br>            <span class="hljs-keyword">continue</span><br>        &#125;<br>        <span class="hljs-comment">//å¾—åˆ°å½“å‰å®¢æˆ·ç«¯è¯·æ±‚çš„Requestæ•°æ®</span><br>        req := Request&#123;<br>            conn:c,<br>            data:buf,<br>        &#125;<br>        <span class="hljs-comment">//ä»è·¯ç”±Routers ä¸­æ‰¾åˆ°æ³¨å†Œç»‘å®šConnçš„å¯¹åº”Handle</span><br>        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(request ziface.IRequest)</span></span> &#123;<br>            <span class="hljs-comment">//æ‰§è¡Œæ³¨å†Œçš„è·¯ç”±æ–¹æ³•</span><br>            c.Router.PreHandle(request)<br>            c.Router.Handle(request)<br>            c.Router.PostHandle(request)<br>        &#125;(&amp;req)<br>    &#125;<br>&#125;<br><span class="hljs-comment">//å¯åŠ¨è¿æ¥ï¼Œè®©å½“å‰è¿æ¥å¼€å§‹å·¥ä½œ</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Connection)</span></span> Start() &#123;<br>    <span class="hljs-comment">//å¼€å¯å¤„ç†è¯¥é“¾æ¥è¯»å–åˆ°å®¢æˆ·ç«¯æ•°æ®ä¹‹åçš„è¯·æ±‚ä¸šåŠ¡</span><br>    <span class="hljs-keyword">go</span> c.StartReader()<br>    <span class="hljs-keyword">for</span> &#123;<br>        <span class="hljs-keyword">select</span> &#123;<br>        <span class="hljs-keyword">case</span> &lt;- c.ExitBuffChan:<br>            <span class="hljs-comment">//å¾—åˆ°é€€å‡ºæ¶ˆæ¯ï¼Œä¸å†é˜»å¡</span><br>            <span class="hljs-keyword">return</span><br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-comment">//åœæ­¢è¿æ¥ï¼Œç»“æŸå½“å‰è¿æ¥çŠ¶æ€M</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Connection)</span></span> Stop() &#123;<br>    <span class="hljs-comment">//1. å¦‚æœå½“å‰é“¾æ¥å·²ç»å…³é—­</span><br>    <span class="hljs-keyword">if</span> c.isClosed == <span class="hljs-literal">true</span> &#123;<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    c.isClosed = <span class="hljs-literal">true</span><br>    <span class="hljs-comment">//TODO Connection Stop() å¦‚æœç”¨æˆ·æ³¨å†Œäº†è¯¥é“¾æ¥çš„å…³é—­å›è°ƒä¸šåŠ¡ï¼Œé‚£ä¹ˆåœ¨æ­¤åˆ»åº”è¯¥æ˜¾ç¤ºè°ƒç”¨</span><br>    <span class="hljs-comment">// å…³é—­socketé“¾æ¥</span><br>    c.Conn.Close()<br>    <span class="hljs-comment">//é€šçŸ¥ä»ç¼“å†²é˜Ÿåˆ—è¯»æ•°æ®çš„ä¸šåŠ¡ï¼Œè¯¥é“¾æ¥å·²ç»å…³é—­</span><br>    c.ExitBuffChan &lt;- <span class="hljs-literal">true</span><br>    <span class="hljs-comment">//å…³é—­è¯¥é“¾æ¥å…¨éƒ¨ç®¡é“</span><br>    <span class="hljs-built_in">close</span>(c.ExitBuffChan)<br>&#125;<br><span class="hljs-comment">//ä»å½“å‰è¿æ¥è·å–åŸå§‹çš„socket TCPConn</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Connection)</span></span> GetTCPConnection() *net.TCPConn &#123;<br>    <span class="hljs-keyword">return</span> c.Conn<br>&#125;<br><span class="hljs-comment">//è·å–å½“å‰è¿æ¥ID</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Connection)</span></span> GetConnID() <span class="hljs-type">uint32</span>&#123;<br>    <span class="hljs-keyword">return</span> c.ConnID<br>&#125;<br><span class="hljs-comment">//è·å–è¿œç¨‹å®¢æˆ·ç«¯åœ°å€ä¿¡æ¯</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Connection)</span></span> RemoteAddr() net.Addr &#123;<br>    <span class="hljs-keyword">return</span> c.Conn.RemoteAddr()<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h2><h3 id="Server-go"><a href="#Server-go" class="headerlink" title="Server.go"></a>Server.go</h3><blockquote>
<p>æˆ‘ä»¬è¿™é‡Œè‡ªå®šä¹‰äº†ä¸€ä¸ªç±»ä¼¼ Ping æ“ä½œçš„è·¯ç”±ï¼Œå°±æ˜¯å½“å®¢æˆ·ç«¯å‘é€æ•°æ®ï¼Œæˆ‘ä»¬çš„å¤„ç†ä¸šåŠ¡å°±æ˜¯è¿”å›ç»™å®¢æˆ·ç«¯â€ping..ping..ping..â€, ä¸ºäº†æµ‹è¯•ï¼Œå½“å‰è·¯ç”±ä¹ŸåŒæ—¶å®ç°äº† PreHandle å’Œ PostHandle ä¸¤ä¸ªæ–¹æ³•ã€‚å®é™…ä¸Š Zinx ä¼šåˆ©ç”¨æ¨¡æ¿çš„è®¾è®¡æ¨¡å¼ï¼Œä¾æ¬¡åœ¨æ¡†æ¶ä¸­è°ƒç”¨<code>PreHandle</code>ã€<code>Handle</code>ã€<code>PostHandle</code>ä¸‰ä¸ªæ–¹æ³•ã€‚</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;fmt&quot;</span><br>    <span class="hljs-string">&quot;zinx/ziface&quot;</span><br>    <span class="hljs-string">&quot;zinx/znet&quot;</span><br>)<br><span class="hljs-comment">//ping test è‡ªå®šä¹‰è·¯ç”±</span><br><span class="hljs-keyword">type</span> PingRouter <span class="hljs-keyword">struct</span> &#123;<br>    znet.BaseRouter <span class="hljs-comment">//ä¸€å®šè¦å…ˆåŸºç¡€BaseRouter</span><br>&#125;<br><span class="hljs-comment">//Test PreHandle</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *PingRouter)</span></span> PreHandle(request ziface.IRequest) &#123;<br>    fmt.Println(<span class="hljs-string">&quot;Call Router PreHandle&quot;</span>)<br>    _, err := request.GetConnection().GetTCPConnection().Write([]<span class="hljs-type">byte</span>(<span class="hljs-string">&quot;before ping ....\n&quot;</span>))<br>    <span class="hljs-keyword">if</span> err !=<span class="hljs-literal">nil</span> &#123;<br>        fmt.Println(<span class="hljs-string">&quot;call back ping ping ping error&quot;</span>)<br>    &#125;<br>&#125;<br><span class="hljs-comment">//Test Handle</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *PingRouter)</span></span> Handle(request ziface.IRequest) &#123;<br>    fmt.Println(<span class="hljs-string">&quot;Call PingRouter Handle&quot;</span>)<br>    _, err := request.GetConnection().GetTCPConnection().Write([]<span class="hljs-type">byte</span>(<span class="hljs-string">&quot;ping...ping...ping\n&quot;</span>))<br>    <span class="hljs-keyword">if</span> err !=<span class="hljs-literal">nil</span> &#123;<br>        fmt.Println(<span class="hljs-string">&quot;call back ping ping ping error&quot;</span>)<br>    &#125;<br>&#125;<br><span class="hljs-comment">//Test PostHandle</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *PingRouter)</span></span> PostHandle(request ziface.IRequest) &#123;<br>    fmt.Println(<span class="hljs-string">&quot;Call Router PostHandle&quot;</span>)<br>    _, err := request.GetConnection().GetTCPConnection().Write([]<span class="hljs-type">byte</span>(<span class="hljs-string">&quot;After ping .....\n&quot;</span>))<br>    <span class="hljs-keyword">if</span> err !=<span class="hljs-literal">nil</span> &#123;<br>        fmt.Println(<span class="hljs-string">&quot;call back ping ping ping error&quot;</span>)<br>    &#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-comment">//åˆ›å»ºä¸€ä¸ªserverå¥æŸ„</span><br>    s := znet.NewServer(<span class="hljs-string">&quot;[zinx V0.3]&quot;</span>)<br>    s.AddRouter(&amp;PingRouter&#123;&#125;)<br>    <span class="hljs-comment">//2 å¼€å¯æœåŠ¡</span><br>    s.Serve()<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="Client-go"><a href="#Client-go" class="headerlink" title="Client.go"></a>Client.go</h3><p>ä»£ç ä¸å˜</p>
<h1 id="v0-4-å…¨å±€é…ç½®æ¨¡å—"><a href="#v0-4-å…¨å±€é…ç½®æ¨¡å—" class="headerlink" title="[v0.4] å…¨å±€é…ç½®æ¨¡å—"></a>[v0.4] å…¨å±€é…ç½®æ¨¡å—</h1><blockquote>
<p>å¢åŠ ä¸€ä¸ªé…ç½®æ–‡ä»¶<code>zinx.json</code>ï¼Œä¿å­˜æœåŠ¡å™¨çš„å„é¡¹å±æ€§ï¼Œæ–¹ä¾¿ä¿®æ”¹æœåŠ¡å™¨çš„å‚æ•°</p>
</blockquote>
<h2 id="åŠŸèƒ½-1"><a href="#åŠŸèƒ½-1" class="headerlink" title="åŠŸèƒ½"></a>åŠŸèƒ½</h2><p><img src="../../../images/Zinx/fae2156087d3ad046eff80d3ac265f67-0.png" alt="img"></p>
<blockquote>
<p><strong>æ¶‰åŠçŸ¥è¯†ç‚¹ï¼š</strong></p>
<ol>
<li>jsonæ ¼å¼é—®é¢˜</li>
<li>å…¨å±€é…ç½®æ–‡ä»¶çš„å¥½å¤„</li>
</ol>
</blockquote>
<p>åœ¨<code>zinx</code>ç›®å½•ä¸‹æ–°å»º<code>utils</code>æ–‡ä»¶å¤¹ï¼Œåœ¨<code>utils</code>æ–‡ä»¶å¤¹ä¸‹æ–°å»º<code>globalobj.go</code>æ–‡ä»¶ï¼Œè¿™ä¸ªgoæ–‡ä»¶å°±æ˜¯å®ç°é…ç½®æ–‡ä»¶è¯»å–ä¸è¾“å‡ºçš„åŠŸèƒ½ã€‚</p>
<h2 id="é…ç½®æ–‡ä»¶"><a href="#é…ç½®æ–‡ä»¶" class="headerlink" title="é…ç½®æ–‡ä»¶"></a>é…ç½®æ–‡ä»¶</h2><p>åœ¨<code>zinx</code>ä¸‹æ–°å»º<code>conf</code>æ–‡ä»¶ä¸‹ï¼Œåœ¨å…¶ä¸‹æ–°å»º<code>zinx.json</code>é…ç½®æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;Name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;demo server&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;Host&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;127.0.0.1&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;TcpPort&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">7777</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;MaxConn&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><br>  <span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>
<p>ä»<code>globalobj.go</code>çš„åŠŸèƒ½æ¥çœ‹ï¼Œè¿™é‡Œå¯ä»¥è®¾ç½®ä½ æ‰€æœ‰çš„éœ€è¦åŠ å…¥åˆ°æœåŠ¡å™¨çš„é…ç½®ï¼Œä»¥<code>GlobalObj</code>ç»“æ„ä½“ä¸­çš„æ•°æ®æˆå‘˜ä¸ºä¸»ã€‚</p>
<h2 id="globalobj-go"><a href="#globalobj-go" class="headerlink" title="globalobj.go"></a>globalobj.go</h2><p>å¯¹æ–°æ‰‹æ¥è®²ï¼Œè¿™ä¸ªæ–‡ä»¶çš„ä»£ç ä¸­éœ€è¦å…³æ³¨çš„ä¸¤ä¸ªå‡½æ•°ï¼š</p>
<ol>
<li><code>ioutil.ReadFile</code></li>
<li><code>json.Unmarshal</code></li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> utils<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;encoding/json&quot;</span><br>	<span class="hljs-string">&quot;io/ioutil&quot;</span><br>	<span class="hljs-string">&quot;zinx/ziface&quot;</span><br>	<span class="hljs-string">&quot;fmt&quot;</span><br>)<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">	å­˜å‚¨ä¸€äº›æœ‰å…³Zinxæ¡†æ¶çš„å…¨å±€å‚æ•°ï¼Œä¾›å…¶ä»–æ¨¡å—ä½¿ç”¨</span><br><span class="hljs-comment">	ä¸€äº›å‚æ•°ä¹Ÿå¯ä»¥é€šè¿‡ç”¨æˆ·æ ¹æ®zinx.jsonæ¥é…ç½®</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-keyword">type</span> GlobalObj <span class="hljs-keyword">struct</span> &#123;<br>	tcpServer 	ziface.IServer 	<span class="hljs-comment">// å½“å‰Zinxçš„å…¨å±€Serverå¯¹è±¡</span><br>	Host 		<span class="hljs-type">string</span>			<span class="hljs-comment">// å½“å‰æœåŠ¡å™¨ä¸»æœºIP</span><br>	TcpPort		<span class="hljs-type">int</span>				<span class="hljs-comment">// å½“å‰æœåŠ¡å™¨ä¸»æœºç›‘å¬ç«¯å£å·</span><br>	Name		<span class="hljs-type">string</span>			<span class="hljs-comment">// å½“å‰æœåŠ¡å™¨åç§°</span><br>	Version		<span class="hljs-type">string</span>			<span class="hljs-comment">//	å½“å‰Zinxç‰ˆæœ¬</span><br>	MaxPacketSize <span class="hljs-type">uint32</span>		<span class="hljs-comment">// éƒ½éœ€æ•°æ®åŒ…çš„æœ€å¤§å€¼</span><br>	MaxConn		<span class="hljs-type">int</span>				<span class="hljs-comment">// å½“å‰æœåŠ¡å™¨ä¸»æœºå…è®¸çš„æœ€å¤§é“¾æ¥ä¸ªæ•°</span><br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">	å®šä¹‰ä¸€ä¸ªå…¨å±€çš„å¯¹è±¡</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">var</span> GlobalObject *GlobalObj<br><br><span class="hljs-comment">// è¯»å–ç”¨æˆ·çš„é…ç½®æ–‡ä»¶</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(g *GlobalObj)</span></span> Reload()  &#123;<br>	data, err := ioutil.ReadFile(<span class="hljs-string">&quot;D:/Program Files/Go/src/zinx/conf/zinx.json&quot;</span>)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-built_in">panic</span>(err)<br>	&#125;<br><br>	<span class="hljs-comment">// å°† json æ•°æ®è§£æåˆ°structä¸­</span><br>	<span class="hljs-comment">// fmt.Printf(&quot;json: %s\n&quot;, data)</span><br>	err = json.Unmarshal(data, &amp;GlobalObject)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-built_in">panic</span>(err)<br>	&#125;<br><br>	fmt.Println(fmt.Sprintf(<span class="hljs-string">&quot;%+v&quot;</span>,*GlobalObject))<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">	æä¾›initæ–¹æ³•ï¼Œé»˜è®¤åŠ è½½</span><br><span class="hljs-comment">*/</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span>  &#123;<br>	<span class="hljs-comment">// åˆå§‹åŒ–GlobalObjectå˜é‡ï¼Œè®¾ç½®ä¸€äº›é»˜è®¤å€¼</span><br>	GlobalObject = &amp; GlobalObj&#123;<br>		Name: <span class="hljs-string">&quot;ZinxServerApp&quot;</span>,<br>		Version: <span class="hljs-string">&quot;V0.4&quot;</span>,<br>		TcpPort: <span class="hljs-number">7777</span>,<br>		Host: <span class="hljs-string">&quot;0.0.0.0&quot;</span>,<br>		MaxConn: <span class="hljs-number">12000</span>,<br>		MaxPacketSize: <span class="hljs-number">4096</span>,<br>	&#125;<br><br>	<span class="hljs-comment">// ä»é…ç½®æ–‡ä»¶ä¸­åŠ è½½ä¸€äº›ç”¨æˆ·é…ç½®çš„å‚æ•°</span><br>	GlobalObject.Reload()<br>&#125;<br></code></pre></td></tr></table></figure>
<h1 id="V0-5-æ¶ˆæ¯å°è£…"><a href="#V0-5-æ¶ˆæ¯å°è£…" class="headerlink" title="[V0.5] æ¶ˆæ¯å°è£…"></a>[V0.5] æ¶ˆæ¯å°è£…</h1><h2 id="åŠŸèƒ½-2"><a href="#åŠŸèƒ½-2" class="headerlink" title="åŠŸèƒ½"></a>åŠŸèƒ½</h2><p>0.5ç‰ˆæœ¬è¦åšçš„å°±æ˜¯æŠŠæœåŠ¡å™¨çš„å…¨éƒ¨æ•°æ®éƒ½æ”¾åœ¨ä¸€ä¸ª<code>Request</code>é‡Œï¼š</p>
<p><img src="../../../images/Zinx/6d7f33a39b83c1cf24710d1e3a071c73-0.png" alt="img"></p>
<blockquote>
<p><strong>æ¶‰åŠçŸ¥è¯†ç‚¹ï¼š</strong></p>
<ol>
<li>tcpå°åŒ…æ‹†åŒ…</li>
<li>æ¶ˆæ¯å°è£…</li>
</ol>
</blockquote>
<h2 id="åˆ›å»ºæ¶ˆæ¯å°è£…ç±»å‹"><a href="#åˆ›å»ºæ¶ˆæ¯å°è£…ç±»å‹" class="headerlink" title="åˆ›å»ºæ¶ˆæ¯å°è£…ç±»å‹"></a>åˆ›å»ºæ¶ˆæ¯å°è£…ç±»å‹</h2><p>å½“å‰çš„<code>Request</code>ç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Request <span class="hljs-keyword">struct</span> &#123;<br>    conn ziface.IConnection <span class="hljs-comment">//å·²ç»å’Œå®¢æˆ·ç«¯å»ºç«‹å¥½çš„é“¾æ¥</span><br>    data []<span class="hljs-type">byte</span>             <span class="hljs-comment">//å®¢æˆ·ç«¯è¯·æ±‚çš„æ•°æ®</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>åˆ›å»ºæ¶ˆæ¯å°è£…çš„ç»“æ„ä½“ä»¥åŠç›¸å…³æ–¹æ³•ï¼š</p>
<h2 id="imessage-go"><a href="#imessage-go" class="headerlink" title="imessage.go"></a>imessage.go</h2><p>åœ¨<code>zinx/ziface/</code>ä¸‹åˆ›å»º<code>imessage.go</code>æ–‡ä»¶: å°†è¯·æ±‚çš„ä¸€ä¸ªæ¶ˆæ¯å°è£…åˆ° message ä¸­ï¼Œå®šä¹‰æŠ½è±¡å±‚æ¥å£ï¼Œå®šä¹‰å¥½ Getter æ–¹æ³•å’Œ Setter æ–¹æ³•ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> ziface<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">	å°†è¯·æ±‚çš„ä¸€ä¸ªæ¶ˆæ¯å°è£…åˆ°messageä¸­ï¼Œå®šä¹‰æŠ½è±¡å±‚æ¥å£</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-keyword">type</span> IMessage <span class="hljs-keyword">interface</span> &#123;<br>	GetDataLen() <span class="hljs-type">uint32</span> <span class="hljs-comment">// è·å–æ¶ˆæ¯æ•°æ®æ®µé•¿åº¦</span><br>	GetMsgId() <span class="hljs-type">uint32</span>	<span class="hljs-comment">// è·å–æ¶ˆæ¯ID</span><br>	GetData() []<span class="hljs-type">byte</span>	<span class="hljs-comment">// è·å–æ¶ˆæ¯å†…å®¹</span><br>	SetMsgId(<span class="hljs-type">uint32</span>)	<span class="hljs-comment">// è®¾ç½®æ¶ˆæ¯ID</span><br>	SetData([]<span class="hljs-type">byte</span>)		<span class="hljs-comment">// è®¾ç½®æ¶ˆæ¯å†…å®¹</span><br>	SetDataLen(<span class="hljs-type">uint32</span>)	<span class="hljs-comment">// è®¾ç½®æ¶ˆæ¯æ•°æ®æ®µé•¿åº¦</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="message-go"><a href="#message-go" class="headerlink" title="message.go"></a>message.go</h2><p>åŒæ—¶åˆ›å»ºå®ä¾‹ message ç±»ï¼Œåœ¨<code>zinx/znet/</code>ä¸‹ï¼Œåˆ›å»º<code>message.go</code>æ–‡ä»¶ã€‚</p>
<p>æ•´ç†ä¸€ä¸ªåŸºæœ¬çš„ message åŒ…ï¼Œä¼šåŒ…å«<strong>æ¶ˆæ¯ ID</strong>ï¼Œ<strong>æ•°æ®</strong>ï¼Œ<strong>æ•°æ®é•¿åº¦</strong>ä¸‰ä¸ªæˆå‘˜ï¼Œæä¾›åŸºæœ¬çš„ setter å’Œ getter æ–¹æ³•ï¼Œç›®çš„æ˜¯ä¸ºäº†ä»¥ååšå°è£…ä¼˜åŒ–çš„ä½œç”¨ã€‚åŒæ—¶ä¹Ÿæä¾›äº†ä¸€ä¸ªåˆ›å»ºä¸€ä¸ª message åŒ…çš„åˆå§‹åŒ–æ–¹æ³•<code>NewMegPackage</code>ã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬åªéœ€è¦è¦å®ç° Message ç±»ï¼Œå†™å‡ºæ„é€ å‡½æ•°ï¼Œå®ç°æ¥å£ä¸­å¯¹åº”çš„æ–¹æ³•ï¼Œæ¯”è¾ƒçš„ç®€å•ï¼Œå¤§å®¶å¯ä»¥è¯•è¯•å…ˆè‡ªå·±å°è¯•å®ç°ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> znet<br><br><span class="hljs-keyword">type</span> Message <span class="hljs-keyword">struct</span> &#123;<br>	Id		<span class="hljs-type">uint32</span> 	<span class="hljs-comment">// æ¶ˆæ¯çš„ID</span><br>	DataLen	<span class="hljs-type">uint32</span>	<span class="hljs-comment">// æ¶ˆæ¯çš„é•¿åº¦</span><br>	Data 	[]<span class="hljs-type">byte</span> 	<span class="hljs-comment">// æ¶ˆæ¯çš„å†…å®¹</span><br>&#125;<br><br><span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªMessageçš„æ¶ˆæ¯åŒ…</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewMsgPackage</span><span class="hljs-params">(id <span class="hljs-type">uint32</span>, data []<span class="hljs-type">byte</span>)</span></span> *Message &#123;<br>	<span class="hljs-keyword">return</span> &amp;Message&#123;<br>		Id: id,<br>		DataLen: <span class="hljs-type">uint32</span>(<span class="hljs-built_in">len</span>(data)),<br>		Data: data,<br>	&#125;<br>&#125;<br><br><span class="hljs-comment">// è·å–æ¶ˆæ¯æ•°æ®æ®µé•¿åº¦</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(msg *Message)</span></span> GetDataLen() <span class="hljs-type">uint32</span> &#123;<br>	<span class="hljs-keyword">return</span> msg.DataLen;<br>&#125;<br><span class="hljs-comment">//è·å–æ¶ˆæ¯ID</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(msg *Message)</span></span> GetMsgId() <span class="hljs-type">uint32</span> &#123;<br>    <span class="hljs-keyword">return</span> msg.Id<br>&#125;<br><span class="hljs-comment">//è·å–æ¶ˆæ¯å†…å®¹</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(msg *Message)</span></span> GetData() []<span class="hljs-type">byte</span> &#123;<br>    <span class="hljs-keyword">return</span> msg.Data<br>&#125;<br><span class="hljs-comment">//è®¾ç½®æ¶ˆæ¯æ•°æ®æ®µé•¿åº¦</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(msg *Message)</span></span> SetDataLen(<span class="hljs-built_in">len</span> <span class="hljs-type">uint32</span>) &#123;<br>    msg.DataLen = <span class="hljs-built_in">len</span><br>&#125;<br><span class="hljs-comment">//è®¾è®¡æ¶ˆæ¯ID</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(msg *Message)</span></span> SetMsgId(msgId <span class="hljs-type">uint32</span>) &#123;<br>    msg.Id = msgId<br>&#125;<br><span class="hljs-comment">//è®¾è®¡æ¶ˆæ¯å†…å®¹</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(msg *Message)</span></span> SetData(data []<span class="hljs-type">byte</span>) &#123;<br>    msg.Data = data<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="æ‹†åŒ…ä¸å°åŒ…"><a href="#æ‹†åŒ…ä¸å°åŒ…" class="headerlink" title="æ‹†åŒ…ä¸å°åŒ…*"></a>æ‹†åŒ…ä¸å°åŒ…<code>*</code></h2><p>é‡‡ç”¨TCL(Type-Len-Value)å°åŒ…æ ¼å¼è§£å†³TCPç²˜åŒ…é—®é¢˜</p>
<p><img src="../../../images/Zinx/c6982247c64f1a5e149a2f45adc98425.jpeg" alt="5.2 æ¶ˆæ¯çš„å°åŒ…ä¸æ‹†åŒ…  - å›¾1"></p>
<h3 id="åˆ›å»ºæ‹†åŒ…å°åŒ…æŠ½è±¡ç±»"><a href="#åˆ›å»ºæ‹†åŒ…å°åŒ…æŠ½è±¡ç±»" class="headerlink" title="åˆ›å»ºæ‹†åŒ…å°åŒ…æŠ½è±¡ç±»"></a>åˆ›å»ºæ‹†åŒ…å°åŒ…æŠ½è±¡ç±»</h3><p>åœ¨<code>zinx/ziface</code>ä¸‹ï¼Œåˆ›å»º<code>idatapack.go</code>æ–‡ä»¶</p>
<p>æˆ‘ä»¬éœ€è¦ä¸‰ä¸ªæ–¹æ³•ï¼š</p>
<ul>
<li>å°åŒ…æ•°æ®ã€‚</li>
<li>æ‹†åŒ…æ•°æ®ã€‚</li>
<li>å¾—åˆ°å¤´éƒ¨é•¿åº¦ã€‚</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> ziface<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">    å°åŒ…æ•°æ®å’Œæ‹†åŒ…æ•°æ®</span><br><span class="hljs-comment">    ç›´æ¥é¢å‘TCPè¿æ¥ä¸­çš„æ•°æ®æµ,ä¸ºä¼ è¾“æ•°æ®æ·»åŠ å¤´éƒ¨ä¿¡æ¯ï¼Œç”¨äºå¤„ç†TCPç²˜åŒ…é—®é¢˜ã€‚</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">type</span> IDataPack <span class="hljs-keyword">interface</span>&#123;<br>    GetHeadLen() <span class="hljs-type">uint32</span>                    <span class="hljs-comment">//è·å–åŒ…å¤´é•¿åº¦æ–¹æ³•</span><br>    Pack(msg IMessage)([]<span class="hljs-type">byte</span>, <span class="hljs-type">error</span>)    <span class="hljs-comment">//å°åŒ…æ–¹æ³•</span><br>    Unpack([]<span class="hljs-type">byte</span>)(IMessage, <span class="hljs-type">error</span>)        <span class="hljs-comment">//æ‹†åŒ…æ–¹æ³•</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="å®ç°æ‹†åŒ…å°åŒ…ç±»"><a href="#å®ç°æ‹†åŒ…å°åŒ…ç±»" class="headerlink" title="å®ç°æ‹†åŒ…å°åŒ…ç±»"></a>å®ç°æ‹†åŒ…å°åŒ…ç±»</h3><p>åœ¨<code>zinx/znet/</code>ä¸‹ï¼Œåˆ›å»º<code>datapack.go</code>æ–‡ä»¶.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> znet<br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;bytes&quot;</span><br>    <span class="hljs-string">&quot;encoding/binary&quot;</span><br>    <span class="hljs-string">&quot;errors&quot;</span><br>    <span class="hljs-string">&quot;zinx/utils&quot;</span><br>    <span class="hljs-string">&quot;zinx/ziface&quot;</span><br>)<br><span class="hljs-comment">//å°åŒ…æ‹†åŒ…ç±»å®ä¾‹ï¼Œæš‚æ—¶ä¸éœ€è¦æˆå‘˜</span><br><span class="hljs-keyword">type</span> DataPack <span class="hljs-keyword">struct</span> &#123;&#125;<br><span class="hljs-comment">//å°åŒ…æ‹†åŒ…å®ä¾‹åˆå§‹åŒ–æ–¹æ³•</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewDataPack</span><span class="hljs-params">()</span></span> *DataPack &#123;<br>    <span class="hljs-keyword">return</span> &amp;DataPack&#123;&#125;<br>&#125;<br><span class="hljs-comment">//è·å–åŒ…å¤´é•¿åº¦æ–¹æ³•</span><br><span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(dp *DataPack)</span></span> GetHeadLen() <span class="hljs-type">uint32</span> &#123;<br>    <span class="hljs-comment">//Id uint32(4å­—èŠ‚) +  DataLen uint32(4å­—èŠ‚)</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">8</span><br>&#125;<br><span class="hljs-comment">//å°åŒ…æ–¹æ³•(å‹ç¼©æ•°æ®)</span><br><span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(dp *DataPack)</span></span> Pack(msg ziface.IMessage)([]<span class="hljs-type">byte</span>, <span class="hljs-type">error</span>) &#123;<br>    <span class="hljs-comment">//åˆ›å»ºä¸€ä¸ªå­˜æ”¾byteså­—èŠ‚çš„ç¼“å†²</span><br>    dataBuff := bytes.NewBuffer([]<span class="hljs-type">byte</span>&#123;&#125;)<br>    <span class="hljs-comment">//å†™dataLen</span><br>    <span class="hljs-keyword">if</span> err := binary.Write(dataBuff, binary.LittleEndian, msg.GetDataLen()); err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>    &#125;<br>    <span class="hljs-comment">//å†™msgID</span><br>    <span class="hljs-keyword">if</span> err := binary.Write(dataBuff, binary.LittleEndian, msg.GetMsgId()); err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>    &#125;<br>    <span class="hljs-comment">//å†™dataæ•°æ®</span><br>    <span class="hljs-keyword">if</span> err := binary.Write(dataBuff, binary.LittleEndian, msg.GetData()); err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span> ,err<br>    &#125;<br>    <span class="hljs-keyword">return</span> dataBuff.Bytes(), <span class="hljs-literal">nil</span><br>&#125;<br><span class="hljs-comment">//æ‹†åŒ…æ–¹æ³•(è§£å‹æ•°æ®)</span><br><span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(dp *DataPack)</span></span> Unpack(binaryData []<span class="hljs-type">byte</span>)(ziface.IMessage, <span class="hljs-type">error</span>) &#123;<br>    <span class="hljs-comment">//åˆ›å»ºä¸€ä¸ªä»è¾“å…¥äºŒè¿›åˆ¶æ•°æ®çš„ioReader</span><br>    dataBuff := bytes.NewReader(binaryData)<br>    <span class="hljs-comment">//åªè§£å‹headçš„ä¿¡æ¯ï¼Œå¾—åˆ°dataLenå’ŒmsgID</span><br>    msg := &amp;Message&#123;&#125;<br>    <span class="hljs-comment">//è¯»dataLen</span><br>    <span class="hljs-keyword">if</span> err := binary.Read(dataBuff, binary.LittleEndian, &amp;msg.DataLen); err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>    &#125;<br>    <span class="hljs-comment">//è¯»msgID</span><br>    <span class="hljs-keyword">if</span> err := binary.Read(dataBuff, binary.LittleEndian, &amp;msg.Id); err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>    &#125;<br>    <span class="hljs-comment">//åˆ¤æ–­dataLençš„é•¿åº¦æ˜¯å¦è¶…å‡ºæˆ‘ä»¬å…è®¸çš„æœ€å¤§åŒ…é•¿åº¦</span><br>    <span class="hljs-keyword">if</span> (utils.GlobalObject.MaxPacketSize &gt; <span class="hljs-number">0</span> &amp;&amp; msg.DataLen &gt; utils.GlobalObject.MaxPacketSize) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.New(<span class="hljs-string">&quot;Too large msg data recieved&quot;</span>)<br>    &#125;<br>    <span class="hljs-comment">//è¿™é‡Œåªéœ€è¦æŠŠheadçš„æ•°æ®æ‹†åŒ…å‡ºæ¥å°±å¯ä»¥äº†ï¼Œç„¶åå†é€šè¿‡headçš„é•¿åº¦ï¼Œå†ä»connè¯»å–ä¸€æ¬¡æ•°æ®</span><br>    <span class="hljs-keyword">return</span> msg, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>éœ€è¦æ³¨æ„çš„æ˜¯æ•´ç†çš„<code>Unpack</code>æ–¹æ³•ï¼Œå› ä¸ºæˆ‘ä»¬ä»ä¸Šå›¾å¯ä»¥çŸ¥é“ï¼Œæˆ‘ä»¬è¿›è¡Œæ‹†åŒ…çš„æ—¶å€™æ˜¯åˆ†ä¸¤æ¬¡è¿‡ç¨‹çš„ï¼Œç¬¬äºŒæ¬¡æ˜¯ä¾èµ–ç¬¬ä¸€æ¬¡çš„ dataLen ç»“æœï¼Œæ‰€ä»¥<code>Unpack</code>åªèƒ½è§£å‹å‡ºåŒ…å¤´ head çš„å†…å®¹ï¼Œå¾—åˆ° msgId å’Œ dataLenã€‚ä¹‹åè°ƒç”¨è€…å†æ ¹æ® dataLen ç»§ç»­ä» io æµä¸­è¯»å– body ä¸­çš„æ•°æ®ã€‚</p>
<h3 id="æµ‹è¯•æ‹†åŒ…ä¸å°åŒ…ç±»å‹"><a href="#æµ‹è¯•æ‹†åŒ…ä¸å°åŒ…ç±»å‹" class="headerlink" title="æµ‹è¯•æ‹†åŒ…ä¸å°åŒ…ç±»å‹"></a>æµ‹è¯•æ‹†åŒ…ä¸å°åŒ…ç±»å‹</h3><p>å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<ul>
<li>Server.go</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;fmt&quot;</span><br>    <span class="hljs-string">&quot;io&quot;</span><br>    <span class="hljs-string">&quot;net&quot;</span><br>    <span class="hljs-string">&quot;zinx/znet&quot;</span><br>)<br><span class="hljs-comment">//åªæ˜¯è´Ÿè´£æµ‹è¯•datapackæ‹†åŒ…ï¼Œå°åŒ…åŠŸèƒ½</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-comment">//åˆ›å»ºsocket TCP Server</span><br>    listener, err := net.Listen(<span class="hljs-string">&quot;tcp&quot;</span>, <span class="hljs-string">&quot;127.0.0.1:7777&quot;</span>)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        fmt.Println(<span class="hljs-string">&quot;server listen err:&quot;</span>, err)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    <span class="hljs-comment">//åˆ›å»ºæœåŠ¡å™¨gotoutineï¼Œè´Ÿè´£ä»å®¢æˆ·ç«¯goroutineè¯»å–ç²˜åŒ…çš„æ•°æ®ï¼Œç„¶åè¿›è¡Œè§£æ</span><br>    <span class="hljs-keyword">for</span> &#123;<br>        conn, err := listener.Accept()<br>        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>            fmt.Println(<span class="hljs-string">&quot;server accept err:&quot;</span>, err)<br>        &#125;<br>        <span class="hljs-comment">//å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚</span><br>        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(conn net.Conn)</span></span> &#123;<br>            <span class="hljs-comment">//åˆ›å»ºå°åŒ…æ‹†åŒ…å¯¹è±¡dp</span><br>            dp := znet.NewDataPack()<br>            <span class="hljs-keyword">for</span> &#123;<br>                <span class="hljs-comment">//1 å…ˆè¯»å‡ºæµä¸­çš„headéƒ¨åˆ†</span><br>                headData := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, dp.GetHeadLen())<br>                _, err := io.ReadFull(conn, headData) <span class="hljs-comment">//ReadFull ä¼šæŠŠmsgå¡«å……æ»¡ä¸ºæ­¢</span><br>                <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>                    fmt.Println(<span class="hljs-string">&quot;read head error&quot;</span>)<br>                    <span class="hljs-keyword">break</span><br>                &#125;<br>                <span class="hljs-comment">//å°†headDataå­—èŠ‚æµ æ‹†åŒ…åˆ°msgä¸­</span><br>                msgHead, err := dp.Unpack(headData)<br>                <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>                    fmt.Println(<span class="hljs-string">&quot;server unpack err:&quot;</span>, err)<br>                    <span class="hljs-keyword">return</span><br>                &#125;<br>                <span class="hljs-keyword">if</span> msgHead.GetDataLen() &gt; <span class="hljs-number">0</span> &#123;<br>                    <span class="hljs-comment">//msg æ˜¯æœ‰dataæ•°æ®çš„ï¼Œéœ€è¦å†æ¬¡è¯»å–dataæ•°æ®</span><br>                    <span class="hljs-comment">//`*`æ˜¯æŒ‡é’ˆè¿ç®—ç¬¦ , å¯ä»¥è¡¨ç¤ºä¸€ä¸ªå˜é‡æ˜¯**æŒ‡é’ˆç±»å‹** , ä¹Ÿå¯ä»¥è¡¨ç¤º**ä¸€ä¸ªæŒ‡é’ˆå˜é‡æ‰€æŒ‡å‘çš„å­˜å‚¨å•å…ƒ** , ä¹Ÿå°±æ˜¯è¿™ä¸ªåœ°å€æ‰€å­˜å‚¨çš„å€¼ .</span><br>                    msg := msgHead.(*znet.Message)<br>                    msg.Data = <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, msg.GetDataLen())<br>                    <span class="hljs-comment">//æ ¹æ®dataLenä»ioä¸­è¯»å–å­—èŠ‚æµ</span><br>                    _, err := io.ReadFull(conn, msg.Data)<br>                    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>                        fmt.Println(<span class="hljs-string">&quot;server unpack data err:&quot;</span>, err)<br>                        <span class="hljs-keyword">return</span><br>                    &#125;<br>                    fmt.Println(<span class="hljs-string">&quot;==&gt; Recv Msg: ID=&quot;</span>, msg.Id, <span class="hljs-string">&quot;, len=&quot;</span>, msg.DataLen, <span class="hljs-string">&quot;, data=&quot;</span>, <span class="hljs-type">string</span>(msg.Data))<br>                &#125;<br>            &#125;<br>        &#125;(conn)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<ul>
<li>Client.go</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;fmt&quot;</span><br>    <span class="hljs-string">&quot;net&quot;</span><br>    <span class="hljs-string">&quot;zinx/znet&quot;</span><br>)<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-comment">//å®¢æˆ·ç«¯goroutineï¼Œè´Ÿè´£æ¨¡æ‹Ÿç²˜åŒ…çš„æ•°æ®ï¼Œç„¶åè¿›è¡Œå‘é€</span><br>    conn, err := net.Dial(<span class="hljs-string">&quot;tcp&quot;</span>, <span class="hljs-string">&quot;127.0.0.1:7777&quot;</span>)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        fmt.Println(<span class="hljs-string">&quot;client dial err:&quot;</span>, err)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    <span class="hljs-comment">//åˆ›å»ºä¸€ä¸ªå°åŒ…å¯¹è±¡ dp</span><br>    dp := znet.NewDataPack()<br>    <span class="hljs-comment">//å°è£…ä¸€ä¸ªmsg1åŒ…</span><br>    msg1 := &amp;znet.Message&#123;<br>        Id:      <span class="hljs-number">0</span>,<br>        DataLen: <span class="hljs-number">5</span>,<br>        Data:    []<span class="hljs-type">byte</span>&#123;<span class="hljs-string">&#x27;h&#x27;</span>, <span class="hljs-string">&#x27;e&#x27;</span>, <span class="hljs-string">&#x27;l&#x27;</span>, <span class="hljs-string">&#x27;l&#x27;</span>, <span class="hljs-string">&#x27;o&#x27;</span>&#125;,<br>    &#125;<br>    sendData1, err := dp.Pack(msg1)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        fmt.Println(<span class="hljs-string">&quot;client pack msg1 err:&quot;</span>, err)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    msg2 := &amp;znet.Message&#123;<br>        Id:      <span class="hljs-number">1</span>,<br>        DataLen: <span class="hljs-number">7</span>,<br>        Data:    []<span class="hljs-type">byte</span>&#123;<span class="hljs-string">&#x27;w&#x27;</span>, <span class="hljs-string">&#x27;o&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>, <span class="hljs-string">&#x27;l&#x27;</span>, <span class="hljs-string">&#x27;d&#x27;</span>, <span class="hljs-string">&#x27;!&#x27;</span>, <span class="hljs-string">&#x27;!&#x27;</span>&#125;,<br>    &#125;<br>    sendData2, err := dp.Pack(msg2)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        fmt.Println(<span class="hljs-string">&quot;client temp msg2 err:&quot;</span>, err)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    <span class="hljs-comment">//å°†sendData1ï¼Œå’Œ sendData2 æ‹¼æ¥ä¸€èµ·ï¼Œç»„æˆç²˜åŒ…</span><br>    sendData1 = <span class="hljs-built_in">append</span>(sendData1, sendData2...)<br>    <span class="hljs-comment">//å‘æœåŠ¡å™¨ç«¯å†™æ•°æ®</span><br>    conn.Write(sendData1)<br>    <span class="hljs-comment">//å®¢æˆ·ç«¯é˜»å¡</span><br>    <span class="hljs-keyword">select</span> &#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="Requestå­—æ®µä¿®æ”¹"><a href="#Requestå­—æ®µä¿®æ”¹" class="headerlink" title="Requestå­—æ®µä¿®æ”¹"></a>Requestå­—æ®µä¿®æ”¹</h3><p>é¦–å…ˆæˆ‘ä»¬è¦å°†æˆ‘ä»¬ä¹‹å‰çš„ Request ä¸­çš„<code>[]byte</code>ç±»å‹çš„ data å­—æ®µæ”¹æˆ Message ç±»å‹.ã€‚å¹¶ä¸”æˆ‘ä»¬éœ€è¦æŠŠ irequest çš„æ–¹æ³•æ–°å¢ä¸€ä¸ª GetMsgIDã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> znet<br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;zinx/ziface&quot;</span><br><span class="hljs-keyword">type</span> Request <span class="hljs-keyword">struct</span> &#123;<br>    conn ziface.IConnection <span class="hljs-comment">//å·²ç»å’Œå®¢æˆ·ç«¯å»ºç«‹å¥½çš„ é“¾æ¥</span><br>    msg ziface.IMessage     <span class="hljs-comment">//å®¢æˆ·ç«¯è¯·æ±‚çš„æ•°æ®</span><br>&#125;<br><span class="hljs-comment">//è·å–è¯·æ±‚è¿æ¥ä¿¡æ¯</span><br><span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(r *Request)</span></span> GetConnection() ziface.IConnection &#123;<br>    <span class="hljs-keyword">return</span> r.conn<br>&#125;<br><span class="hljs-comment">//è·å–è¯·æ±‚æ¶ˆæ¯çš„æ•°æ®</span><br><span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(r *Request)</span></span> GetData() []<span class="hljs-type">byte</span> &#123;<br>    <span class="hljs-keyword">return</span> r.msg.GetData()<br>&#125;<br><span class="hljs-comment">//è·å–è¯·æ±‚çš„æ¶ˆæ¯çš„ID</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *Request)</span></span> GetMsgID() <span class="hljs-type">uint32</span> &#123;<br>    <span class="hljs-keyword">return</span> r.msg.GetMsgId()<br>&#125;<br><span class="hljs-keyword">package</span> ziface<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">   IRequest æ¥å£ï¼š</span><br><span class="hljs-comment">   å®é™…ä¸Šæ˜¯æŠŠå®¢æˆ·ç«¯è¯·æ±‚çš„é“¾æ¥ä¿¡æ¯ å’Œ è¯·æ±‚çš„æ•°æ® åŒ…è£…åˆ°äº† Requesté‡Œ</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">type</span> IRequest <span class="hljs-keyword">interface</span>&#123;<br>    GetConnection() IConnection    <span class="hljs-comment">//è·å–è¯·æ±‚è¿æ¥ä¿¡æ¯</span><br>    GetData() []<span class="hljs-type">byte</span>            <span class="hljs-comment">//è·å–è¯·æ±‚æ¶ˆæ¯çš„æ•°æ®</span><br>    GetMsgID() <span class="hljs-type">uint32</span>           <span class="hljs-comment">//huè·å–æ¶ˆæ¯çš„id</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="é›†æˆæ‹†åŒ…è¿‡ç¨‹"><a href="#é›†æˆæ‹†åŒ…è¿‡ç¨‹" class="headerlink" title="é›†æˆæ‹†åŒ…è¿‡ç¨‹"></a>é›†æˆæ‹†åŒ…è¿‡ç¨‹</h4><p>æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦åœ¨ Connection çš„<code>StartReader()</code>æ–¹æ³•ä¸­,ä¿®æ”¹ä¹‹å‰çš„è¯»å–å®¢æˆ·ç«¯çš„è¿™æ®µä»£ç ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Connection)</span></span> StartReader() &#123;<br>    <span class="hljs-comment">//...</span><br>    <span class="hljs-keyword">for</span>  &#123;<br>        <span class="hljs-comment">//è¯»å–æˆ‘ä»¬æœ€å¤§çš„æ•°æ®åˆ°bufä¸­</span><br>        buf := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, utils.GlobalObject.MaxPacketSize)<br>        _, err := c.Conn.Read(buf)<br>        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>            fmt.Println(<span class="hljs-string">&quot;recv buf err &quot;</span>, err)<br>            c.ExitBuffChan &lt;- <span class="hljs-literal">true</span><br>            <span class="hljs-keyword">continue</span><br>        &#125;<br>        <span class="hljs-comment">//...</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>å°†è¿™ä¸ªå‡½æ•°åšå‡ºå¦‚ä¸‹æ”¹é€ ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Connection)</span></span> StartReader() &#123;<br>    fmt.Println(<span class="hljs-string">&quot;Reader Goroutine is  running&quot;</span>)<br>    <span class="hljs-keyword">defer</span> fmt.Println(c.RemoteAddr().String(), <span class="hljs-string">&quot; conn reader exit!&quot;</span>)<br>    <span class="hljs-keyword">defer</span> c.Stop()<br>    <span class="hljs-keyword">for</span>  &#123;<br>        <span class="hljs-comment">// åˆ›å»ºæ‹†åŒ…è§£åŒ…çš„å¯¹è±¡</span><br>        dp := NewDataPack()<br>        <span class="hljs-comment">//è¯»å–å®¢æˆ·ç«¯çš„Msg head</span><br>        headData := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, dp.GetHeadLen())<br>        <span class="hljs-keyword">if</span> _, err := io.ReadFull(c.GetTCPConnection(), headData); err != <span class="hljs-literal">nil</span> &#123;<br>            fmt.Println(<span class="hljs-string">&quot;read msg head error &quot;</span>, err)<br>            c.ExitBuffChan &lt;- <span class="hljs-literal">true</span><br>            <span class="hljs-keyword">continue</span><br>        &#125;<br>        <span class="hljs-comment">//æ‹†åŒ…ï¼Œå¾—åˆ°msgid å’Œ datalen æ”¾åœ¨msgä¸­</span><br>        msg , err := dp.Unpack(headData)<br>        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>            fmt.Println(<span class="hljs-string">&quot;unpack error &quot;</span>, err)<br>            c.ExitBuffChan &lt;- <span class="hljs-literal">true</span><br>            <span class="hljs-keyword">continue</span><br>        &#125;<br>        <span class="hljs-comment">//æ ¹æ® dataLen è¯»å– dataï¼Œæ”¾åœ¨msg.Dataä¸­</span><br>        <span class="hljs-keyword">var</span> data []<span class="hljs-type">byte</span><br>        <span class="hljs-keyword">if</span> msg.GetDataLen() &gt; <span class="hljs-number">0</span> &#123;<br>            data = <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, msg.GetDataLen())<br>            <span class="hljs-keyword">if</span> _, err := io.ReadFull(c.GetTCPConnection(), data); err != <span class="hljs-literal">nil</span> &#123;<br>                fmt.Println(<span class="hljs-string">&quot;read msg data error &quot;</span>, err)<br>                c.ExitBuffChan &lt;- <span class="hljs-literal">true</span><br>                <span class="hljs-keyword">continue</span><br>            &#125;<br>        &#125;<br>        msg.SetData(data)<br>        <span class="hljs-comment">//å¾—åˆ°å½“å‰å®¢æˆ·ç«¯è¯·æ±‚çš„Requestæ•°æ®</span><br>        req := Request&#123;<br>            conn:c,<br>            msg:msg, <span class="hljs-comment">//å°†ä¹‹å‰çš„buf æ”¹æˆ msg</span><br>        &#125;<br>        <span class="hljs-comment">//ä»è·¯ç”±Routers ä¸­æ‰¾åˆ°æ³¨å†Œç»‘å®šConnçš„å¯¹åº”Handle</span><br>        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(request ziface.IRequest)</span></span> &#123;<br>            <span class="hljs-comment">//æ‰§è¡Œæ³¨å†Œçš„è·¯ç”±æ–¹æ³•</span><br>            c.Router.PreHandle(request)<br>            c.Router.Handle(request)<br>            c.Router.PostHandle(request)<br>        &#125;(&amp;req)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="æä¾›å°åŒ…æ–¹æ³•"><a href="#æä¾›å°åŒ…æ–¹æ³•" class="headerlink" title="æä¾›å°åŒ…æ–¹æ³•"></a>æä¾›å°åŒ…æ–¹æ³•</h4><p>ç°åœ¨æˆ‘ä»¬å·²ç»å°†æ‹†åŒ…çš„åŠŸèƒ½é›†æˆåˆ° Zinx ä¸­äº†ï¼Œä½†æ˜¯ä½¿ç”¨ Zinx çš„æ—¶å€™ï¼Œå¦‚æœæˆ‘ä»¬å¸Œæœ›ç»™ç”¨æˆ·è¿”å›ä¸€ä¸ª TLV æ ¼å¼çš„æ•°æ®ï¼Œæ€»ä¸èƒ½æ¯æ¬¡éƒ½ç»è¿‡è¿™ä¹ˆç¹ççš„è¿‡ç¨‹ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”è¯¥ç»™ Zinx æä¾›ä¸€ä¸ªå°åŒ…çš„æ¥å£ï¼Œä¾› Zinx å‘åŒ…ä½¿ç”¨ã€‚ æˆ‘ä»¬åœ¨ iconnection.go ä¸­æ–°å¢ SendMsg()æ–¹æ³•ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> ziface<br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;net&quot;</span><br><span class="hljs-comment">//å®šä¹‰è¿æ¥æ¥å£</span><br><span class="hljs-keyword">type</span> IConnection <span class="hljs-keyword">interface</span> &#123;<br>    <span class="hljs-comment">//å¯åŠ¨è¿æ¥ï¼Œè®©å½“å‰è¿æ¥å¼€å§‹å·¥ä½œ</span><br>    Start()<br>    <span class="hljs-comment">//åœæ­¢è¿æ¥ï¼Œç»“æŸå½“å‰è¿æ¥çŠ¶æ€M</span><br>    Stop()<br>    <span class="hljs-comment">//ä»å½“å‰è¿æ¥è·å–åŸå§‹çš„socket TCPConn</span><br>    GetTCPConnection() *net.TCPConn<br>    <span class="hljs-comment">//è·å–å½“å‰è¿æ¥ID</span><br>    GetConnID() <span class="hljs-type">uint32</span><br>    <span class="hljs-comment">//è·å–è¿œç¨‹å®¢æˆ·ç«¯åœ°å€ä¿¡æ¯</span><br>    RemoteAddr() net.Addr<br>    <span class="hljs-comment">//ç›´æ¥å°†Messageæ•°æ®å‘é€æ•°æ®ç»™è¿œç¨‹çš„TCPå®¢æˆ·ç«¯</span><br>    SendMsg(msgId <span class="hljs-type">uint32</span>, data []<span class="hljs-type">byte</span>) <span class="hljs-type">error</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>ç„¶åï¼Œæˆ‘ä»¬åˆ° connection.go ä¸­å®ç°è¿™ä¸ªæ–¹æ³•ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">//ç›´æ¥å°†Messageæ•°æ®å‘é€æ•°æ®ç»™è¿œç¨‹çš„TCPå®¢æˆ·ç«¯</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Connection)</span></span> SendMsg(msgId <span class="hljs-type">uint32</span>, data []<span class="hljs-type">byte</span>) <span class="hljs-type">error</span> &#123;<br>    <span class="hljs-keyword">if</span> c.isClosed == <span class="hljs-literal">true</span> &#123;<br>        <span class="hljs-keyword">return</span> errors.New(<span class="hljs-string">&quot;Connection closed when send msg&quot;</span>)<br>    &#125;<br>    <span class="hljs-comment">//å°†dataå°åŒ…ï¼Œå¹¶ä¸”å‘é€</span><br>    dp := NewDataPack()<br>    msg, err := dp.Pack(NewMsgPackage(msgId, data))<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        fmt.Println(<span class="hljs-string">&quot;Pack error msg id = &quot;</span>, msgId)<br>        <span class="hljs-keyword">return</span>  errors.New(<span class="hljs-string">&quot;Pack error msg &quot;</span>)<br>    &#125;<br>    <span class="hljs-comment">//å†™å›å®¢æˆ·ç«¯</span><br>    <span class="hljs-keyword">if</span> _, err := c.Conn.Write(msg); err != <span class="hljs-literal">nil</span> &#123;<br>        fmt.Println(<span class="hljs-string">&quot;Write msg id &quot;</span>, msgId, <span class="hljs-string">&quot; error &quot;</span>)<br>        c.ExitBuffChan &lt;- <span class="hljs-literal">true</span><br>        <span class="hljs-keyword">return</span> errors.New(<span class="hljs-string">&quot;conn Write error&quot;</span>)<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>æ³¨æ„ï¼Œåšå‡ºä¿®æ”¹åï¼Œæˆ‘ä»¬éœ€è¦åœ¨ connection.go ä¸­å°† io å’Œ errors åŒ…å¼•å…¥è¿›æ¥ã€‚</p>
<h3 id="zinx-0-5-æµ‹è¯•"><a href="#zinx-0-5-æµ‹è¯•" class="headerlink" title="zinx 0.5 æµ‹è¯•"></a>zinx 0.5 æµ‹è¯•</h3><ul>
<li>Server.go</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;fmt&quot;</span><br>    <span class="hljs-string">&quot;zinx/ziface&quot;</span><br>    <span class="hljs-string">&quot;zinx/znet&quot;</span><br>)<br><span class="hljs-comment">//ping test è‡ªå®šä¹‰è·¯ç”±</span><br><span class="hljs-keyword">type</span> PingRouter <span class="hljs-keyword">struct</span> &#123;<br>    znet.BaseRouter<br>&#125;<br><span class="hljs-comment">//Test Handle</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *PingRouter)</span></span> Handle(request ziface.IRequest) &#123;<br>    fmt.Println(<span class="hljs-string">&quot;Call PingRouter Handle&quot;</span>)<br>    <span class="hljs-comment">//å…ˆè¯»å–å®¢æˆ·ç«¯çš„æ•°æ®ï¼Œå†å›å†™ping...ping...ping</span><br>    fmt.Println(<span class="hljs-string">&quot;recv from client : msgId=&quot;</span>, request.GetMsgID(), <span class="hljs-string">&quot;, data=&quot;</span>, <span class="hljs-type">string</span>(request.GetData()))<br>    <span class="hljs-comment">//å›å†™æ•°æ®</span><br>    err := request.GetConnection().SendMsg(<span class="hljs-number">1</span>, []<span class="hljs-type">byte</span>(<span class="hljs-string">&quot;ping...ping...ping&quot;</span>))<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        fmt.Println(err)<br>    &#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-comment">//åˆ›å»ºä¸€ä¸ªserverå¥æŸ„</span><br>    s := znet.NewServer()<br>    <span class="hljs-comment">//é…ç½®è·¯ç”±</span><br>    s.AddRouter(&amp;PingRouter&#123;&#125;)<br>    <span class="hljs-comment">//å¼€å¯æœåŠ¡</span><br>    s.Serve()<br>&#125;<br></code></pre></td></tr></table></figure>
<ul>
<li>Client.go</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;fmt&quot;</span><br>    <span class="hljs-string">&quot;io&quot;</span><br>    <span class="hljs-string">&quot;net&quot;</span><br>    <span class="hljs-string">&quot;time&quot;</span><br>    <span class="hljs-string">&quot;zinx/znet&quot;</span><br>)<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">    æ¨¡æ‹Ÿå®¢æˆ·ç«¯</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    fmt.Println(<span class="hljs-string">&quot;Client Test ... start&quot;</span>)<br>    <span class="hljs-comment">//3ç§’ä¹‹åå‘èµ·æµ‹è¯•è¯·æ±‚ï¼Œç»™æœåŠ¡ç«¯å¼€å¯æœåŠ¡çš„æœºä¼š</span><br>    time.Sleep(<span class="hljs-number">3</span> * time.Second)<br>    conn,err := net.Dial(<span class="hljs-string">&quot;tcp&quot;</span>, <span class="hljs-string">&quot;127.0.0.1:7777&quot;</span>)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        fmt.Println(<span class="hljs-string">&quot;client start err, exit!&quot;</span>)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    <span class="hljs-keyword">for</span> &#123;<br>        <span class="hljs-comment">//å‘å°åŒ…messageæ¶ˆæ¯</span><br>        dp := znet.NewDataPack()<br>        msg, _ := dp.Pack(znet.NewMsgPackage(<span class="hljs-number">0</span>,[]<span class="hljs-type">byte</span>(<span class="hljs-string">&quot;Zinx V0.5 Client Test Message&quot;</span>)))<br>        _, err := conn.Write(msg)<br>        <span class="hljs-keyword">if</span> err !=<span class="hljs-literal">nil</span> &#123;<br>            fmt.Println(<span class="hljs-string">&quot;write error err &quot;</span>, err)<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        <span class="hljs-comment">//å…ˆè¯»å‡ºæµä¸­çš„headéƒ¨åˆ†</span><br>        headData := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, dp.GetHeadLen())<br>        _, err = io.ReadFull(conn, headData) <span class="hljs-comment">//ReadFull ä¼šæŠŠmsgå¡«å……æ»¡ä¸ºæ­¢</span><br>        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>            fmt.Println(<span class="hljs-string">&quot;read head error&quot;</span>)<br>            <span class="hljs-keyword">break</span><br>        &#125;<br>        <span class="hljs-comment">//å°†headDataå­—èŠ‚æµ æ‹†åŒ…åˆ°msgä¸­</span><br>        msgHead, err := dp.Unpack(headData)<br>        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>            fmt.Println(<span class="hljs-string">&quot;server unpack err:&quot;</span>, err)<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        <span class="hljs-keyword">if</span> msgHead.GetDataLen() &gt; <span class="hljs-number">0</span> &#123;<br>            <span class="hljs-comment">//msg æ˜¯æœ‰dataæ•°æ®çš„ï¼Œéœ€è¦å†æ¬¡è¯»å–dataæ•°æ®</span><br>            msg := msgHead.(*znet.Message)<br>            msg.Data = <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, msg.GetDataLen())<br>            <span class="hljs-comment">//æ ¹æ®dataLenä»ioä¸­è¯»å–å­—èŠ‚æµ</span><br>            _, err := io.ReadFull(conn, msg.Data)<br>            <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>                fmt.Println(<span class="hljs-string">&quot;server unpack data err:&quot;</span>, err)<br>                <span class="hljs-keyword">return</span><br>            &#125;<br>            fmt.Println(<span class="hljs-string">&quot;==&gt; Recv Msg: ID=&quot;</span>, msg.Id, <span class="hljs-string">&quot;, len=&quot;</span>, msg.DataLen, <span class="hljs-string">&quot;, data=&quot;</span>, <span class="hljs-type">string</span>(msg.Data))<br>        &#125;<br>        time.Sleep(<span class="hljs-number">1</span>*time.Second)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h1 id="v0-6-å¤šè·¯ç”±æ¨¡å¼"><a href="#v0-6-å¤šè·¯ç”±æ¨¡å¼" class="headerlink" title="[v0.6] å¤šè·¯ç”±æ¨¡å¼"></a>[v0.6] å¤šè·¯ç”±æ¨¡å¼</h1><h2 id="åŠŸèƒ½-3"><a href="#åŠŸèƒ½-3" class="headerlink" title="åŠŸèƒ½"></a>åŠŸèƒ½</h2><p><img src="../../../images/Zinx/a51f97e14d4dd69d394843874bb9445c-0.png" alt="img"></p>
<blockquote>
<p><strong>æ¶‰åŠçŸ¥è¯†ç‚¹</strong></p>
<ol>
<li>å¤šè·¯ç”±æ¨¡å¼</li>
<li>å•å…ƒæµ‹è¯•</li>
</ol>
</blockquote>
<h2 id="åˆ›å»ºæ¶ˆæ¯ç®¡ç†æ¨¡å—"><a href="#åˆ›å»ºæ¶ˆæ¯ç®¡ç†æ¨¡å—" class="headerlink" title="åˆ›å»ºæ¶ˆæ¯ç®¡ç†æ¨¡å—"></a>åˆ›å»ºæ¶ˆæ¯ç®¡ç†æ¨¡å—</h2><ol>
<li>åˆ›å»ºæ¶ˆæ¯ç®¡ç†æ¨¡å—æŠ½è±¡ç±»</li>
</ol>
<p>åœ¨<code>zinx/ziface</code>ä¸‹åˆ›å»º<code>imsghandler.go</code>æ–‡ä»¶ï¼Œ å®šä¹‰å‡ºæˆ‘ä»¬ä¹‹å‰å›¾ç‰‡ä¸­çš„æ–¹æ³•ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> ziface<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">    æ¶ˆæ¯ç®¡ç†æŠ½è±¡å±‚</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">type</span> IMsgHandle <span class="hljs-keyword">interface</span>&#123;<br>    DoMsgHandler(request IRequest)            <span class="hljs-comment">//é©¬ä¸Šä»¥éé˜»å¡æ–¹å¼å¤„ç†æ¶ˆæ¯</span><br>    AddRouter(msgId <span class="hljs-type">uint32</span>, router IRouter)    <span class="hljs-comment">//ä¸ºæ¶ˆæ¯æ·»åŠ å…·ä½“çš„å¤„ç†é€»è¾‘</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>è¿™é‡Œé¢æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼Œ<code>AddRouter()</code>å°±æ˜¯æ·»åŠ ä¸€ä¸ª msgId å’Œä¸€ä¸ªè·¯ç”±å…³ç³»åˆ° Apis ä¸­ï¼Œé‚£ä¹ˆ<code>DoMsgHandler()</code>åˆ™æ˜¯è°ƒç”¨ Router ä¸­å…·ä½“<code>Handle()</code>ç­‰æ–¹æ³•çš„æ¥å£ã€‚</p>
<ol>
<li>å®ç°æ¶ˆæ¯ç®¡ç†æ¨¡å—</li>
</ol>
<p>åœ¨<code>zinx/znet</code>ä¸‹åˆ›å»º<code>msghandler.go</code>æ–‡ä»¶ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> znet<br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;fmt&quot;</span><br>    <span class="hljs-string">&quot;strconv&quot;</span><br>    <span class="hljs-string">&quot;zinx/ziface&quot;</span><br>)<br><span class="hljs-keyword">type</span> MsgHandle <span class="hljs-keyword">struct</span>&#123;<br>    Apis <span class="hljs-keyword">map</span>[<span class="hljs-type">uint32</span>] ziface.IRouter <span class="hljs-comment">//å­˜æ”¾æ¯ä¸ªMsgId æ‰€å¯¹åº”çš„å¤„ç†æ–¹æ³•çš„mapå±æ€§</span><br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewMsgHandle</span><span class="hljs-params">()</span></span> *MsgHandle &#123;<br>    <span class="hljs-keyword">return</span> &amp;MsgHandle &#123;<br>        Apis:<span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">uint32</span>]ziface.IRouter),<br>    &#125;<br>&#125;<br><span class="hljs-comment">//é©¬ä¸Šä»¥éé˜»å¡æ–¹å¼å¤„ç†æ¶ˆæ¯</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(mh *MsgHandle)</span></span> DoMsgHandler(request ziface.IRequest)    &#123;<br>    handler, ok := mh.Apis[request.GetMsgID()]<br>    <span class="hljs-keyword">if</span> !ok &#123;<br>        fmt.Println(<span class="hljs-string">&quot;api msgId = &quot;</span>, request.GetMsgID(), <span class="hljs-string">&quot; is not FOUND!&quot;</span>)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    <span class="hljs-comment">//æ‰§è¡Œå¯¹åº”å¤„ç†æ–¹æ³•</span><br>    handler.PreHandle(request)<br>    handler.Handle(request)<br>    handler.PostHandle(request)<br>&#125;<br><span class="hljs-comment">//ä¸ºæ¶ˆæ¯æ·»åŠ å…·ä½“çš„å¤„ç†é€»è¾‘</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(mh *MsgHandle)</span></span> AddRouter(msgId <span class="hljs-type">uint32</span>, router ziface.IRouter) &#123;<br>    <span class="hljs-comment">//1 åˆ¤æ–­å½“å‰msgç»‘å®šçš„APIå¤„ç†æ–¹æ³•æ˜¯å¦å·²ç»å­˜åœ¨</span><br>    <span class="hljs-keyword">if</span> _, ok := mh.Apis[msgId]; ok &#123;<br>        <span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;repeated api , msgId = &quot;</span> + strconv.Itoa(<span class="hljs-type">int</span>(msgId)))<br>    &#125;<br>    <span class="hljs-comment">//2 æ·»åŠ msgä¸apiçš„ç»‘å®šå…³ç³»</span><br>    mh.Apis[msgId] = router<br>    fmt.Println(<span class="hljs-string">&quot;Add api msgId = &quot;</span>, msgId)<br>&#125;<br></code></pre></td></tr></table></figure>
<ol>
<li>zinxå…¶ä»–æ¨¡å—çš„ç›¸åº”ä¿®æ”¹</li>
</ol>
<p>é¦–å…ˆ<code>iserver</code>çš„<code>AddRouter()</code>çš„æ¥å£è¦ç¨å¾®æ”¹ä¸€ä¸‹ï¼Œå¢æ·» MsgId å‚æ•°.</p>
<p>iserver.go:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> ziface<br><span class="hljs-comment">//å®šä¹‰æœåŠ¡å™¨æ¥å£</span><br><span class="hljs-keyword">type</span> IServer <span class="hljs-keyword">interface</span>&#123;<br>    <span class="hljs-comment">//å¯åŠ¨æœåŠ¡å™¨æ–¹æ³•</span><br>    Start()<br>    <span class="hljs-comment">//åœæ­¢æœåŠ¡å™¨æ–¹æ³•</span><br>    Stop()<br>    <span class="hljs-comment">//å¼€å¯ä¸šåŠ¡æœåŠ¡æ–¹æ³•</span><br>    Serve()<br>    <span class="hljs-comment">//è·¯ç”±åŠŸèƒ½ï¼šç»™å½“å‰æœåŠ¡æ³¨å†Œä¸€ä¸ªè·¯ç”±ä¸šåŠ¡æ–¹æ³•ï¼Œä¾›å®¢æˆ·ç«¯é“¾æ¥å¤„ç†ä½¿ç”¨</span><br>    AddRouter(msgId <span class="hljs-type">uint32</span>, router IRouter)<br>&#125;<br></code></pre></td></tr></table></figure>
<p>å…¶æ¬¡ï¼Œ<code>Server</code>ç±»ä¸­ ä¹‹å‰æœ‰ä¸€ä¸ª<code>Router</code>æˆå‘˜ ï¼Œä»£è¡¨å”¯ä¸€çš„å¤„ç†æ–¹æ³•ï¼Œç°åœ¨åº”è¯¥æ›¿æ¢æˆ<code>MsgHandler</code>æˆå‘˜ã€‚</p>
<blockquote>
<p>zinx/znet/server.go</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Server <span class="hljs-keyword">struct</span> &#123;<br>    <span class="hljs-comment">//æœåŠ¡å™¨çš„åç§°</span><br>    Name <span class="hljs-type">string</span><br>    <span class="hljs-comment">//tcp4 or other</span><br>    IPVersion <span class="hljs-type">string</span><br>    <span class="hljs-comment">//æœåŠ¡ç»‘å®šçš„IPåœ°å€</span><br>    IP <span class="hljs-type">string</span><br>    <span class="hljs-comment">//æœåŠ¡ç»‘å®šçš„ç«¯å£</span><br>    Port <span class="hljs-type">int</span><br>    <span class="hljs-comment">//å½“å‰Serverçš„æ¶ˆæ¯ç®¡ç†æ¨¡å—ï¼Œç”¨æ¥ç»‘å®šMsgIdå’Œå¯¹åº”çš„å¤„ç†æ–¹æ³•</span><br>    msgHandler ziface.IMsgHandle<br>&#125;<br></code></pre></td></tr></table></figure>
<p>åˆå§‹åŒ– Server è‡ªç„¶ä¹Ÿè¦æ›´æ­£ï¼Œå¢åŠ  msgHandler åˆå§‹åŒ–ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/*</span><br><span class="hljs-comment">  åˆ›å»ºä¸€ä¸ªæœåŠ¡å™¨å¥æŸ„</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewServer</span> <span class="hljs-params">()</span></span> ziface.IServer &#123;<br>    utils.GlobalObject.Reload()<br>    s:= &amp;Server &#123;<br>        Name :utils.GlobalObject.Name,<br>        IPVersion:<span class="hljs-string">&quot;tcp4&quot;</span>,<br>        IP:utils.GlobalObject.Host,<br>        Port:utils.GlobalObject.TcpPort,<br>        msgHandler: NewMsgHandle(), <span class="hljs-comment">//msgHandler åˆå§‹åŒ–</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> s<br>&#125;<br></code></pre></td></tr></table></figure>
<p>ç„¶åå½“ Server åœ¨å¤„ç† conn è¯·æ±‚ä¸šåŠ¡çš„æ—¶å€™ï¼Œåˆ›å»º conn çš„æ—¶å€™ä¹Ÿéœ€è¦æŠŠ msgHandler ä½œä¸ºå‚æ•°ä¼ é€’ç»™ Connection å¯¹è±¡ã€‚ä¹Ÿå°±æ˜¯åœ¨æˆ‘ä»¬ server.go çš„ Start() æ–¹æ³•ä¸­çš„ 3.3 æ³¨é‡Šä¸‹è¿›è¡Œå¦‚ä¸‹ä¿®æ”¹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">//...</span><br>dealConn := NewConntion(conn, cid, s.msgHandler)<br><span class="hljs-comment">//...</span><br></code></pre></td></tr></table></figure>
<p>æœ€åï¼Œæˆ‘ä»¬çš„ AddRouter æ–¹æ³•åšäº†ä¿®æ”¹ï¼Œæ‰€ä»¥è¦é‡æ–°å®ç°æ¥å£æ–¹æ³•ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">//è·¯ç”±åŠŸèƒ½ï¼šç»™å½“å‰æœåŠ¡æ³¨å†Œä¸€ä¸ªè·¯ç”±ä¸šåŠ¡æ–¹æ³•ï¼Œä¾›å®¢æˆ·ç«¯é“¾æ¥å¤„ç†ä½¿ç”¨</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Server)</span></span>AddRouter(msgId <span class="hljs-type">uint32</span>, router ziface.IRouter) &#123;<br>    s.msgHandler.AddRouter(msgId,router)<br>&#125;<br></code></pre></td></tr></table></figure>
<p>é‚£ä¹ˆæ¥ä¸‹æ¥å°±æ˜¯ Connection å¯¹è±¡äº†ã€‚å›ºç„¶åœ¨ Connection å¯¹è±¡ä¸­åº”è¯¥æœ‰ MsgHandler çš„æˆå‘˜ï¼Œæ¥æŸ¥æ‰¾æ¶ˆæ¯å¯¹åº”çš„å›è°ƒè·¯ç”±æ–¹æ³•ã€‚</p>
<blockquote>
<p>zinx/znet/connection.go</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Connection <span class="hljs-keyword">struct</span> &#123;<br>    <span class="hljs-comment">//å½“å‰è¿æ¥çš„socket TCPå¥—æ¥å­—</span><br>    Conn *net.TCPConn<br>    <span class="hljs-comment">//å½“å‰è¿æ¥çš„ID ä¹Ÿå¯ä»¥ç§°ä½œä¸ºSessionIDï¼ŒIDå…¨å±€å”¯ä¸€</span><br>    ConnID <span class="hljs-type">uint32</span><br>    <span class="hljs-comment">//å½“å‰è¿æ¥çš„å…³é—­çŠ¶æ€</span><br>    isClosed <span class="hljs-type">bool</span><br>    <span class="hljs-comment">//æ¶ˆæ¯ç®¡ç†MsgIdå’Œå¯¹åº”å¤„ç†æ–¹æ³•çš„æ¶ˆæ¯ç®¡ç†æ¨¡å—</span><br>    MsgHandler ziface.IMsgHandle<br>    <span class="hljs-comment">//å‘ŠçŸ¥è¯¥é“¾æ¥å·²ç»é€€å‡º/åœæ­¢çš„channel</span><br>    ExitBuffChan <span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span><br>&#125;<br><span class="hljs-comment">//åˆ›å»ºè¿æ¥çš„æ–¹æ³•</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewConntion</span><span class="hljs-params">(conn *net.TCPConn, connID <span class="hljs-type">uint32</span>, msgHandler ziface.IMsgHandle)</span></span> *Connection&#123;<br>    c := &amp;Connection&#123;<br>        Conn:     conn,<br>        ConnID:   connID,<br>        isClosed: <span class="hljs-literal">false</span>,<br>        MsgHandler: msgHandler,<br>        ExitBuffChan: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span>, <span class="hljs-number">1</span>),<br>    &#125;<br>    <span class="hljs-keyword">return</span> c<br>&#125;<br></code></pre></td></tr></table></figure>
<p>æœ€åï¼Œåœ¨ conn å·²ç»æ‹†åŒ…ä¹‹åï¼Œéœ€è¦è°ƒç”¨è·¯ç”±ä¸šåŠ¡çš„æ—¶å€™ï¼Œæˆ‘ä»¬åªéœ€è¦è®© conn è°ƒç”¨ MsgHandler ä¸­çš„<code>DoMsgHander()</code>æ–¹æ³•å°±å¥½äº†ã€‚</p>
<blockquote>
<p>zinx/znet/connection.go</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Connection)</span></span> StartReader() &#123;<br>    fmt.Println(<span class="hljs-string">&quot;[Reader Goroutine is running]&quot;</span>)<br>    <span class="hljs-keyword">defer</span> fmt.Println(c.RemoteAddr().String(), <span class="hljs-string">&quot;[conn Reader exit!]&quot;</span>)<br>    <span class="hljs-keyword">defer</span> c.Stop()<br>    <span class="hljs-keyword">for</span>  &#123;<br>        <span class="hljs-comment">// åˆ›å»ºæ‹†åŒ…è§£åŒ…çš„å¯¹è±¡</span><br>        dp := NewDataPack()<br>        <span class="hljs-comment">//è¯»å–å®¢æˆ·ç«¯çš„Msg head</span><br>        headData := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, dp.GetHeadLen())<br>        <span class="hljs-keyword">if</span> _, err := io.ReadFull(c.GetTCPConnection(), headData); err != <span class="hljs-literal">nil</span> &#123;<br>            fmt.Println(<span class="hljs-string">&quot;read msg head error &quot;</span>, err)<br>            <span class="hljs-keyword">break</span><br>        &#125;<br>        <span class="hljs-comment">//æ‹†åŒ…ï¼Œå¾—åˆ°msgid å’Œ datalen æ”¾åœ¨msgä¸­</span><br>        msg , err := dp.Unpack(headData)<br>        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>            fmt.Println(<span class="hljs-string">&quot;unpack error &quot;</span>, err)<br>            <span class="hljs-keyword">break</span><br>        &#125;<br>        <span class="hljs-comment">//æ ¹æ® dataLen è¯»å– dataï¼Œæ”¾åœ¨msg.Dataä¸­</span><br>        <span class="hljs-keyword">var</span> data []<span class="hljs-type">byte</span><br>        <span class="hljs-keyword">if</span> msg.GetDataLen() &gt; <span class="hljs-number">0</span> &#123;<br>            data = <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, msg.GetDataLen())<br>            <span class="hljs-keyword">if</span> _, err := io.ReadFull(c.GetTCPConnection(), data); err != <span class="hljs-literal">nil</span> &#123;<br>                fmt.Println(<span class="hljs-string">&quot;read msg data error &quot;</span>, err)<br>                <span class="hljs-keyword">continue</span><br>            &#125;<br>        &#125;<br>        msg.SetData(data)<br>        <span class="hljs-comment">//å¾—åˆ°å½“å‰å®¢æˆ·ç«¯è¯·æ±‚çš„Requestæ•°æ®</span><br>        req := Request&#123;<br>            conn:c,<br>            msg:msg,<br>        &#125;<br>        <span class="hljs-comment">//ä»ç»‘å®šå¥½çš„æ¶ˆæ¯å’Œå¯¹åº”çš„å¤„ç†æ–¹æ³•ä¸­æ‰§è¡Œå¯¹åº”çš„Handleæ–¹æ³•</span><br>        <span class="hljs-keyword">go</span> c.MsgHandler.DoMsgHandler(&amp;req)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>å¥½äº†ï¼Œå¤§åŠŸå‘Šæˆï¼Œæˆ‘ä»¬æ¥æµ‹è¯•ä¸€ä¸‹ Zinx çš„å¤šè·¯ç”±è®¾ç½®åŠŸèƒ½å§ã€‚</p>
<h2 id="zinxæµ‹è¯•"><a href="#zinxæµ‹è¯•" class="headerlink" title="zinxæµ‹è¯•"></a>zinxæµ‹è¯•</h2><p>è¿™é‡Œæˆ‘ä»¬æ—¢ç„¶å®Œæˆäº†å¤šè·¯ç”±æ¨¡å¼ï¼Œé‚£ä¹ˆå°±å¯ä»¥è¿›è¡Œä¸€ä¸ªæœåŠ¡ç«¯ï¼Œå¤šä¸ªå®¢æˆ·ç«¯çš„æ–¹å¼è¿›è¡Œæµ‹è¯•æˆ‘ä»¬çš„åŠŸèƒ½æ¨¡å—äº†ã€‚</p>
<p>æˆ‘ä»¬è¿™é‡Œåœ¨ zinx æ–‡ä»¶å¤¹ä¸‹æ–°å»º Client01.go æ–‡ä»¶ã€‚</p>
<p>æˆ‘ä»¬åœ¨ Server ç«¯è®¾ç½® 2 ä¸ªè·¯ç”±ï¼Œä¸€ä¸ªæ˜¯ MsgId ä¸º 0 çš„æ¶ˆæ¯ä¼šæ‰§è¡Œ PingRouter{}é‡å†™çš„<code>Handle()</code>æ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯ MsgId ä¸º 1 çš„æ¶ˆæ¯ä¼šæ‰§è¡Œ HelloZinxRouter{}é‡å†™çš„<code>Handle()</code>æ–¹æ³•ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;fmt&quot;</span><br>    <span class="hljs-string">&quot;zinx/ziface&quot;</span><br>    <span class="hljs-string">&quot;zinx/znet&quot;</span><br>)<br><span class="hljs-comment">//ping test è‡ªå®šä¹‰è·¯ç”±</span><br><span class="hljs-keyword">type</span> PingRouter <span class="hljs-keyword">struct</span> &#123;<br>    znet.BaseRouter<br>&#125;<br><span class="hljs-comment">//Ping Handle</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *PingRouter)</span></span> Handle(request ziface.IRequest) &#123;<br>    fmt.Println(<span class="hljs-string">&quot;Call PingRouter Handle&quot;</span>)<br>    <span class="hljs-comment">//å…ˆè¯»å–å®¢æˆ·ç«¯çš„æ•°æ®ï¼Œå†å›å†™ping...ping...ping</span><br>    fmt.Println(<span class="hljs-string">&quot;recv from client : msgId=&quot;</span>, request.GetMsgID(), <span class="hljs-string">&quot;, data=&quot;</span>, <span class="hljs-type">string</span>(request.GetData()))<br>    err := request.GetConnection().SendMsg(<span class="hljs-number">0</span>, []<span class="hljs-type">byte</span>(<span class="hljs-string">&quot;ping...ping...ping&quot;</span>))<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        fmt.Println(err)<br>    &#125;<br>&#125;<br><span class="hljs-comment">//HelloZinxRouter Handle</span><br><span class="hljs-keyword">type</span> HelloZinxRouter <span class="hljs-keyword">struct</span> &#123;<br>    znet.BaseRouter<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *HelloZinxRouter)</span></span> Handle(request ziface.IRequest) &#123;<br>    fmt.Println(<span class="hljs-string">&quot;Call HelloZinxRouter Handle&quot;</span>)<br>    <span class="hljs-comment">//å…ˆè¯»å–å®¢æˆ·ç«¯çš„æ•°æ®ï¼Œå†å›å†™ping...ping...ping</span><br>    fmt.Println(<span class="hljs-string">&quot;recv from client : msgId=&quot;</span>, request.GetMsgID(), <span class="hljs-string">&quot;, data=&quot;</span>, <span class="hljs-type">string</span>(request.GetData()))<br>    err := request.GetConnection().SendMsg(<span class="hljs-number">1</span>, []<span class="hljs-type">byte</span>(<span class="hljs-string">&quot;Hello Zinx Router V0.6&quot;</span>))<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        fmt.Println(err)<br>    &#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-comment">//åˆ›å»ºä¸€ä¸ªserverå¥æŸ„</span><br>    s := znet.NewServer()<br>    <span class="hljs-comment">//é…ç½®è·¯ç”±</span><br>    s.AddRouter(<span class="hljs-number">0</span>, &amp;PingRouter&#123;&#125;)<br>    s.AddRouter(<span class="hljs-number">1</span>, &amp;HelloZinxRouter&#123;&#125;)<br>    <span class="hljs-comment">//å¼€å¯æœåŠ¡</span><br>    s.Serve()<br>&#125;<br></code></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ç°åœ¨å†™ä¸¤ä¸ªå®¢æˆ·ç«¯ï¼Œåˆ†åˆ«å‘é€ 0 æ¶ˆæ¯å’Œ 1 æ¶ˆæ¯æ¥è¿›è¡Œæµ‹è¯• Zinx æ˜¯å¦èƒ½å¤Ÿå¤„ç† 2 ä¸ªä¸åŒçš„æ¶ˆæ¯ä¸šåŠ¡ã€‚</p>
<p>Client.go:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;fmt&quot;</span><br>    <span class="hljs-string">&quot;io&quot;</span><br>    <span class="hljs-string">&quot;net&quot;</span><br>    <span class="hljs-string">&quot;time&quot;</span><br>    <span class="hljs-string">&quot;zinx/znet&quot;</span><br>)<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">    æ¨¡æ‹Ÿå®¢æˆ·ç«¯</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    fmt.Println(<span class="hljs-string">&quot;Client Test ... start&quot;</span>)<br>    <span class="hljs-comment">//3ç§’ä¹‹åå‘èµ·æµ‹è¯•è¯·æ±‚ï¼Œç»™æœåŠ¡ç«¯å¼€å¯æœåŠ¡çš„æœºä¼š</span><br>    time.Sleep(<span class="hljs-number">3</span> * time.Second)<br>    conn,err := net.Dial(<span class="hljs-string">&quot;tcp&quot;</span>, <span class="hljs-string">&quot;127.0.0.1:7777&quot;</span>)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        fmt.Println(<span class="hljs-string">&quot;client start err, exit!&quot;</span>)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    <span class="hljs-keyword">for</span> &#123;<br>        <span class="hljs-comment">//å‘å°åŒ…messageæ¶ˆæ¯</span><br>        dp := znet.NewDataPack()<br>        msg, _ := dp.Pack(znet.NewMsgPackage(<span class="hljs-number">0</span>,[]<span class="hljs-type">byte</span>(<span class="hljs-string">&quot;Zinx V0.6 Client0 Test Message&quot;</span>)))<br>        _, err := conn.Write(msg)<br>        <span class="hljs-keyword">if</span> err !=<span class="hljs-literal">nil</span> &#123;<br>            fmt.Println(<span class="hljs-string">&quot;write error err &quot;</span>, err)<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        <span class="hljs-comment">//å…ˆè¯»å‡ºæµä¸­çš„headéƒ¨åˆ†</span><br>        headData := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, dp.GetHeadLen())<br>        _, err = io.ReadFull(conn, headData) <span class="hljs-comment">//ReadFull ä¼šæŠŠmsgå¡«å……æ»¡ä¸ºæ­¢</span><br>        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>            fmt.Println(<span class="hljs-string">&quot;read head error&quot;</span>)<br>            <span class="hljs-keyword">break</span><br>        &#125;<br>        <span class="hljs-comment">//å°†headDataå­—èŠ‚æµ æ‹†åŒ…åˆ°msgä¸­</span><br>        msgHead, err := dp.Unpack(headData)<br>        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>            fmt.Println(<span class="hljs-string">&quot;server unpack err:&quot;</span>, err)<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        <span class="hljs-keyword">if</span> msgHead.GetDataLen() &gt; <span class="hljs-number">0</span> &#123;<br>            <span class="hljs-comment">//msg æ˜¯æœ‰dataæ•°æ®çš„ï¼Œéœ€è¦å†æ¬¡è¯»å–dataæ•°æ®</span><br>            msg := msgHead.(*znet.Message)<br>            msg.Data = <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, msg.GetDataLen())<br>            <span class="hljs-comment">//æ ¹æ®dataLenä»ioä¸­è¯»å–å­—èŠ‚æµ</span><br>            _, err := io.ReadFull(conn, msg.Data)<br>            <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>                fmt.Println(<span class="hljs-string">&quot;server unpack data err:&quot;</span>, err)<br>                <span class="hljs-keyword">return</span><br>            &#125;<br>            fmt.Println(<span class="hljs-string">&quot;==&gt; Recv Msg: ID=&quot;</span>, msg.Id, <span class="hljs-string">&quot;, len=&quot;</span>, msg.DataLen, <span class="hljs-string">&quot;, data=&quot;</span>, <span class="hljs-type">string</span>(msg.Data))<br>        &#125;<br>        time.Sleep(<span class="hljs-number">1</span>*time.Second)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>Client01.go:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;fmt&quot;</span><br>    <span class="hljs-string">&quot;io&quot;</span><br>    <span class="hljs-string">&quot;net&quot;</span><br>    <span class="hljs-string">&quot;time&quot;</span><br>    <span class="hljs-string">&quot;zinx/znet&quot;</span><br>)<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">    æ¨¡æ‹Ÿå®¢æˆ·ç«¯</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    fmt.Println(<span class="hljs-string">&quot;Client Test ... start&quot;</span>)<br>    <span class="hljs-comment">//3ç§’ä¹‹åå‘èµ·æµ‹è¯•è¯·æ±‚ï¼Œç»™æœåŠ¡ç«¯å¼€å¯æœåŠ¡çš„æœºä¼š</span><br>    time.Sleep(<span class="hljs-number">3</span> * time.Second)<br>    conn,err := net.Dial(<span class="hljs-string">&quot;tcp&quot;</span>, <span class="hljs-string">&quot;127.0.0.1:7777&quot;</span>)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        fmt.Println(<span class="hljs-string">&quot;client start err, exit!&quot;</span>)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    <span class="hljs-keyword">for</span> &#123;<br>        <span class="hljs-comment">//å‘å°åŒ…messageæ¶ˆæ¯</span><br>        dp := znet.NewDataPack()<br>        msg, _ := dp.Pack(znet.NewMsgPackage(<span class="hljs-number">1</span>,[]<span class="hljs-type">byte</span>(<span class="hljs-string">&quot;Zinx V0.6 Client1 Test Message&quot;</span>)))<br>        _, err := conn.Write(msg)<br>        <span class="hljs-keyword">if</span> err !=<span class="hljs-literal">nil</span> &#123;<br>            fmt.Println(<span class="hljs-string">&quot;write error err &quot;</span>, err)<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        <span class="hljs-comment">//å…ˆè¯»å‡ºæµä¸­çš„headéƒ¨åˆ†</span><br>        headData := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, dp.GetHeadLen())<br>        _, err = io.ReadFull(conn, headData) <span class="hljs-comment">//ReadFull ä¼šæŠŠmsgå¡«å……æ»¡ä¸ºæ­¢</span><br>        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>            fmt.Println(<span class="hljs-string">&quot;read head error&quot;</span>)<br>            <span class="hljs-keyword">break</span><br>        &#125;<br>        <span class="hljs-comment">//å°†headDataå­—èŠ‚æµ æ‹†åŒ…åˆ°msgä¸­</span><br>        msgHead, err := dp.Unpack(headData)<br>        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>            fmt.Println(<span class="hljs-string">&quot;server unpack err:&quot;</span>, err)<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        <span class="hljs-keyword">if</span> msgHead.GetDataLen() &gt; <span class="hljs-number">0</span> &#123;<br>            <span class="hljs-comment">//msg æ˜¯æœ‰dataæ•°æ®çš„ï¼Œéœ€è¦å†æ¬¡è¯»å–dataæ•°æ®</span><br>            msg := msgHead.(*znet.Message)<br>            msg.Data = <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, msg.GetDataLen())<br>            <span class="hljs-comment">//æ ¹æ®dataLenä»ioä¸­è¯»å–å­—èŠ‚æµ</span><br>            _, err := io.ReadFull(conn, msg.Data)<br>            <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>                fmt.Println(<span class="hljs-string">&quot;server unpack data err:&quot;</span>, err)<br>                <span class="hljs-keyword">return</span><br>            &#125;<br>            fmt.Println(<span class="hljs-string">&quot;==&gt; Recv Msg: ID=&quot;</span>, msg.Id, <span class="hljs-string">&quot;, len=&quot;</span>, msg.DataLen, <span class="hljs-string">&quot;, data=&quot;</span>, <span class="hljs-type">string</span>(msg.Data))<br>        &#125;<br>        time.Sleep(<span class="hljs-number">1</span>*time.Second)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>ç„¶åæˆ‘ä»¬ç‚¹å‡»å‘½ä»¤è¡Œå³ä¸Šè§’çš„åˆ†éš”æŒ‰é’®ï¼Œå¯åŠ¨ä¸‰ä¸ªå‘½ä»¤è¡Œçª—å£ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œæ¯å¯åŠ¨ä¸€ä¸ªçª—å£ï¼Œéƒ½éœ€è¦åœ¨é‡Œé¢å…ˆæ‰§è¡Œ <code>export GOPATH=/home/project</code> è¿™é“å‘½ä»¤ã€‚</p>
<p>æµ‹è¯•ç»“æœï¼š</p>
<p><img src="../../../images/Zinx/5079265929daf30444ba414d8cedff98-0.png" alt="img"></p>
<h1 id="v0-7-è¯»å†™åˆ†ç¦»"><a href="#v0-7-è¯»å†™åˆ†ç¦»" class="headerlink" title="[v0.7] è¯»å†™åˆ†ç¦»"></a>[v0.7] è¯»å†™åˆ†ç¦»</h1><h2 id="åŠŸèƒ½-4"><a href="#åŠŸèƒ½-4" class="headerlink" title="åŠŸèƒ½"></a>åŠŸèƒ½</h2><p><img src="https://doc.shiyanlou.com/courses/1639/1240622/0b1e3201b784a5a2b358789aa408803e-0" alt="img"></p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±è¦å¯¹ Zinx åšä¸€ä¸ªå°å°çš„æ”¹å˜ï¼Œå°±æ˜¯ä¸å®¢æˆ·ç«¯è¿›ä¿®æ•°æ®äº¤äº’çš„ Gouroutine ç”±ä¸€ä¸ªå˜æˆä¸¤ä¸ªï¼Œä¸€ä¸ªä¸“é—¨è´Ÿè´£ä»å®¢æˆ·ç«¯è¯»å–æ•°æ®ï¼Œä¸€ä¸ªä¸“é—¨è´Ÿè´£å‘å®¢æˆ·ç«¯å†™æ•°æ®ã€‚è¿™ä¹ˆè®¾è®¡æœ‰ä»€ä¹ˆå¥½å¤„ï¼Œå½“ç„¶æ˜¯ç›®çš„å°±æ˜¯é«˜å†…èšï¼Œæ¨¡å—çš„åŠŸèƒ½å•ä¸€ï¼Œå¯¹äºæˆ‘ä»¬ä»Šåæ‰©å±•åŠŸèƒ½æ›´åŠ æ–¹ä¾¿ã€‚</p>
<blockquote>
<p><strong>çŸ¥è¯†ç‚¹</strong></p>
<ol>
<li>Golangå¹¶å‘æ¨¡å‹</li>
<li>è¯»å†™åˆ†ç¦»</li>
</ol>
</blockquote>
<h2 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h2><p><img src="../../../images/Zinx/ee191fe76155df0c6a4f83ec2915aa6f.jpeg" alt="ä¸ƒã€Zinxçš„è¯»å†™åˆ†ç¦»æ¨¡å‹  - å›¾1"></p>
<p>Server ä¾ç„¶æ˜¯å¤„ç†å®¢æˆ·ç«¯çš„å“åº”ï¼Œä¸»è¦å…³é”®çš„å‡ ä¸ªæ–¹æ³•æ˜¯ Listenã€Accept ç­‰ã€‚å½“å»ºç«‹ä¸å®¢æˆ·ç«¯çš„å¥—æ¥å­—åï¼Œé‚£ä¹ˆå°±ä¼šå¼€å¯ä¸¤ä¸ª Goroutine åˆ†åˆ«å¤„ç†è¯»æ•°æ®ä¸šåŠ¡å’Œå†™æ•°æ®ä¸šåŠ¡ï¼Œè¯»å†™æ•°æ®ä¹‹é—´çš„æ¶ˆæ¯é€šè¿‡ä¸€ä¸ª Channel ä¼ é€’ã€‚ä¸‹é¢æˆ‘ä»¬å°±å¼€å§‹è¿›è¡Œå®é™…çš„å®ç°ã€‚</p>
<h3 id="1-æ·»åŠ è¯»å†™æ¨¡å—äº¤äº’æ•°æ®çš„ç®¡é“"><a href="#1-æ·»åŠ è¯»å†™æ¨¡å—äº¤äº’æ•°æ®çš„ç®¡é“" class="headerlink" title="1. æ·»åŠ è¯»å†™æ¨¡å—äº¤äº’æ•°æ®çš„ç®¡é“"></a>1. æ·»åŠ è¯»å†™æ¨¡å—äº¤äº’æ•°æ®çš„ç®¡é“</h3><ol>
<li>connection.go</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Connection <span class="hljs-keyword">struct</span> &#123;<br>    <span class="hljs-comment">//å½“å‰è¿æ¥çš„socket TCPå¥—æ¥å­—</span><br>    Conn *net.TCPConn<br>    <span class="hljs-comment">//å½“å‰è¿æ¥çš„ID ä¹Ÿå¯ä»¥ç§°ä½œä¸ºSessionIDï¼ŒIDå…¨å±€å”¯ä¸€</span><br>    ConnID <span class="hljs-type">uint32</span><br>    <span class="hljs-comment">//å½“å‰è¿æ¥çš„å…³é—­çŠ¶æ€</span><br>    isClosed <span class="hljs-type">bool</span><br>    <span class="hljs-comment">//æ¶ˆæ¯ç®¡ç†MsgIdå’Œå¯¹åº”å¤„ç†æ–¹æ³•çš„æ¶ˆæ¯ç®¡ç†æ¨¡å—</span><br>    MsgHandler ziface.IMsgHandle<br>    <span class="hljs-comment">//å‘ŠçŸ¥è¯¥é“¾æ¥å·²ç»é€€å‡º/åœæ­¢çš„channel</span><br>    ExitBuffChan <span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span><br>    <span class="hljs-comment">//æ— ç¼“å†²ç®¡é“ï¼Œç”¨äºè¯»ã€å†™ä¸¤ä¸ªgoroutineä¹‹é—´çš„æ¶ˆæ¯é€šä¿¡</span><br>    msgChan        <span class="hljs-keyword">chan</span> []<span class="hljs-type">byte</span><br>&#125;<br><span class="hljs-comment">//åˆ›å»ºè¿æ¥çš„æ–¹æ³•</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewConntion</span><span class="hljs-params">(conn *net.TCPConn, connID <span class="hljs-type">uint32</span>, msgHandler ziface.IMsgHandle)</span></span> *Connection&#123;<br>    c := &amp;Connection&#123;<br>        Conn:     conn,<br>        ConnID:   connID,<br>        isClosed: <span class="hljs-literal">false</span>,<br>        MsgHandler: msgHandler,<br>        ExitBuffChan: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span>, <span class="hljs-number">1</span>),<br>        msgChan:<span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> []<span class="hljs-type">byte</span>), <span class="hljs-comment">//msgChanåˆå§‹åŒ–</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> c<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="2-åˆ›å»º-Writer-Goroutine"><a href="#2-åˆ›å»º-Writer-Goroutine" class="headerlink" title="2. åˆ›å»º Writer Goroutine"></a>2. åˆ›å»º Writer Goroutine</h3><blockquote>
<p>zinx/znet/connection.go</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/*</span><br><span class="hljs-comment">    å†™æ¶ˆæ¯Goroutineï¼Œ ç”¨æˆ·å°†æ•°æ®å‘é€ç»™å®¢æˆ·ç«¯</span><br><span class="hljs-comment"> */</span><br> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Connection)</span></span> StartWriter() &#123;<br>    fmt.Println(<span class="hljs-string">&quot;[Writer Goroutine is running]&quot;</span>)<br>    <span class="hljs-keyword">defer</span> fmt.Println(c.RemoteAddr().String(), <span class="hljs-string">&quot;[conn Writer exit!]&quot;</span>)<br>     <span class="hljs-keyword">for</span> &#123;<br>         <span class="hljs-keyword">select</span> &#123;<br>             <span class="hljs-keyword">case</span> data := &lt;-c.msgChan:<br>                 <span class="hljs-comment">//æœ‰æ•°æ®è¦å†™ç»™å®¢æˆ·ç«¯</span><br>                 <span class="hljs-keyword">if</span> _, err := c.Conn.Write(data); err != <span class="hljs-literal">nil</span> &#123;<br>                     fmt.Println(<span class="hljs-string">&quot;Send Data error:, &quot;</span>, err, <span class="hljs-string">&quot; Conn Writer exit&quot;</span>)<br>                     <span class="hljs-keyword">return</span><br>                &#125;<br>             <span class="hljs-keyword">case</span> &lt;- c.ExitBuffChan:<br>                 <span class="hljs-comment">//connå·²ç»å…³é—­</span><br>                 <span class="hljs-keyword">return</span><br>        &#125;<br>    &#125;<br> &#125;<br></code></pre></td></tr></table></figure>
<p>å…³äº for select å’Œ channel çš„ç”¨æ³•ï¼š</p>
<p>select è¯­å¥åªèƒ½ä¸é€šé“è”ç”¨ï¼Œå®ƒä¸€èˆ¬ç”±è‹¥å¹²ä¸ªåˆ†æ”¯ç»„æˆã€‚æ¯æ¬¡æ‰§è¡Œè¿™ç§è¯­å¥çš„æ—¶å€™ï¼Œä¸€èˆ¬åªæœ‰ä¸€ä¸ªåˆ†æ”¯ä¸­çš„ä»£ç ä¼šè¢«è¿è¡Œã€‚select è¯­å¥çš„åˆ†æ”¯åˆ†ä¸ºä¸¤ç§ï¼Œä¸€ç§å«åšå€™é€‰åˆ†æ”¯ï¼Œå¦ä¸€ç§å«åšé»˜è®¤åˆ†æ”¯ã€‚å€™é€‰åˆ†æ”¯æ€»æ˜¯ä»¥å…³é”®å­— case å¼€å¤´ï¼Œåè·Ÿä¸€ä¸ª case è¡¨è¾¾å¼å’Œä¸€ä¸ªå†’å·ï¼Œç„¶åæˆ‘ä»¬å¯ä»¥ä»ä¸‹ä¸€è¡Œå¼€å§‹å†™å…¥å½“åˆ†æ”¯è¢«é€‰ä¸­æ—¶éœ€è¦æ‰§è¡Œçš„è¯­å¥ã€‚</p>
<p>ç”±äº select è¯­å¥æ˜¯ä¸“ä¸ºé€šé“è€Œè®¾è®¡çš„ï¼Œæ‰€ä»¥æ¯ä¸ª case è¡¨è¾¾å¼ä¸­éƒ½åªèƒ½åŒ…å«æ“ä½œé€šé“çš„è¡¨è¾¾å¼ï¼Œæ¯”å¦‚æ¥æ”¶è¡¨è¾¾å¼ã€‚ä½¿ç”¨ä¸€ä¸ªæ¥æ”¶å€¼å¯ä»¥æ¥æ”¶é€šé“é‡Œçš„å€¼ï¼Œä½¿ç”¨ä¸¤ä¸ªæ¥æ”¶å€¼å¯ä»¥åˆ¤æ–­é€šé“æ˜¯å¦å·²ç»å…³é—­äº†ã€‚</p>
<p>å¯¹äº select è¯­å¥çš„æ‰§è¡Œè§„åˆ™å¦‚ä¸‹ï¼š</p>
<ul>
<li>æ¯ä¸ª case éƒ½å¿…é¡»æ˜¯ä¸€ä¸ªé€šä¿¡ã€‚</li>
<li>æ‰€æœ‰ Channel è¡¨è¾¾å¼éƒ½ä¼šè¢«æ±‚å€¼ã€‚</li>
<li>æ‰€æœ‰è¢«å‘é€çš„è¡¨è¾¾å¼éƒ½ä¼šè¢«æ±‚å€¼ã€‚</li>
<li>å¦‚æœä»»æ„æŸä¸ªé€šä¿¡å¯ä»¥è¿›è¡Œï¼Œå®ƒå°±æ‰§è¡Œï¼Œå…¶ä»–è¢«å¿½ç•¥ã€‚</li>
<li>å¦‚æœæœ‰å¤šä¸ª case éƒ½å¯ä»¥è¿è¡Œï¼ŒSelect ä¼šéšæœºå…¬å¹³åœ°é€‰å‡ºä¸€ä¸ªæ‰§è¡Œã€‚å…¶ä»–ä¸ä¼šæ‰§è¡Œã€‚ å¦åˆ™ï¼š</li>
<li>å¦‚æœæœ‰ default å­å¥ï¼Œåˆ™æ‰§è¡Œè¯¥è¯­å¥ã€‚</li>
<li>å¦‚æœæ²¡æœ‰ default å­å¥ï¼Œselect å°†é˜»å¡ï¼Œç›´åˆ°æŸä¸ªé€šä¿¡å¯ä»¥è¿è¡Œï¼›Go ä¸ä¼šé‡æ–°å¯¹ Channel æˆ–å€¼è¿›è¡Œæ±‚å€¼ã€‚</li>
</ul>
<p>æ³¨æ„è¿™é‡Œæ˜¯å’Œ switch çš„æ“ä½œæ˜¯ä¸ä¸€æ ·çš„ï¼Œswitch æ“ä½œä¸­ï¼Œåªè¦ä»ä¸Šåˆ°ä¸‹æœ‰ä¸€ä¸ªæ»¡è¶³æ¡ä»¶äº†ï¼Œå°±ä¼šæ‰§è¡Œç›¸åº”çš„é‚£ä¸€ä¸ª caseï¼Œselect ä¸­ï¼Œæˆ‘ä»¬æ˜¯å…¨éƒ¨è®¡ç®—ä¸€éï¼Œç„¶åå†ä»å¯æ»¡è¶³æ¡ä»¶çš„ case ä¸­å…¬å¹³çš„æ‰§è¡Œå…¶ä¸­ä¸€ä¸ªã€‚è¿™æ˜¯ä¸ºäº†é˜²æ­¢æœ‰äº›é€šé“é•¿æœŸå¾—ä¸åˆ°æ‰§è¡Œã€‚</p>
<h3 id="3-Reader-å°†å‘é€å®¢æˆ·ç«¯çš„æ•°æ®æ”¹ä¸ºå‘é€è‡³Channel"><a href="#3-Reader-å°†å‘é€å®¢æˆ·ç«¯çš„æ•°æ®æ”¹ä¸ºå‘é€è‡³Channel" class="headerlink" title="3. Reader å°†å‘é€å®¢æˆ·ç«¯çš„æ•°æ®æ”¹ä¸ºå‘é€è‡³Channel"></a>3. Reader å°†å‘é€å®¢æˆ·ç«¯çš„æ•°æ®æ”¹ä¸ºå‘é€è‡³Channel</h3><p>ä¿®æ”¹ Reader è°ƒç”¨çš„<code>SendMsg()</code>æ–¹æ³•</p>
<blockquote>
<p>zinx/znet/connection.go</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">//ç›´æ¥å°†Messageæ•°æ®å‘é€æ•°æ®ç»™è¿œç¨‹çš„TCPå®¢æˆ·ç«¯</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Connection)</span></span> SendMsg(msgId <span class="hljs-type">uint32</span>, data []<span class="hljs-type">byte</span>) <span class="hljs-type">error</span> &#123;<br>    <span class="hljs-keyword">if</span> c.isClosed == <span class="hljs-literal">true</span> &#123;<br>        <span class="hljs-keyword">return</span> errors.New(<span class="hljs-string">&quot;Connection closed when send msg&quot;</span>)<br>    &#125;<br>    <span class="hljs-comment">//å°†dataå°åŒ…ï¼Œå¹¶ä¸”å‘é€</span><br>    dp := NewDataPack()<br>    msg, err := dp.Pack(NewMsgPackage(msgId, data))<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        fmt.Println(<span class="hljs-string">&quot;Pack error msg id = &quot;</span>, msgId)<br>        <span class="hljs-keyword">return</span>  errors.New(<span class="hljs-string">&quot;Pack error msg &quot;</span>)<br>    &#125;<br>    <span class="hljs-comment">//å†™å›å®¢æˆ·ç«¯ä¹‹å‰æ˜¯å†™åˆ°å®¢æˆ·ç«¯ï¼Œç°åœ¨æ˜¯å†™åˆ°channelå°±å¯ä»¥</span><br>    c.msgChan &lt;- msg   <span class="hljs-comment">//å°†ä¹‹å‰ç›´æ¥å›å†™ç»™conn.Writeçš„æ–¹æ³• æ”¹ä¸º å‘é€ç»™Channel ä¾›Writerè¯»å–</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>ä¿®æ”¹<code>Start()</code>æ–¹æ³•</p>
<blockquote>
<p>zinx/znet/connection.go</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">//å¯åŠ¨è¿æ¥ï¼Œè®©å½“å‰è¿æ¥å¼€å§‹å·¥ä½œ</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Connection)</span></span> Start() &#123;<br>    <span class="hljs-comment">//1 å¼€å¯ç”¨æˆ·ä»å®¢æˆ·ç«¯è¯»å–æ•°æ®æµç¨‹çš„Goroutine</span><br>    <span class="hljs-keyword">go</span> c.StartReader()<br>    <span class="hljs-comment">//2 å¼€å¯ç”¨äºå†™å›å®¢æˆ·ç«¯æ•°æ®æµç¨‹çš„Goroutine</span><br>    <span class="hljs-keyword">go</span> c.StartWriter()<br>    <span class="hljs-keyword">for</span> &#123;<br>        <span class="hljs-keyword">select</span> &#123;<br>        <span class="hljs-keyword">case</span> &lt;- c.ExitBuffChan:<br>            <span class="hljs-comment">//å¾—åˆ°é€€å‡ºæ¶ˆæ¯ï¼Œä¸å†é˜»å¡</span><br>            <span class="hljs-keyword">return</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="Zinxæµ‹è¯•"><a href="#Zinxæµ‹è¯•" class="headerlink" title="Zinxæµ‹è¯•"></a>Zinxæµ‹è¯•</h2><p>0.7ç‰ˆæœ¬çš„æµ‹è¯•ä¸0.6ä¸€è‡´ï¼Œå› ä¸ºåªä¿®æ”¹äº†å†…éƒ¨æ¶ˆæ¯å‘é€çš„æœºåˆ¶ï¼Œ<strong>å¯¹å¤–çš„æ¶ˆæ¯æ¥å£å¹¶æ²¡æœ‰å‘ç”Ÿå˜åŒ–</strong></p>
<h1 id="v0-8-å®ç°å·¥ä½œæ± "><a href="#v0-8-å®ç°å·¥ä½œæ± " class="headerlink" title="[v0.8] å®ç°å·¥ä½œæ± "></a>[v0.8] å®ç°å·¥ä½œæ± </h1><h2 id="åŠŸèƒ½-5"><a href="#åŠŸèƒ½-5" class="headerlink" title="åŠŸèƒ½"></a>åŠŸèƒ½</h2><p>ç»™Zinxæ·»åŠ æ¶ˆæ¯é˜Ÿåˆ—å’Œå¤šä»»åŠ¡Workeræœºåˆ¶ã€‚</p>
<p><img src="../../../images/Zinx/2df6505fac57bea709e363da21fcfa1d-0.png" alt="img"></p>
<blockquote>
<p><strong>çŸ¥è¯†ç‚¹</strong></p>
<ol>
<li>æ¶ˆæ¯é˜Ÿåˆ—</li>
<li>å·¥ä½œæ± </li>
</ol>
</blockquote>
<p>è¿™ä¸€æ­¥æˆ‘ä»¬è¦å®ç°çš„æ˜¯ï¼Œå¯ä»¥é€šè¿‡ worker çš„æ•°é‡æ¥é™å®šå¤„ç†ä¸šåŠ¡çš„å›ºå®šgoroutineæ•°é‡ï¼Œè€Œä¸æ˜¯æ— é™åˆ¶çš„å¼€è¾ŸGoroutineï¼Œéšè°ˆæˆ‘ä»¬çŸ¥é“goçš„è°ƒåº¦ç®—æ³•å·²ç»åšçš„å¾ˆæè‡´äº†ï¼Œä½†æ˜¯å¤§æ•°é‡çš„Goroutineä¾ç„¶ä¼šå¸¦æ¥ä¸€äº›ä¸å¿…è¦çš„ç¯å¢ƒåˆ‡æ¢æˆæœ¬ï¼Œè¿™äº›æœ¬åº”è¯¥æ˜¯æœåŠ¡å™¨åº”è¯¥èŠ‚çœæ‰çš„æˆæœ¬ã€‚æˆ‘ä»¬å¯ä»¥ç”¨æ¶ˆæ¯é˜Ÿåˆ—æ¥ç¼“å†²workerå·¥ä½œçš„æ•°æ®ã€‚</p>
<p>è®¾è®¡ç»“æ„å¦‚ä¸‹ï¼š</p>
<p><img src="../../../images/Zinx/6d0404ac69418597983083fd7ea27e89.jpeg" alt="img"></p>
<h2 id="æ­¥éª¤"><a href="#æ­¥éª¤" class="headerlink" title="æ­¥éª¤"></a>æ­¥éª¤</h2><h3 id="1-åˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ—"><a href="#1-åˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ—" class="headerlink" title="1. åˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ—"></a>1. åˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ—</h3><p>é¦–å…ˆï¼Œå¤„ç†æ¶ˆæ¯é˜Ÿåˆ—çš„éƒ¨åˆ†ï¼Œæˆ‘ä»¬åº”è¯¥é›†æˆåˆ°<code>MsgHandler</code>æ¨¡å—ä¸‹ï¼Œå› ä¸ºå±äºæˆ‘ä»¬æ¶ˆæ¯æ¨¡å—èŒƒç•´å†…çš„ã€‚</p>
<blockquote>
<p>zinx/znet/msghandler.go</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> MsgHandle <span class="hljs-keyword">struct</span> &#123;<br>    Apis           <span class="hljs-keyword">map</span>[<span class="hljs-type">uint32</span>]ziface.IRouter  <span class="hljs-comment">//å­˜æ”¾æ¯ä¸ªMsgId æ‰€å¯¹åº”çš„å¤„ç†æ–¹æ³•çš„mapå±æ€§</span><br>    WorkerPoolSize <span class="hljs-type">uint32</span>                     <span class="hljs-comment">//ä¸šåŠ¡å·¥ä½œWorkeræ± çš„æ•°é‡</span><br>    TaskQueue      []<span class="hljs-keyword">chan</span> ziface.IRequest     <span class="hljs-comment">//Workerè´Ÿè´£å–ä»»åŠ¡çš„æ¶ˆæ¯é˜Ÿåˆ—</span><br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewMsgHandle</span><span class="hljs-params">()</span></span> *MsgHandle &#123;<br>    <span class="hljs-keyword">return</span> &amp;MsgHandle&#123;<br>        Apis: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">uint32</span>]ziface.IRouter),<br>        WorkerPoolSize:utils.GlobalObject.WorkerPoolSize,<br>        <span class="hljs-comment">//ä¸€ä¸ªworkerå¯¹åº”ä¸€ä¸ªqueue</span><br>        TaskQueue:<span class="hljs-built_in">make</span>([]<span class="hljs-keyword">chan</span> ziface.IRequest, utils.GlobalObject.WorkerPoolSize),<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>è¿™é‡Œæ·»åŠ ä¸¤ä¸ªæˆå‘˜:</p>
<ul>
<li><code>WokerPoolSize</code>:ä½œä¸ºå·¥ä½œæ± çš„æ•°é‡ï¼Œå› ä¸º TaskQueue ä¸­çš„æ¯ä¸ªé˜Ÿåˆ—åº”è¯¥æ˜¯å’Œä¸€ä¸ª Worker å¯¹åº”çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨åˆ›å»º TaskQueue ä¸­é˜Ÿåˆ—æ•°é‡è¦å’Œ Worker çš„æ•°é‡ä¸€è‡´ã€‚</li>
<li><code>TaskQueue</code>çœŸæ˜¯ä¸€ä¸ª Request è¯·æ±‚ä¿¡æ¯çš„ channel é›†åˆã€‚ç”¨æ¥ç¼“å†²æä¾› worker è°ƒç”¨çš„ Request è¯·æ±‚ä¿¡æ¯ï¼Œworker ä¼šä»å¯¹åº”çš„é˜Ÿåˆ—ä¸­è·å–å®¢æˆ·ç«¯çš„è¯·æ±‚æ•°æ®å¹¶ä¸”å¤„ç†æ‰ã€‚</li>
</ul>
<p>å½“ç„¶<code>WorkerPoolSize</code>æœ€å¥½ä¹Ÿå¯ä»¥ä»<code>GlobalObject</code>è·å–ï¼Œå¹¶ä¸”<code>zinx.json</code>é…ç½®æ–‡ä»¶å¯ä»¥æ‰‹åŠ¨é…ç½®ã€‚</p>
<blockquote>
<p>zinx/utils/globalobj.go</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/*</span><br><span class="hljs-comment">    å­˜å‚¨ä¸€åˆ‡æœ‰å…³Zinxæ¡†æ¶çš„å…¨å±€å‚æ•°ï¼Œä¾›å…¶ä»–æ¨¡å—ä½¿ç”¨</span><br><span class="hljs-comment">    ä¸€äº›å‚æ•°ä¹Ÿå¯ä»¥é€šè¿‡ ç”¨æˆ·æ ¹æ® zinx.jsonæ¥é…ç½®</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">type</span> GlobalObj <span class="hljs-keyword">struct</span> &#123;<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">        Server</span><br><span class="hljs-comment">    */</span><br>    TcpServer ziface.IServer <span class="hljs-comment">//å½“å‰Zinxçš„å…¨å±€Serverå¯¹è±¡</span><br>    Host      <span class="hljs-type">string</span>         <span class="hljs-comment">//å½“å‰æœåŠ¡å™¨ä¸»æœºIP</span><br>    TcpPort   <span class="hljs-type">int</span>            <span class="hljs-comment">//å½“å‰æœåŠ¡å™¨ä¸»æœºç›‘å¬ç«¯å£å·</span><br>    Name      <span class="hljs-type">string</span>         <span class="hljs-comment">//å½“å‰æœåŠ¡å™¨åç§°</span><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">        Zinx</span><br><span class="hljs-comment">    */</span><br>    Version          <span class="hljs-type">string</span> <span class="hljs-comment">//å½“å‰Zinxç‰ˆæœ¬å·</span><br>    MaxPacketSize    <span class="hljs-type">uint32</span> <span class="hljs-comment">//éƒ½éœ€æ•°æ®åŒ…çš„æœ€å¤§å€¼</span><br>    MaxConn          <span class="hljs-type">int</span>    <span class="hljs-comment">//å½“å‰æœåŠ¡å™¨ä¸»æœºå…è®¸çš„æœ€å¤§é“¾æ¥ä¸ªæ•°</span><br>    WorkerPoolSize   <span class="hljs-type">uint32</span> <span class="hljs-comment">//ä¸šåŠ¡å·¥ä½œWorkeræ± çš„æ•°é‡</span><br>    MaxWorkerTaskLen <span class="hljs-type">uint32</span> <span class="hljs-comment">//ä¸šåŠ¡å·¥ä½œWorkerå¯¹åº”è´Ÿè´£çš„ä»»åŠ¡é˜Ÿåˆ—æœ€å¤§ä»»åŠ¡å­˜å‚¨æ•°é‡</span><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">        config file path</span><br><span class="hljs-comment">    */</span><br>    ConfFilePath <span class="hljs-type">string</span><br>&#125;<br><span class="hljs-comment">//...</span><br><span class="hljs-comment">//...</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">    æä¾›initæ–¹æ³•ï¼Œé»˜è®¤åŠ è½½</span><br><span class="hljs-comment">*/</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-comment">//åˆå§‹åŒ–GlobalObjectå˜é‡ï¼Œè®¾ç½®ä¸€äº›é»˜è®¤å€¼</span><br>    GlobalObject = &amp;GlobalObj&#123;<br>        Name:          <span class="hljs-string">&quot;ZinxServerApp&quot;</span>,<br>        Version:       <span class="hljs-string">&quot;V0.4&quot;</span>,<br>        TcpPort:       <span class="hljs-number">7777</span>,<br>        Host:          <span class="hljs-string">&quot;0.0.0.0&quot;</span>,<br>        MaxConn:       <span class="hljs-number">12000</span>,<br>        MaxPacketSize: <span class="hljs-number">4096</span>,<br>        ConfFilePath:  <span class="hljs-string">&quot;conf/zinx.json&quot;</span>,<br>        WorkerPoolSize: <span class="hljs-number">10</span>,<br>        MaxWorkerTaskLen: <span class="hljs-number">1024</span>,<br>    &#125;<br>    <span class="hljs-comment">//ä»é…ç½®æ–‡ä»¶ä¸­åŠ è½½ä¸€äº›ç”¨æˆ·é…ç½®çš„å‚æ•°</span><br>    GlobalObject.Reload()<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="2-åˆ›å»ºåŠå¯åŠ¨Workerå·¥ä½œæ± "><a href="#2-åˆ›å»ºåŠå¯åŠ¨Workerå·¥ä½œæ± " class="headerlink" title="2. åˆ›å»ºåŠå¯åŠ¨Workerå·¥ä½œæ± "></a>2. åˆ›å»ºåŠå¯åŠ¨Workerå·¥ä½œæ± </h3><p>ç°åœ¨æ·»åŠ  Worker å·¥ä½œæ± ï¼Œå…ˆå®šä¹‰ä¸€äº›å¯åŠ¨å·¥ä½œæ± çš„æ¥å£ã€‚</p>
<blockquote>
<p>zinx/ziface/imsghandler.go</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/*</span><br><span class="hljs-comment">    æ¶ˆæ¯ç®¡ç†æŠ½è±¡å±‚</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">type</span> IMsgHandle <span class="hljs-keyword">interface</span>&#123;<br>    DoMsgHandler(request IRequest)            <span class="hljs-comment">//é©¬ä¸Šä»¥éé˜»å¡æ–¹å¼å¤„ç†æ¶ˆæ¯</span><br>    AddRouter(msgId <span class="hljs-type">uint32</span>, router IRouter)    <span class="hljs-comment">//ä¸ºæ¶ˆæ¯æ·»åŠ å…·ä½“çš„å¤„ç†é€»è¾‘</span><br>    StartWorkerPool()                        <span class="hljs-comment">//å¯åŠ¨workerå·¥ä½œæ± </span><br>    SendMsgToTaskQueue(request IRequest)    <span class="hljs-comment">//å°†æ¶ˆæ¯äº¤ç»™TaskQueue,ç”±workerè¿›è¡Œå¤„ç†</span><br>&#125;<br></code></pre></td></tr></table></figure>
<blockquote>
<p>zinx/znet/msghandler.go</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// æ³¨æ„ï¼Œå¤´æ–‡ä»¶ä¸­è¦å¼•å…¥ zinx/utils</span><br><span class="hljs-comment">//å¯åŠ¨ä¸€ä¸ªWorkerå·¥ä½œæµç¨‹</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(mh *MsgHandle)</span></span> StartOneWorker(workerID <span class="hljs-type">int</span>, taskQueue <span class="hljs-keyword">chan</span> ziface.IRequest) &#123;<br>    fmt.Println(<span class="hljs-string">&quot;Worker ID = &quot;</span>, workerID, <span class="hljs-string">&quot; is started.&quot;</span>)<br>    <span class="hljs-comment">//ä¸æ–­çš„ç­‰å¾…é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯</span><br>    <span class="hljs-keyword">for</span> &#123;<br>        <span class="hljs-keyword">select</span> &#123;<br>            <span class="hljs-comment">//æœ‰æ¶ˆæ¯åˆ™å–å‡ºé˜Ÿåˆ—çš„Requestï¼Œå¹¶æ‰§è¡Œç»‘å®šçš„ä¸šåŠ¡æ–¹æ³•</span><br>            <span class="hljs-keyword">case</span> request := &lt;-taskQueue:<br>                mh.DoMsgHandler(request)<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-comment">//å¯åŠ¨workerå·¥ä½œæ± </span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(mh *MsgHandle)</span></span> StartWorkerPool() &#123;<br>    <span class="hljs-comment">//éå†éœ€è¦å¯åŠ¨workerçš„æ•°é‡ï¼Œä¾æ­¤å¯åŠ¨</span><br>    <span class="hljs-keyword">for</span> i:= <span class="hljs-number">0</span>; i &lt; <span class="hljs-type">int</span>(mh.WorkerPoolSize); i++ &#123;<br>        <span class="hljs-comment">//ä¸€ä¸ªworkerè¢«å¯åŠ¨</span><br>        <span class="hljs-comment">//ç»™å½“å‰workerå¯¹åº”çš„ä»»åŠ¡é˜Ÿåˆ—å¼€è¾Ÿç©ºé—´</span><br>        mh.TaskQueue[i] = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> ziface.IRequest, utils.GlobalObject.MaxWorkerTaskLen)<br>        <span class="hljs-comment">//å¯åŠ¨å½“å‰Workerï¼Œé˜»å¡çš„ç­‰å¾…å¯¹åº”çš„ä»»åŠ¡é˜Ÿåˆ—æ˜¯å¦æœ‰æ¶ˆæ¯ä¼ é€’è¿›æ¥</span><br>        <span class="hljs-keyword">go</span> mh.StartOneWorker(i, mh.TaskQueue[i])<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><code>StartWorkerPool()</code>æ–¹æ³•æ˜¯å¯åŠ¨ Worker å·¥ä½œæ± ï¼Œè¿™é‡Œæ ¹æ®ç”¨æˆ·é…ç½®å¥½çš„<code>WorkerPoolSize</code>çš„æ•°é‡æ¥å¯åŠ¨ï¼Œç„¶ååˆ†åˆ«ç»™æ¯ä¸ª Worker åˆ†é…ä¸€ä¸ª<code>TaskQueue</code>ï¼Œç„¶åç”¨ä¸€ä¸ª goroutine æ¥æ‰¿è½½ä¸€ä¸ª Worker çš„å·¥ä½œä¸šåŠ¡ã€‚</p>
<p><code>StartOneWorker()</code>æ–¹æ³•å°±æ˜¯ä¸€ä¸ª Worker çš„å·¥ä½œä¸šåŠ¡ï¼Œæ¯ä¸ª worker æ˜¯ä¸ä¼šé€€å‡ºçš„(ç›®å‰æ²¡æœ‰è®¾å®š worker çš„åœæ­¢å·¥ä½œæœºåˆ¶)ï¼Œä¼šæ°¸ä¹…çš„ä»å¯¹åº”çš„ TaskQueue ä¸­ç­‰å¾…æ¶ˆæ¯ï¼Œå¹¶å¤„ç†ã€‚</p>
<h3 id="3-å‘é€æ¶ˆæ¯ç»™æ¶ˆæ¯é˜Ÿåˆ—"><a href="#3-å‘é€æ¶ˆæ¯ç»™æ¶ˆæ¯é˜Ÿåˆ—" class="headerlink" title="3. å‘é€æ¶ˆæ¯ç»™æ¶ˆæ¯é˜Ÿåˆ—"></a>3. å‘é€æ¶ˆæ¯ç»™æ¶ˆæ¯é˜Ÿåˆ—</h3><p>ç°åœ¨ï¼Œworker å·¥ä½œæ± å·²ç»å‡†å¤‡å°±ç»ªäº†ï¼Œé‚£ä¹ˆå°±éœ€è¦æœ‰ä¸€ä¸ªç»™åˆ° worker å·¥ä½œæ± æ¶ˆæ¯çš„å…¥å£ï¼Œæˆ‘ä»¬å†å®šä¹‰ä¸€ä¸ªæ–¹æ³•</p>
<blockquote>
<p>zinx/znet/msghandler.go</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">//å°†æ¶ˆæ¯äº¤ç»™TaskQueue,ç”±workerè¿›è¡Œå¤„ç†</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(mh *MsgHandle)</span></span>SendMsgToTaskQueue(request ziface.IRequest) &#123;<br>    <span class="hljs-comment">//æ ¹æ®ConnIDæ¥åˆ†é…å½“å‰çš„è¿æ¥åº”è¯¥ç”±å“ªä¸ªworkerè´Ÿè´£å¤„ç†</span><br>    <span class="hljs-comment">//è½®è¯¢çš„å¹³å‡åˆ†é…æ³•åˆ™</span><br>    <span class="hljs-comment">//å¾—åˆ°éœ€è¦å¤„ç†æ­¤æ¡è¿æ¥çš„workerID</span><br>    workerID := request.GetConnection().GetConnID() % mh.WorkerPoolSize<br>    fmt.Println(<span class="hljs-string">&quot;Add ConnID=&quot;</span>, request.GetConnection().GetConnID(),<span class="hljs-string">&quot; request msgID=&quot;</span>, request.GetMsgID(), <span class="hljs-string">&quot;to workerID=&quot;</span>, workerID)<br>    <span class="hljs-comment">//å°†è¯·æ±‚æ¶ˆæ¯å‘é€ç»™ä»»åŠ¡é˜Ÿåˆ—</span><br>    mh.TaskQueue[workerID] &lt;- request<br>&#125;<br></code></pre></td></tr></table></figure>
<p><code>SendMsgToTaskQueue()</code>ä½œä¸ºå·¥ä½œæ± çš„æ•°æ®å…¥å£ï¼Œè¿™é‡Œé¢é‡‡ç”¨çš„æ˜¯è½®è¯¢çš„åˆ†é…æœºåˆ¶ï¼Œå› ä¸ºä¸åŒé“¾æ¥ä¿¡æ¯éƒ½ä¼šè°ƒç”¨è¿™ä¸ªå…¥å£ï¼Œé‚£ä¹ˆåˆ°åº•åº”è¯¥ç”±å“ªä¸ª worker å¤„ç†è¯¥é“¾æ¥çš„è¯·æ±‚å¤„ç†ï¼Œæ•´ç†ç”¨çš„æ˜¯ä¸€ä¸ªç®€å•çš„æ±‚æ¨¡è¿ç®—ã€‚ç”¨ä½™æ•°å’Œ workerID çš„åŒ¹é…æ¥è¿›è¡Œåˆ†é…ã€‚</p>
<p>æœ€ç»ˆå°† request è¯·æ±‚æ•°æ®å‘é€ç»™å¯¹åº” worker çš„ TaskQueueï¼Œé‚£ä¹ˆå¯¹åº”çš„ worker çš„ Goroutine å°±ä¼šå¤„ç†è¯¥é“¾æ¥è¯·æ±‚äº†ã€‚</p>
<h3 id="4-å·¥ä½œæ± ä»£ç è°ƒç”¨"><a href="#4-å·¥ä½œæ± ä»£ç è°ƒç”¨" class="headerlink" title="4. å·¥ä½œæ± ä»£ç è°ƒç”¨"></a>4. å·¥ä½œæ± ä»£ç è°ƒç”¨</h3><p>å¥½äº†ï¼Œç°åœ¨éœ€è¦å°†æ¶ˆæ¯é˜Ÿåˆ—å’Œå¤šä»»åŠ¡ worker æœºåˆ¶é›†æˆåˆ°æˆ‘ä»¬ Zinx çš„ä¸­äº†ã€‚æˆ‘ä»¬åœ¨ Server çš„<code>Start()</code>æ–¹æ³•ä¸­ï¼Œåœ¨æœåŠ¡ç«¯ Accept ä¹‹å‰ï¼Œå¯åŠ¨ Worker å·¥ä½œæ± ã€‚</p>
<blockquote>
<p>zinx/znet/server.go</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">//å¼€å¯ç½‘ç»œæœåŠ¡,åªéœ€è¦ä¿®æ”¹è¿™é‡Œæ‰€æåˆ°çš„éƒ¨åˆ†ï¼Œå¯¹äºæ‰“äº† //... çš„éƒ¨åˆ†çš„æ„æ€æ˜¯åŸæ¥çš„ä»£ç ä¸éœ€è¦åšä¿®æ”¹</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Server)</span></span> Start() &#123;<br>    <span class="hljs-comment">//...</span><br>    <span class="hljs-comment">//å¼€å¯ä¸€ä¸ªgoå»åšæœåŠ¡ç«¯Linsterä¸šåŠ¡</span><br>    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>        <span class="hljs-comment">//0 å¯åŠ¨workerå·¥ä½œæ± æœºåˆ¶</span><br>        s.msgHandler.StartWorkerPool()<br>        <span class="hljs-comment">//1 è·å–ä¸€ä¸ªTCPçš„Addr</span><br>        addr, err := net.ResolveTCPAddr(s.IPVersion, fmt.Sprintf(<span class="hljs-string">&quot;%s:%d&quot;</span>, s.IP, s.Port))<br>        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>            fmt.Println(<span class="hljs-string">&quot;resolve tcp addr err: &quot;</span>, err)<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        <span class="hljs-comment">//...</span><br>        <span class="hljs-comment">//...</span><br>        &#125;<br>    &#125;()<br>&#125;<br></code></pre></td></tr></table></figure>
<p>å…¶æ¬¡ï¼Œå½“æˆ‘ä»¬å·²ç»å¾—åˆ°å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚è¿‡æ¥æ•°æ®çš„æ—¶å€™ï¼Œæˆ‘ä»¬åº”è¯¥å°†æ•°æ®å‘é€ç»™ Worker å·¥ä½œæ± è¿›è¡Œå¤„ç†ã€‚</p>
<p>æ‰€ä»¥åº”è¯¥åœ¨ Connection çš„<code>StartReader()</code>æ–¹æ³•ä¸­ä¿®æ”¹ï¼š</p>
<blockquote>
<p>zinx/znet/connection.go</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// æ³¨æ„ï¼Œå¤´æ–‡ä»¶ä¸­è¦å¼•å…¥ zinx/utils</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">    è¯»æ¶ˆæ¯Goroutineï¼Œç”¨äºä»å®¢æˆ·ç«¯ä¸­è¯»å–æ•°æ®</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Connection)</span></span> StartReader() &#123;<br>    fmt.Println(<span class="hljs-string">&quot;Reader Goroutine is  running&quot;</span>)<br>    <span class="hljs-keyword">defer</span> fmt.Println(c.RemoteAddr().String(), <span class="hljs-string">&quot; conn reader exit!&quot;</span>)<br>    <span class="hljs-keyword">defer</span> c.Stop()<br>    <span class="hljs-keyword">for</span>  &#123;<br>        <span class="hljs-comment">//...</span><br>        req := Request&#123;<br>            conn:c,<br>            msg:msg,<br>        &#125;<br>        <span class="hljs-keyword">if</span> utils.GlobalObject.WorkerPoolSize &gt; <span class="hljs-number">0</span> &#123;<br>            <span class="hljs-comment">//å·²ç»å¯åŠ¨å·¥ä½œæ± æœºåˆ¶ï¼Œå°†æ¶ˆæ¯äº¤ç»™Workerå¤„ç†</span><br>            c.MsgHandler.SendMsgToTaskQueue(&amp;req)<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">//ä»ç»‘å®šå¥½çš„æ¶ˆæ¯å’Œå¯¹åº”çš„å¤„ç†æ–¹æ³•ä¸­æ‰§è¡Œå¯¹åº”çš„Handleæ–¹æ³•</span><br>            <span class="hljs-keyword">go</span> c.MsgHandler.DoMsgHandler(&amp;req)<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>è¿™é‡Œå¹¶æ²¡æœ‰å¼ºåˆ¶ä½¿ç”¨å¤šä»»åŠ¡ Worker æœºåˆ¶ï¼Œè€Œæ˜¯åˆ¤æ–­ç”¨æˆ·é…ç½®<code>WorkerPoolSize</code>çš„ä¸ªæ•°ï¼Œå¦‚æœå¤§äº 0ï¼Œé‚£ä¹ˆæˆ‘å°±å¯åŠ¨å¤šä»»åŠ¡æœºåˆ¶å¤„ç†é“¾æ¥è¯·æ±‚æ¶ˆæ¯ï¼Œå¦‚æœ=0 æˆ–è€…&lt;0 é‚£ä¹ˆï¼Œæˆ‘ä»¬ä¾ç„¶åªæ˜¯ä¹‹å‰çš„å¼€å¯ä¸€ä¸ªä¸´æ—¶çš„ Goroutine å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚æ¶ˆæ¯ã€‚</p>
<h1 id="v0-9-å®ç°é“¾æ¥æ§åˆ¶"><a href="#v0-9-å®ç°é“¾æ¥æ§åˆ¶" class="headerlink" title="[v0.9] å®ç°é“¾æ¥æ§åˆ¶"></a>[v0.9] å®ç°é“¾æ¥æ§åˆ¶</h1><h2 id="åŠŸèƒ½-6"><a href="#åŠŸèƒ½-6" class="headerlink" title="åŠŸèƒ½"></a>åŠŸèƒ½</h2><p><img src="../../../images/Zinx/4f22d83440b9a7d22dbac2d076cbf574-0.png" alt="img"></p>
<blockquote>
<p><strong>çŸ¥è¯†ç‚¹</strong></p>
<ol>
<li>é“¾æ¥ç®¡ç†</li>
<li>æ•°é‡é™åˆ¶</li>
</ol>
</blockquote>
<h2 id="æ­¥éª¤-1"><a href="#æ­¥éª¤-1" class="headerlink" title="æ­¥éª¤"></a>æ­¥éª¤</h2></article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Go/">Go</a><a class="post-meta__tags" href="/tags/%E5%AE%9E%E9%AA%8C%E6%A5%BC/">å®éªŒæ¥¼</a><a class="post-meta__tags" href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8/">æœåŠ¡å™¨</a><a class="post-meta__tags" href="/tags/Zinx/">Zinx</a></div><div class="post_share"><div class="social-share" data-image="https://tvax3.sinaimg.cn/large/0072YHp3ly1gjvw20n7otj31hc0zdgxz.jpg" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/aa7a6db9"><img class="prev-cover" src="https://tvax3.sinaimg.cn/large/0072YHp3ly1gjvw20n7otj31hc0zdgxz.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">Goå­¦ä¹ ç¬”è®°ï¼ˆå®éªŒæ¥¼ï¼‰</div></div></a></div><div class="next-post pull-right"><a href="/posts/cd58c827"><img class="next-cover" src="https://tvax3.sinaimg.cn/large/0072YHp3ly1gjvw20n7otj31hc0zdgxz.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">è¿­ä»£ï¼ˆé¡¿å¼€ï¼‰</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><div><a href="/posts/8cb5320c" title="åŠ›æ‰£é«˜æ•ˆç®—æ³•å…¥é—¨"><img class="cover" src="/../../../images/EasyAlgorithm/image-20220108233318575.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-27</div><div class="title">åŠ›æ‰£é«˜æ•ˆç®—æ³•å…¥é—¨</div></div></a></div><div><a href="/posts/aa7a6db9" title="Goå­¦ä¹ ç¬”è®°ï¼ˆå®éªŒæ¥¼ï¼‰"><img class="cover" src="https://tvax3.sinaimg.cn/large/0072YHp3ly1gjvw20n7otj31hc0zdgxz.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-27</div><div class="title">Goå­¦ä¹ ç¬”è®°ï¼ˆå®éªŒæ¥¼ï¼‰</div></div></a></div><div><a href="/posts/206c9e3b" title="åŠ›æ‰£æ¯æ—¥ä¸€é¢˜"><img class="cover" src="https://tvax3.sinaimg.cn/large/0072YHp3ly1gjvw20n7otj31hc0zdgxz.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-27</div><div class="title">åŠ›æ‰£æ¯æ—¥ä¸€é¢˜</div></div></a></div><div><a href="/posts/24feca74" title="Go_hard_Algorithm"><img class="cover" src="/../../../images/EasyAlgorithm/image-20220108233318575.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-27</div><div class="title">Go_hard_Algorithm</div></div></a></div><div><a href="/posts/a0a70754" title="Go_Easy_Algorithm"><img class="cover" src="/../../../images/EasyAlgorithm/image-20220108233318575.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-27</div><div class="title">Go_Easy_Algorithm</div></div></a></div><div><a href="/posts/85980731" title="(Golang)é“¾è¡¨å­¦ä¹ è®°å½•"><img class="cover" src="https://tvax3.sinaimg.cn/large/0072YHp3ly1gjvw20n7otj31hc0zdgxz.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-27</div><div class="title">(Golang)é“¾è¡¨å­¦ä¹ è®°å½•</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/../../../images/icon.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">mingming.shi</div><div class="author-info__description">ä¿¡ä»°å°±æ˜¯åŠ›é‡</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">200</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">107</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">65</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://gitee.com/fole-del"><i class="fab fa-github"></i><span>ä¸€äº›å°Demo~</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="mailto:191099862@qq.com" target="_blank" title="Email"><i class="iconfont icon-Email"></i></a><a class="social-icon" href="https://tva3.sinaimg.cn/large/0072YHp3ly1gjtbxnamacj30e80e8dgx.jpg" target="_blank" title="weixin"><i class="iconfont icon-weixin"></i></a><a class="social-icon" href="http://wpa.qq.com/msgrd?v=3&amp;uin=191099862&amp;site=qq&amp;menu=yes" target="_blank" title="QQ"><i class="iconfont icon-QQ1"></i></a><a class="social-icon" href="https://blog.csdn.net/Fuel_Ming?spm=1001.2014.3001.5113" target="_blank" title="CSDN"><i class="iconfont icon-csdn"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>å…¬å‘Š</span></div><div class="announcement_content"><div id="balls"><div>å›ºæ‰§æ— <span style="background:white;border-radius:25px;color:black">ç½ª</span>â—â—â—</div><div class="snake-spinner"><span></span><span></span><span></span><span></span><span></span></div><div><span style="background:white;border-radius:25px;color:black">æ¢¦</span>æƒ³æœ‰ä»·ğŸŒˆğŸŒˆğŸŒˆ</div></div><div class="twopeople"><div class="twopeople"><div class="container"style="height:200px;"><canvas class="illo"width="800"height="800"style="max-width:200px; max-height:200px; touch-action:none; width:640px; height:640px;"></canvas></div><script src="https://cdn.guole.fun/js/twopeople1.js"></script><script src="https://cdn.guole.fun/js/zdog.dist.js"></script><script id="rendered-js"src="https://cdn.guole.fun/js/twopeople.js"></script><style>.twopeople{margin:0;align-items:center;justify-content:center;text-align:center}canvas{display:block;margin:0 auto;cursor:move}</style></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Zinx%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.</span> <span class="toc-text">Zinxæ¶æ„è®¾è®¡</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AF%B7%E6%B1%82%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%93%8D%E5%BA%94%E7%9A%84%E8%BF%87%E7%A8%8B"><span class="toc-number">1.1.</span> <span class="toc-text">å®¢æˆ·ç«¯è¯·æ±‚æœåŠ¡å™¨å“åº”çš„è¿‡ç¨‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Zinx%E5%8A%9F%E8%83%BD%E6%A8%A1%E5%9D%97"><span class="toc-number">1.2.</span> <span class="toc-text">ZinxåŠŸèƒ½æ¨¡å—</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#v0-1"><span class="toc-number">2.</span> <span class="toc-text">v0.1</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#iserver-go"><span class="toc-number">2.1.</span> <span class="toc-text">iserver.go</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#server-go"><span class="toc-number">2.2.</span> <span class="toc-text">server.go *</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#server-test-go"><span class="toc-number">2.3.</span> <span class="toc-text">server_test.go</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#v0-2-%E5%AE%9E%E7%8E%B0%E9%93%BE%E6%8E%A5%E5%B0%81%E8%A3%85%E4%B8%9A%E5%8A%A1%E4%B8%8E%E4%B8%9A%E5%8A%A1%E7%BB%91%E5%AE%9A"><span class="toc-number">3.</span> <span class="toc-text">[v0.2] å®ç°é“¾æ¥å°è£…ä¸šåŠ¡ä¸ä¸šåŠ¡ç»‘å®š</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84"><span class="toc-number">3.1.</span> <span class="toc-text">æ–‡ä»¶ç»“æ„</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81"><span class="toc-number">3.2.</span> <span class="toc-text">ä»£ç </span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#iconnection-go"><span class="toc-number">3.2.1.</span> <span class="toc-text">iconnection.go</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#connection-go"><span class="toc-number">3.2.2.</span> <span class="toc-text">connection.go</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#server-go-%E4%BB%A3%E7%A0%81%E4%BF%AE%E6%94%B9"><span class="toc-number">3.2.3.</span> <span class="toc-text">server.go ä»£ç ä¿®æ”¹</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#v0-3-%E5%AE%9E%E7%8E%B0%E5%9F%BA%E7%A1%80%E8%B7%AF%E7%94%B1%E6%A8%A1%E5%9D%97"><span class="toc-number">4.</span> <span class="toc-text">[v0.3] å®ç°åŸºç¡€è·¯ç”±æ¨¡å—</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD"><span class="toc-number">4.1.</span> <span class="toc-text">åŠŸèƒ½</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="toc-number">4.2.</span> <span class="toc-text">ç›®å½•ç»“æ„</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IRequest%E6%B6%88%E6%81%AF%E8%AF%B7%E6%B1%82%E6%8A%BD%E8%B1%A1%E7%B1%BB"><span class="toc-number">4.3.</span> <span class="toc-text">IRequestæ¶ˆæ¯è¯·æ±‚æŠ½è±¡ç±»</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IRouter%E8%B7%AF%E7%94%B1%E9%85%8D%E7%BD%AE%E6%8A%BD%E8%B1%A1%E7%B1%BB"><span class="toc-number">4.4.</span> <span class="toc-text">IRouterè·¯ç”±é…ç½®æŠ½è±¡ç±»*</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IServer%E5%A2%9E%E6%B7%BB%E8%B7%AF%E7%94%B1%E6%B7%BB%E5%8A%A0%E5%8A%9F%E8%83%BD"><span class="toc-number">4.5.</span> <span class="toc-text">IServerå¢æ·»è·¯ç”±æ·»åŠ åŠŸèƒ½</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#server%E7%B1%BB"><span class="toc-number">4.5.1.</span> <span class="toc-text">serverç±»</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Connection%E7%B1%BB"><span class="toc-number">4.5.2.</span> <span class="toc-text">Connectionç±»</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AddRouter"><span class="toc-number">4.5.3.</span> <span class="toc-text">AddRouter</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">4.6.</span> <span class="toc-text">æµ‹è¯•</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Server-go"><span class="toc-number">4.6.1.</span> <span class="toc-text">Server.go</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Client-go"><span class="toc-number">4.6.2.</span> <span class="toc-text">Client.go</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#v0-4-%E5%85%A8%E5%B1%80%E9%85%8D%E7%BD%AE%E6%A8%A1%E5%9D%97"><span class="toc-number">5.</span> <span class="toc-text">[v0.4] å…¨å±€é…ç½®æ¨¡å—</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD-1"><span class="toc-number">5.1.</span> <span class="toc-text">åŠŸèƒ½</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">5.2.</span> <span class="toc-text">é…ç½®æ–‡ä»¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#globalobj-go"><span class="toc-number">5.3.</span> <span class="toc-text">globalobj.go</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#V0-5-%E6%B6%88%E6%81%AF%E5%B0%81%E8%A3%85"><span class="toc-number">6.</span> <span class="toc-text">[V0.5] æ¶ˆæ¯å°è£…</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD-2"><span class="toc-number">6.1.</span> <span class="toc-text">åŠŸèƒ½</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%B6%88%E6%81%AF%E5%B0%81%E8%A3%85%E7%B1%BB%E5%9E%8B"><span class="toc-number">6.2.</span> <span class="toc-text">åˆ›å»ºæ¶ˆæ¯å°è£…ç±»å‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#imessage-go"><span class="toc-number">6.3.</span> <span class="toc-text">imessage.go</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#message-go"><span class="toc-number">6.4.</span> <span class="toc-text">message.go</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%86%E5%8C%85%E4%B8%8E%E5%B0%81%E5%8C%85"><span class="toc-number">6.5.</span> <span class="toc-text">æ‹†åŒ…ä¸å°åŒ…*</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%8B%86%E5%8C%85%E5%B0%81%E5%8C%85%E6%8A%BD%E8%B1%A1%E7%B1%BB"><span class="toc-number">6.5.1.</span> <span class="toc-text">åˆ›å»ºæ‹†åŒ…å°åŒ…æŠ½è±¡ç±»</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%8B%86%E5%8C%85%E5%B0%81%E5%8C%85%E7%B1%BB"><span class="toc-number">6.5.2.</span> <span class="toc-text">å®ç°æ‹†åŒ…å°åŒ…ç±»</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E6%8B%86%E5%8C%85%E4%B8%8E%E5%B0%81%E5%8C%85%E7%B1%BB%E5%9E%8B"><span class="toc-number">6.5.3.</span> <span class="toc-text">æµ‹è¯•æ‹†åŒ…ä¸å°åŒ…ç±»å‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Request%E5%AD%97%E6%AE%B5%E4%BF%AE%E6%94%B9"><span class="toc-number">6.5.4.</span> <span class="toc-text">Requestå­—æ®µä¿®æ”¹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E6%88%90%E6%8B%86%E5%8C%85%E8%BF%87%E7%A8%8B"><span class="toc-number">6.5.4.1.</span> <span class="toc-text">é›†æˆæ‹†åŒ…è¿‡ç¨‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%90%E4%BE%9B%E5%B0%81%E5%8C%85%E6%96%B9%E6%B3%95"><span class="toc-number">6.5.4.2.</span> <span class="toc-text">æä¾›å°åŒ…æ–¹æ³•</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#zinx-0-5-%E6%B5%8B%E8%AF%95"><span class="toc-number">6.5.5.</span> <span class="toc-text">zinx 0.5 æµ‹è¯•</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#v0-6-%E5%A4%9A%E8%B7%AF%E7%94%B1%E6%A8%A1%E5%BC%8F"><span class="toc-number">7.</span> <span class="toc-text">[v0.6] å¤šè·¯ç”±æ¨¡å¼</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD-3"><span class="toc-number">7.1.</span> <span class="toc-text">åŠŸèƒ½</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%B6%88%E6%81%AF%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97"><span class="toc-number">7.2.</span> <span class="toc-text">åˆ›å»ºæ¶ˆæ¯ç®¡ç†æ¨¡å—</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#zinx%E6%B5%8B%E8%AF%95"><span class="toc-number">7.3.</span> <span class="toc-text">zinxæµ‹è¯•</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#v0-7-%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB"><span class="toc-number">8.</span> <span class="toc-text">[v0.7] è¯»å†™åˆ†ç¦»</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD-4"><span class="toc-number">8.1.</span> <span class="toc-text">åŠŸèƒ½</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-number">8.2.</span> <span class="toc-text">å‡†å¤‡å·¥ä½œ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%B7%BB%E5%8A%A0%E8%AF%BB%E5%86%99%E6%A8%A1%E5%9D%97%E4%BA%A4%E4%BA%92%E6%95%B0%E6%8D%AE%E7%9A%84%E7%AE%A1%E9%81%93"><span class="toc-number">8.2.1.</span> <span class="toc-text">1. æ·»åŠ è¯»å†™æ¨¡å—äº¤äº’æ•°æ®çš„ç®¡é“</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%88%9B%E5%BB%BA-Writer-Goroutine"><span class="toc-number">8.2.2.</span> <span class="toc-text">2. åˆ›å»º Writer Goroutine</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Reader-%E5%B0%86%E5%8F%91%E9%80%81%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9A%84%E6%95%B0%E6%8D%AE%E6%94%B9%E4%B8%BA%E5%8F%91%E9%80%81%E8%87%B3Channel"><span class="toc-number">8.2.3.</span> <span class="toc-text">3. Reader å°†å‘é€å®¢æˆ·ç«¯çš„æ•°æ®æ”¹ä¸ºå‘é€è‡³Channel</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Zinx%E6%B5%8B%E8%AF%95"><span class="toc-number">8.3.</span> <span class="toc-text">Zinxæµ‹è¯•</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#v0-8-%E5%AE%9E%E7%8E%B0%E5%B7%A5%E4%BD%9C%E6%B1%A0"><span class="toc-number">9.</span> <span class="toc-text">[v0.8] å®ç°å·¥ä½œæ± </span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD-5"><span class="toc-number">9.1.</span> <span class="toc-text">åŠŸèƒ½</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4"><span class="toc-number">9.2.</span> <span class="toc-text">æ­¥éª¤</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%88%9B%E5%BB%BA%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-number">9.2.1.</span> <span class="toc-text">1. åˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ—</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%88%9B%E5%BB%BA%E5%8F%8A%E5%90%AF%E5%8A%A8Worker%E5%B7%A5%E4%BD%9C%E6%B1%A0"><span class="toc-number">9.2.2.</span> <span class="toc-text">2. åˆ›å»ºåŠå¯åŠ¨Workerå·¥ä½œæ± </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF%E7%BB%99%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-number">9.2.3.</span> <span class="toc-text">3. å‘é€æ¶ˆæ¯ç»™æ¶ˆæ¯é˜Ÿåˆ—</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%B7%A5%E4%BD%9C%E6%B1%A0%E4%BB%A3%E7%A0%81%E8%B0%83%E7%94%A8"><span class="toc-number">9.2.4.</span> <span class="toc-text">4. å·¥ä½œæ± ä»£ç è°ƒç”¨</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#v0-9-%E5%AE%9E%E7%8E%B0%E9%93%BE%E6%8E%A5%E6%8E%A7%E5%88%B6"><span class="toc-number">10.</span> <span class="toc-text">[v0.9] å®ç°é“¾æ¥æ§åˆ¶</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD-6"><span class="toc-number">10.1.</span> <span class="toc-text">åŠŸèƒ½</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4-1"><span class="toc-number">10.2.</span> <span class="toc-text">æ­¥éª¤</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>æœ€æ–°æ–‡ç« </span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/252a5848" title="ç—•è¿¹"><img src="/../../../../images/%E8%87%AA%E8%BF%B0/%E6%83%85%E6%84%9F8.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ç—•è¿¹"/></a><div class="content"><a class="title" href="/posts/252a5848" title="ç—•è¿¹">ç—•è¿¹</a><time datetime="2022-12-28T03:42:45.570Z" title="æ›´æ–°äº 2022-12-28 11:42:45">2022-12-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/f2745b45" title="æˆ‘|â¤ï¸"><img src="https://cdn.jsdelivr.net/gh/fole-del/img/20210403154845.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="æˆ‘|â¤ï¸"/></a><div class="content"><a class="title" href="/posts/f2745b45" title="æˆ‘|â¤ï¸">æˆ‘|â¤ï¸</a><time datetime="2022-12-28T03:40:16.309Z" title="æ›´æ–°äº 2022-12-28 11:40:16">2022-12-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/64d12821" title="C++é¢è¯•åŸºæœ¬çŸ¥è¯†ç‚¹ï¼ˆ1ï¼‰"><img src="https://cdn.jsdelivr.net/gh/fole-del/img@9fb4182529fe80d2c8d24d32344e760191ba3b45/2020/10/24/bc30952f07330a84a0d01ee93938fa2f.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="C++é¢è¯•åŸºæœ¬çŸ¥è¯†ç‚¹ï¼ˆ1ï¼‰"/></a><div class="content"><a class="title" href="/posts/64d12821" title="C++é¢è¯•åŸºæœ¬çŸ¥è¯†ç‚¹ï¼ˆ1ï¼‰">C++é¢è¯•åŸºæœ¬çŸ¥è¯†ç‚¹ï¼ˆ1ï¼‰</a><time datetime="2022-12-27T09:41:45.579Z" title="æ›´æ–°äº 2022-12-27 17:41:45">2022-12-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/364ea8cc" title="è®¾è®¡æ¨¡å¼"><img src="http://tva3.sinaimg.cn/large/0072YHp3ly1gjlroak9grj30yg0kiq4q.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="è®¾è®¡æ¨¡å¼"/></a><div class="content"><a class="title" href="/posts/364ea8cc" title="è®¾è®¡æ¨¡å¼">è®¾è®¡æ¨¡å¼</a><time datetime="2022-12-27T07:05:52.457Z" title="æ›´æ–°äº 2022-12-27 15:05:52">2022-12-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/69f2f423" title="è®¾è®¡æ¨¡å¼ä¹‹è¡Œä¸ºå‹æ¨¡å¼"><img src="https://tvax3.sinaimg.cn/large/0072YHp3ly1gjvw20n7otj31hc0zdgxz.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="è®¾è®¡æ¨¡å¼ä¹‹è¡Œä¸ºå‹æ¨¡å¼"/></a><div class="content"><a class="title" href="/posts/69f2f423" title="è®¾è®¡æ¨¡å¼ä¹‹è¡Œä¸ºå‹æ¨¡å¼">è®¾è®¡æ¨¡å¼ä¹‹è¡Œä¸ºå‹æ¨¡å¼</a><time datetime="2022-12-27T07:04:20.962Z" title="æ›´æ–°äº 2022-12-27 15:04:20">2022-12-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/3dfd8b5b" title="è®¾è®¡æ¨¡å¼ä¹‹åˆ›å»ºå‹æ¨¡å¼"><img src="https://img.shields.io/badge/-åˆ›å»ºå‹æ¨¡å¼-blueciolet" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="è®¾è®¡æ¨¡å¼ä¹‹åˆ›å»ºå‹æ¨¡å¼"/></a><div class="content"><a class="title" href="/posts/3dfd8b5b" title="è®¾è®¡æ¨¡å¼ä¹‹åˆ›å»ºå‹æ¨¡å¼">è®¾è®¡æ¨¡å¼ä¹‹åˆ›å»ºå‹æ¨¡å¼</a><time datetime="2022-12-27T07:02:00.440Z" title="æ›´æ–°äº 2022-12-27 15:02:00">2022-12-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/3a70d3a5" title="Windowså³é”®æ·»åŠ Windows Terminal"><img src="http://tva1.sinaimg.cn/large/0072YHp3ly1gjmabib19zj30g108cq2z.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Windowså³é”®æ·»åŠ Windows Terminal"/></a><div class="content"><a class="title" href="/posts/3a70d3a5" title="Windowså³é”®æ·»åŠ Windows Terminal">Windowså³é”®æ·»åŠ Windows Terminal</a><time datetime="2022-12-27T06:59:33.486Z" title="æ›´æ–°äº 2022-12-27 14:59:33">2022-12-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/db382da4" title="Windowså£çº¸è½¯ä»¶æ¨è"><img src="https://tva4.sinaimg.cn/large/0072YHp3ly1gjvw1yzkafj343c2awnph.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Windowså£çº¸è½¯ä»¶æ¨è"/></a><div class="content"><a class="title" href="/posts/db382da4" title="Windowså£çº¸è½¯ä»¶æ¨è">Windowså£çº¸è½¯ä»¶æ¨è</a><time datetime="2022-12-27T06:58:43.008Z" title="æ›´æ–°äº 2022-12-27 14:58:43">2022-12-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/d8fac1ab" title="Windowsä¸å¸¸ç”¨å¿«æ·é”®åˆé›†"><img src="https://cdn.jsdelivr.net/gh/piccdn/cdn2@3079bcdf52942591ecb0eeb9ead1a406be5fda53/2020/10/11/a151ba57d295ca5d8e57a61645ac0358.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Windowsä¸å¸¸ç”¨å¿«æ·é”®åˆé›†"/></a><div class="content"><a class="title" href="/posts/d8fac1ab" title="Windowsä¸å¸¸ç”¨å¿«æ·é”®åˆé›†">Windowsä¸å¸¸ç”¨å¿«æ·é”®åˆé›†</a><time datetime="2022-12-27T06:57:36.946Z" title="æ›´æ–°äº 2022-12-27 14:57:36">2022-12-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/c8319666" title="hexoç‰¹æ®Šç¬¦å·ä½¿ç”¨"><img src="https://img.shields.io/badge/-Hexo-black" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="hexoç‰¹æ®Šç¬¦å·ä½¿ç”¨"/></a><div class="content"><a class="title" href="/posts/c8319666" title="hexoç‰¹æ®Šç¬¦å·ä½¿ç”¨">hexoç‰¹æ®Šç¬¦å·ä½¿ç”¨</a><time datetime="2022-12-27T06:55:59.181Z" title="æ›´æ–°äº 2022-12-27 14:55:59">2022-12-27</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By mingming.shi</div><div class="footer_custom_text"><div id="mouseMove">&nbsp;</div><i class="fa fa-grav" aria-hidden="true"></i>å‹‡æ•¢å°±æ˜¯æ¥å—å‘ç”Ÿåœ¨ä½ èº«ä¸Šçš„äº‹ï¼Œå¹¶æŠŠå®ƒå°½åŠ›åšåˆ°æœ€å¥½ï¼<br> Power By <a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/" style="animation:bgbreath 4s infinite;">Hexo</a> | ä¸»é¢˜ <a target="_blank" rel="noopener" href="https://butterfly.js.org/" style="animation:bgbreath 4s infinite;">butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="ç®€ç¹è½¬æ¢">ç¹</button><button id="darkmode" type="button" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="èŠå¤©"><i class="fas fa-sms"></i></button><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">æœç´¢</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  æ•°æ®åº“åŠ è½½ä¸­</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« " type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? '' : ''

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script></div><canvas id="universe"></canvas><script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11"></script><script src="https://cdn.jsdelivr.net/gh/TRHX/CDN-for-itrhx.com@3.0.8/js/instantclick-1.2.2.js" type="module"></script><script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.min.js"></script><script src="https://myhkw.cn/player/js/player.js" id="myhk" key="160318399252" m="0"></script><script defer src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/zdoj.js"></script><script src="/js/twoPeople.js"></script><script src="/js/twoPeople1.js"></script><script src="/js/qipao.js"></script><script src="/js/universe.js"></script><script src="/js/mouseMove.js"></script><script defer src="https://use.fontawesome.com/releases/v5.11.2/js/all.js"></script><script defer src="https://use.fontawesome.com/releases/v5.11.2/js/v4-shims.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --><script async src="//at.alicdn.com/t/font_2032782_8d5kxvn09md.js"></script><!-- hexo injector body_end end --></body></html>